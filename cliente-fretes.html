<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meus Fretes - Cliente - Broday Transportes</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
                    <div class="logo">
            <span>Broday Transportes</span>
        </div>
            <nav class="nav">
                <a href="cliente-dashboard.html" class="nav-link">Dashboard</a>
                <a href="cliente-fretes.html" class="nav-link active">Meus Fretes</a>
                <a href="frete.html" class="nav-link">Solicitar Frete</a>
                <a href="cliente-perfil.html" class="nav-link">Perfil</a>
            </nav>
            <div class="header-buttons">
                <button class="theme-toggle" onclick="toggleTheme()" title="Alternar tema">
                    <i class="fas fa-sun"></i>
                </button>
                <span class="user-info" id="user-info">Bem-vindo, <span id="user-name">Cliente</span></span>
                <button class="btn btn-secondary" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Sair
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Meus Fretes Section -->
            <section id="fretes" class="fretes-section active">
                <div class="section-header">
                    <h1>Meus Fretes</h1>
                    <div class="filters">
                        <select id="status-filter" onchange="loadFretes()">
                            <option value="">Todos os Status</option>
                            <option value="solicitado">Solicitado</option>
                            <option value="aceito">Aceito</option>
                            <option value="em_transito">Em Trânsito</option>
                            <option value="entregue">Entregue</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                        <button class="btn btn-primary" onclick="clearFilters()">
                            <i class="fas fa-times"></i>
                            Limpar Filtros
                        </button>
                    </div>
                </div>

                <div class="fretes-list" id="fretes-list">
                    <!-- Fretes serão carregados aqui -->
                </div>
            </section>
        </div>
    </main>

    <!-- Modal de Detalhes do Frete -->
    <div class="modal" id="freteDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Detalhes do Frete</h2>
                <button class="close-btn" onclick="closeFreteDetailsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="freteDetailsContent"></div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Broday Transportes</h3>
                    <p>Conectando embarcadores e transportadores de forma inteligente e eficiente.</p>
                </div>
                
                <div class="footer-section">
                    <h4>Navegação</h4>
                    <div class="footer-nav">
                        <a href="cliente-dashboard.html">Dashboard</a>
                        <a href="cliente-fretes.html">Meus Fretes</a>
                        <a href="frete.html">Solicitar Frete</a>
                        <a href="cliente-perfil.html">Perfil</a>
                        <a href="index.html">Início</a>
                        <a href="#">Política de Privacidade</a>
                        <a href="#">Termos de Uso</a>
                    </div>
                </div>
                
                <div class="footer-section">
                    <h4>Contato</h4>
                    <div class="contact-info">
                        <p><i class="fas fa-map-marker-alt"></i> Rua Cambara, 268 - Nova Russia</p>
                        <p>Ponta Grossa - PR, 84.053-060</p>
                        <p><i class="fas fa-phone"></i> (42) 99985-2606</p>
                        <p><i class="fas fa-envelope"></i> brodaytransportes@gmail.com</p>
                    </div>
                </div>
                
            </div>
            
            <div class="footer-legal">
                <div class="legal-info">
                    <p><strong>CNPJ:</strong> 58.893.054/0001-03</p>
                    <p><strong>Endereço:</strong> Rua Cambara, 268 - Nova Russia, Ponta Grossa - PR, 84.053-060</p>
                </div>
                <div class="copyright">
                    <p>© 2025 Broday Transportes. Todos os direitos reservados.</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="js/api.js"></script>
    <script>
        // Verificar se o usuário está logado
        if (!isLoggedIn()) {
            window.location.href = 'login.html';
        }

        // Verificar tipo de usuário
        if (getUserType() !== 'cliente') {
            window.location.href = 'login.html';
        }

        // Carregar dados do usuário
        document.addEventListener('DOMContentLoaded', function() {
            loadUserData();
            loadFretes();
        });

        function loadUserData() {
            const user = getCurrentUser();
            if (user) {
                document.getElementById('user-name').textContent = user.name || user.email;
            }
        }

        async function loadFretes() {
            try {
                const statusFilter = document.getElementById('status-filter').value;
                console.log('Carregando fretes com filtro:', statusFilter);
                
                const response = await api.getFretesByCliente(1, 50, statusFilter);
                console.log('Resposta da API:', response);
                
                if (response.success) {
                    const fretes = response.data.fretes;
                    const container = document.getElementById('fretes-list');
                    container.innerHTML = '';
                    
                    if (fretes.length === 0) {
                        container.innerHTML = '<p class="no-data">Nenhum frete encontrado</p>';
                        return;
                    }
                    
                    fretes.forEach(frete => {
                        const freteCard = createFreteCard(frete);
                        container.appendChild(freteCard);
                    });
                } else {
                    console.error('Erro na resposta da API:', response.message);
                    showNotification('Erro ao carregar fretes: ' + response.message, 'error');
                }
            } catch (error) {
                console.error('Erro ao carregar fretes:', error);
                showNotification('Erro ao carregar fretes: ' + error.message, 'error');
            }
        }

        function createFreteCard(frete) {
            const card = document.createElement('div');
            card.className = 'frete-card';
            
            // Formatar origem e destino
            const origem = `${frete.origin_city || 'N/A'}/${frete.origin_state || 'N/A'}`;
            const destino = `${frete.destination_city || 'N/A'}/${frete.destination_state || 'N/A'}`;
            
            // Formatar data de coleta
            const dataColeta = frete.data_coleta ? new Date(frete.data_coleta).toLocaleDateString('pt-BR') : 'Não definida';
            
            card.innerHTML = `
                <div class="frete-header">
                    <h3>Frete #${frete.id}</h3>
                    <span class="status status-${frete.status}">${getStatusText(frete.status)}</span>
                </div>
                <div class="frete-info">
                    <p><strong>Origem:</strong> ${origem}</p>
                    <p><strong>Destino:</strong> ${destino}</p>
                    <p><strong>Data:</strong> ${dataColeta}</p>
                </div>
                <div class="frete-actions">
                    <button class="btn btn-sm btn-primary" onclick="viewFrete(${frete.id})">
                        <i class="fas fa-eye"></i>
                        Ver Detalhes
                    </button>
                    ${frete.status === 'aceito' ? `
                    <button class="btn btn-sm btn-danger" onclick="cancelarFrete(${frete.id})">
                        <i class="fas fa-times"></i>
                        Cancelar
                    </button>
                    ` : ''}
                </div>
            `;
            return card;
        }

        function getStatusText(status) {
            const statusMap = {
                'solicitado': 'Solicitado',
                'aceito': 'Aceito',
                'em_transito': 'Em Trânsito',
                'entregue': 'Entregue',
                'cancelado': 'Cancelado'
            };
            return statusMap[status] || status;
        }

        async function viewFrete(freteId) {
            try {
                const response = await api.getFreteById(freteId);
                if (response.success) {
                    displayFreteDetails(response.data);
                } else {
                    showNotification('Erro ao carregar detalhes do frete', 'error');
                }
            } catch (error) {
                console.error('Erro ao carregar detalhes do frete:', error);
                showNotification('Erro ao carregar detalhes do frete', 'error');
            }
        }

        function displayFreteDetails(frete) {
            const content = document.getElementById('freteDetailsContent');
            const origem = `${frete.origin_city || 'N/A'}, ${frete.origin_state || 'N/A'}`;
            const destino = `${frete.destination_city || 'N/A'}, ${frete.destination_state || 'N/A'}`;
            const dataColeta = frete.data_coleta ? new Date(frete.data_coleta).toLocaleDateString('pt-BR') : 'N/A';
            const dataEntrega = frete.data_entrega ? new Date(frete.data_entrega).toLocaleDateString('pt-BR') : 'N/A';
            const valorCarga = frete.cargo_value ? `R$ ${parseFloat(frete.cargo_value).toLocaleString('pt-BR', {minimumFractionDigits: 2})}` : 'A negociar';
            
            content.innerHTML = `
                <div class="frete-details-container">
                    <div class="detail-section">
                        <h3>Informações do Frete</h3>
                        <div class="detail-item">
                            <strong>Código:</strong>
                            <span>${frete.codigo || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Status:</strong>
                            <span class="status-badge status-${frete.status}">${getStatusText(frete.status)}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Motorista:</strong>
                            <span>${frete.motorista ? (frete.motorista.name || frete.motorista.email) : 'Não atribuído'}</span>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>Rota</h3>
                        <div class="route-info">
                            <div class="route-point">
                                <div class="route-icon">
                                    <i class="fas fa-map-marker-alt"></i>
                                </div>
                                <div class="route-details">
                                    <strong>Origem</strong>
                                    <p>${origem}</p>
                                    <p>${frete.origin_street || 'N/A'}, ${frete.origin_number || 'N/A'}</p>
                                    <p>CEP: ${frete.origin_cep || 'N/A'}</p>
                                </div>
                            </div>
                            <div class="route-arrow">
                                <i class="fas fa-arrow-down"></i>
                            </div>
                            <div class="route-point">
                                <div class="route-icon">
                                    <i class="fas fa-flag-checkered"></i>
                                </div>
                                <div class="route-details">
                                    <strong>Destino</strong>
                                    <p>${destino}</p>
                                    <p>${frete.destination_street || 'N/A'}, ${frete.destination_number || 'N/A'}</p>
                                    <p>CEP: ${frete.destination_cep || 'N/A'}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>Detalhes da Carga</h3>
                        <div class="detail-item">
                            <strong>Tipo:</strong>
                            <span>${frete.cargo_type || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Peso:</strong>
                            <span>${frete.cargo_weight || 'N/A'} kg</span>
                        </div>
                        <div class="detail-item">
                            <strong>Dimensões:</strong>
                            <span>${frete.cargo_dimensions || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Valor:</strong>
                            <span>${valorCarga}</span>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>Datas</h3>
                        <div class="detail-item">
                            <strong>Data de Coleta:</strong>
                            <span>${dataColeta}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Data de Entrega:</strong>
                            <span>${dataEntrega}</span>
                        </div>
                    </div>

                    ${frete.observacoes ? `
                    <div class="detail-section">
                        <h3>Observações</h3>
                        <div class="detail-item" style="justify-content: flex-start;">
                            <span style="text-align: left;">${frete.observacoes}</span>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('freteDetailsModal').style.display = 'flex';
        }

        function closeFreteDetailsModal() {
            document.getElementById('freteDetailsModal').style.display = 'none';
        }

        function clearFilters() {
            document.getElementById('status-filter').value = '';
            loadFretes();
        }

        async function cancelarFrete(freteId) {
            if (confirm('Tem certeza que deseja cancelar este frete? Esta ação não pode ser desfeita.')) {
                try {
                    const response = await api.cancelarFrete(freteId);
                    if (response.success) {
                        showNotification('Frete cancelado com sucesso!', 'success');
                        // Recarregar dados
                        loadFretes();
                    } else {
                        showNotification('Erro ao cancelar frete: ' + response.message, 'error');
                    }
                } catch (error) {
                    console.error('Erro ao cancelar frete:', error);
                    showNotification('Erro ao cancelar frete', 'error');
                }
            }
        }

        // Função para mostrar notificações
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerText = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // Função para alternar tema
        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const isLightMode = document.body.classList.contains('light-mode');
            localStorage.setItem('theme', isLightMode ? 'light' : 'dark');
            
            // Trocar ícone do toggle
            const toggleIcon = document.querySelector('.theme-toggle i');
            if (toggleIcon) {
                if (isLightMode) {
                    toggleIcon.className = 'fas fa-moon';
                    toggleIcon.parentElement.title = 'Alternar para modo escuro';
                } else {
                    toggleIcon.className = 'fas fa-sun';
                    toggleIcon.parentElement.title = 'Alternar para modo claro';
                }
            }
        }
        
        // Carregar tema salvo
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme');
            const toggleIcon = document.querySelector('.theme-toggle i');
            
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
                if (toggleIcon) {
                    toggleIcon.className = 'fas fa-moon';
                    toggleIcon.parentElement.title = 'Alternar para modo escuro';
                }
            } else {
                if (toggleIcon) {
                    toggleIcon.className = 'fas fa-sun';
                    toggleIcon.parentElement.title = 'Alternar para modo claro';
                }
            }
        });
    </script>

    <style>
        /* Estilos para o modal de detalhes do frete */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #1a202c;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            border-bottom: 1px solid #4a5568;
            background: #2d3748;
            border-radius: 8px 8px 0 0;
        }

        .modal-header h2 {
            margin: 0;
            color: #ffffff;
            font-size: 1.5rem;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #a0aec0;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            color: #ffffff;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .modal-body {
            padding: 0;
        }

        .frete-details-container {
            padding: 0;
        }

        .detail-section {
            padding: 25px 30px;
            border-bottom: 1px solid #4a5568;
        }

        .detail-section:last-child {
            border-bottom: none;
        }

        .detail-section h3 {
            margin: 0 0 20px 0;
            color: #e2e8f0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            margin-bottom: 8px;
            background: #2d3748;
            border-radius: 6px;
        }

        .detail-item strong {
            color: #a0aec0;
            font-weight: 500;
        }

        .detail-item span {
            color: #e2e8f0;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            font-size: 0.8rem;
            font-weight: 700;
            white-space: nowrap;
            border-radius: 6px;
            max-width: fit-content;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .status-badge.solicitado {
            background-color: #f6ad55 !important;
            color: #000000 !important;
        }

        .status-badge.aceito {
            background-color: #68d391 !important;
            color: #000000 !important;
        }

        .status-badge.em_transito {
            background-color: #3182ce !important;
            color: #000000 !important;
        }

        .status-badge.entregue {
            background-color: #38a169 !important;
            color: #000000 !important;
        }

        .status-badge.cancelado {
            background-color: #e53e3e !important;
            color: #000000 !important;
        }

        /* Status badges - Forçar texto preto em todos os modos */
        .status-badge.solicitado,
        body:not(.light-mode) .status-badge.solicitado,
        body.light-mode .status-badge.solicitado,
        .frete-details .status-badge.solicitado,
        .modal .status-badge.solicitado {
            background-color: #f6ad55 !important;
            color: #000000 !important;
        }

        .status-badge.aceito,
        body:not(.light-mode) .status-badge.aceito,
        body.light-mode .status-badge.aceito,
        .frete-details .status-badge.aceito,
        .modal .status-badge.aceito {
            background-color: #68d391 !important;
            color: #000000 !important;
        }

        .status-badge.em_transito,
        body:not(.light-mode) .status-badge.em_transito,
        body.light-mode .status-badge.em_transito,
        .frete-details .status-badge.em_transito,
        .modal .status-badge.em_transito {
            background-color: #3182ce !important;
            color: #000000 !important;
        }

        .status-badge.entregue,
        body:not(.light-mode) .status-badge.entregue,
        body.light-mode .status-badge.entregue,
        .frete-details .status-badge.entregue,
        .modal .status-badge.entregue {
            background-color: #38a169 !important;
            color: #000000 !important;
        }

        .status-badge.cancelado,
        body:not(.light-mode) .status-badge.cancelado,
        body.light-mode .status-badge.cancelado,
        .frete-details .status-badge.cancelado,
        .modal .status-badge.cancelado {
            background-color: #e53e3e !important;
            color: #000000 !important;
        }

        /* Status badges nos modais - texto preto */
        .modal .status-badge,
        .modal-content .status-badge,
        .modal-body .status-badge,
        .modal .status-badge.solicitado,
        .modal .status-badge.aceito,
        .modal .status-badge.em_transito,
        .modal .status-badge.entregue,
        .modal .status-badge.cancelado,
        .modal-content .status-badge.solicitado,
        .modal-content .status-badge.aceito,
        .modal-content .status-badge.em_transito,
        .modal-content .status-badge.entregue,
        .modal-content .status-badge.cancelado,
        .modal-body .status-badge.solicitado,
        .modal-body .status-badge.aceito,
        .modal-body .status-badge.em_transito,
        .modal-body .status-badge.entregue,
        .modal-body .status-badge.cancelado {
            color: #000000 !important;
        }

        .route-info {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Garantir que o botão cancelar seja vermelho */
        .btn-danger {
            background-color: #dc3545 !important;
            border-color: #dc3545 !important;
            color: white !important;
        }

        .btn-danger:hover {
            background-color: #c82333 !important;
            border-color: #bd2130 !important;
        }

        .route-point {
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }

        .route-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #4a5568;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #e2e8f0;
            font-size: 16px;
            flex-shrink: 0;
        }

        .route-details {
            flex: 1;
        }

        .route-details strong {
            display: block;
            color: #e2e8f0;
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .route-details p {
            margin: 2px 0;
            color: #a0aec0;
            font-size: 0.9rem;
        }

        .route-arrow {
            display: flex;
            justify-content: center;
            color: #4a5568;
            font-size: 20px;
            margin: 10px 0;
        }

        /* Modo claro */
        body.light-mode .modal-content {
            background: #ffffff;
        }

        body.light-mode .modal-header {
            background: #f7fafc;
            border-bottom-color: #e2e8f0;
        }

        body.light-mode .modal-header h2 {
            color: #2d3748;
        }

        body.light-mode .close-btn {
            color: #4a5568;
        }

        body.light-mode .close-btn:hover {
            color: #2d3748;
            background-color: rgba(45, 55, 72, 0.1);
        }

        body.light-mode .detail-section {
            border-bottom-color: #e2e8f0;
        }

        body.light-mode .detail-section h3 {
            color: #2d3748;
        }

        body.light-mode .detail-item {
            background: #f7fafc;
        }

        body.light-mode .detail-item strong {
            color: #4a5568;
        }

        body.light-mode .detail-item span {
            color: #2d3748;
        }

        body.light-mode .route-icon {
            background: #e2e8f0;
            color: #4a5568;
        }

        body.light-mode .route-details strong {
            color: #2d3748;
        }

        body.light-mode .route-details p {
            color: #4a5568;
        }

        body.light-mode .route-arrow {
            color: #e2e8f0;
        }
    </style>
    </script>
</body>
</html>
