<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Motorista - Broday Transportes</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="logo">
                <span>Broday Transportes</span>
            </div>
            <nav class="nav">
                <a href="motorista-dashboard.html" class="nav-link active">Dashboard</a>
                <a href="motorista-fretes-disponiveis.html" class="nav-link">Fretes Dispon√≠veis</a>
                <a href="motorista-meus-fretes.html" class="nav-link">Meus Fretes</a>
                <a href="motorista-caminhoes.html" class="nav-link">Meus Caminh√µes</a>
                <a href="motorista-perfil.html" class="nav-link">Perfil</a>
            </nav>
            <div class="header-buttons">
                <button class="theme-toggle" onclick="toggleTheme()" title="Alternar tema">
                    <i class="fas fa-sun"></i>
                </button>
                <span class="user-info" id="user-info">Bem-vindo, <span id="user-name">Motorista</span></span>
                <button class="btn btn-secondary" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Sair
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Dashboard Section -->
            <section id="dashboard" class="dashboard-section active">
                <div class="dashboard-header">
                    <h1>Dashboard do Motorista</h1>
                    <p>Gerencie seus fretes e acompanhe sua performance</p>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-truck"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="fretes-ativos">0</h3>
                            <p>Fretes Ativos</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="fretes-concluidos">0</h3>
                            <p>Fretes Conclu√≠dos</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="status-disponibilidade">Dispon√≠vel</h3>
                            <p>Status</p>
                        </div>
                    </div>
                </div>

                <!-- Fretes Ativos -->
                <div class="recent-section">
                    <h2>Fretes Ativos</h2>
                    <div class="fretes-list" id="fretes-ativos-list">
                        <!-- Fretes ativos ser√£o carregados aqui -->
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Broday Transportes</h3>
                    <p>Conectando embarcadores e transportadores de forma inteligente e eficiente.</p>
                </div>
                
                <div class="footer-section">
                    <h4>Navega√ß√£o</h4>
                    <div class="footer-nav">
                        <a href="motorista-dashboard.html">Dashboard</a>
                        <a href="motorista-fretes-disponiveis.html">Fretes Dispon√≠veis</a>
                        <a href="motorista-meus-fretes.html">Meus Fretes</a>
                        <a href="motorista-perfil.html">Perfil</a>
                    </div>
                </div>
                
                <div class="footer-section">
                    <h4>Contato</h4>
                    <div class="contact-info">
                        <p><i class="fas fa-map-marker-alt"></i> Rua Cambara, 268 - Nova Russia</p>
                        <p>Ponta Grossa - PR, 84.053-060</p>
                        <p><i class="fas fa-phone"></i> (42) 99985-2606</p>
                        <p><i class="fas fa-envelope"></i> brodaytransportes@gmail.com</p>
                    </div>
                </div>
                
            </div>
            
            <div class="footer-legal">
                <div class="legal-info">
                    <p><strong>CNPJ:</strong> 58.893.054/0001-03</p>
                    <p><strong>Endere√ßo:</strong> Rua Cambara, 268 - Nova Russia, Ponta Grossa - PR, 84.053-060</p>
                </div>
                <div class="copyright">
                    <p>¬© 2025 Broday Transportes. Todos os direitos reservados.</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="js/api.js"></script>
    <script>
        // Verificar se o usu√°rio est√° logado
        if (!isLoggedIn()) {
            window.location.href = 'login.html';
        }

        // Verificar tipo de usu√°rio
        if (getUserType() !== 'motorista') {
            window.location.href = 'login.html';
        }

        // Carregar dados do usu√°rio
        document.addEventListener('DOMContentLoaded', function() {
            loadUserData();
            loadDashboardData();
        });

        function loadUserData() {
            console.log('Carregando dados do usu√°rio...');
            const user = getCurrentUser();
            console.log('Usu√°rio obtido:', user);
            if (user) {
                const displayName = user.nome || user.email;
                console.log('Nome a ser exibido:', displayName);
                document.getElementById('user-name').textContent = displayName;
            } else {
                console.log('Nenhum usu√°rio encontrado');
            }
        }

        async function loadDashboardData() {
            try {
                const response = await api.getDashboard();
                
                if (response.success) {
                    const data = response.data.dashboard;
                    
                    // Atualizar estat√≠sticas
                    document.getElementById('fretes-ativos').textContent = data.fretesAtivos || 0;
                    document.getElementById('fretes-concluidos').textContent = data.fretesConcluidos || 0;
                    
                    // Carregar fretes ativos usando os dados do dashboard
                    loadFretesAtivosFromDashboard(data.fretesAtivosList);
                }
            } catch (error) {
                console.error('Erro ao carregar dashboard:', error);
                // Fallback para carregar dados individualmente
            loadStats();
            loadFretesAtivos();
            }
        }

        async function loadStats() {
            try {
                const response = await api.getFretesByMotorista(1, 100);
                if (response.success) {
                    const fretes = response.data.fretes;
                    const ativos = fretes.filter(f => f.status === 'aceito' || f.status === 'em_transito').length;
                    const concluidos = fretes.filter(f => f.status === 'entregue').length;
                    
                    document.getElementById('fretes-ativos').textContent = ativos;
                    document.getElementById('fretes-concluidos').textContent = concluidos;
                    
                    // Atualizar status de disponibilidade
                    updateDisponibilidadeStatus(fretes);
                }
            } catch (error) {
                console.error('Erro ao carregar estat√≠sticas:', error);
            }
        }

        function updateDisponibilidadeStatus(fretes) {
            const statusElement = document.getElementById('status-disponibilidade');
            const isEmViagem = fretes.some(f => f.status === 'em_transito');
            
            console.log('Atualizando status de disponibilidade:', {
                fretes: fretes.length,
                isEmViagem: isEmViagem,
                fretesEmTransito: fretes.filter(f => f.status === 'em_transito')
            });
            
            if (isEmViagem) {
                statusElement.textContent = 'Indispon√≠vel';
                statusElement.style.color = '#e53e3e';
            } else {
                statusElement.textContent = 'Dispon√≠vel';
                statusElement.style.color = '#48bb78';
            }
        }

        async function checkMotoristaEmViagem() {
            try {
                // Buscar todos os fretes do motorista para verificar se h√° algum em tr√¢nsito
                const response = await api.getFretesByMotorista(1, 100);
                if (response.success) {
                    const fretes = response.data.fretes;
                    return fretes.some(f => f.status === 'em_transito');
                }
                return false;
            } catch (error) {
                console.error('Erro ao verificar status do motorista:', error);
                return false;
            }
        }

        async function loadFretesAtivosFromDashboard(fretes) {
            const container = document.getElementById('fretes-ativos-list');
            container.innerHTML = '';
            
            if (!fretes || fretes.length === 0) {
                container.innerHTML = '<p class="no-data">Nenhum frete ativo</p>';
                // Atualizar status de disponibilidade mesmo quando n√£o h√° fretes
                updateDisponibilidadeStatus(fretes);
                return;
            }
            
            for (const frete of fretes) {
                const freteCard = await createFreteCard(frete);
                container.appendChild(freteCard);
            }
            
            // Atualizar status de disponibilidade ap√≥s carregar fretes
            updateDisponibilidadeStatus(fretes);
        }

        async function loadFretesAtivos() {
            try {
                const response = await api.getFretesByMotorista(1, 10, 'aceito,em_transito');
                
                if (response.success) {
                    const fretes = response.data.fretes;
                    const container = document.getElementById('fretes-ativos-list');
                    container.innerHTML = '';
                    
                    if (fretes.length === 0) {
                        container.innerHTML = '<p class="no-data">Nenhum frete ativo</p>';
                        // Atualizar status de disponibilidade mesmo quando n√£o h√° fretes
                        updateDisponibilidadeStatus(fretes);
                        return;
                    }
                    
                    for (const frete of fretes) {
                        const freteCard = await createFreteCard(frete);
                        container.appendChild(freteCard);
                    }
                    
                    // Atualizar status de disponibilidade ap√≥s carregar fretes
                    updateDisponibilidadeStatus(fretes);
                }
            } catch (error) {
                console.error('Erro ao carregar fretes ativos:', error);
            }
        }

        async function createFreteCard(frete) {
            const card = document.createElement('div');
            card.className = 'frete-card';
            
            // Verificar se motorista j√° est√° em viagem
            const isMotoristaEmViagem = await checkMotoristaEmViagem();
            
            card.innerHTML = `
                <div class="frete-header">
                    <h3>Frete #${frete.id}</h3>
                    <span class="status status-${frete.status}">${getStatusText(frete.status)}</span>
                </div>
                <div class="frete-info">
                    <p><strong>Origem:</strong> ${frete.origin_city || 'N/A'}</p>
                    <p><strong>Destino:</strong> ${frete.destination_city || 'N/A'}</p>
                    <p><strong>Data:</strong> ${frete.data_coleta ? new Date(frete.data_coleta).toLocaleDateString('pt-BR') : 'N/A'}</p>
                    <p><strong>Tipo:</strong> ${frete.cargo_type || 'N/A'}</p>
                </div>
                <div class="frete-actions">
                    <button class="btn btn-sm btn-primary" onclick="viewFrete(${frete.id})">
                        <i class="fas fa-eye"></i>
                        Ver Detalhes
                    </button>
                    ${(frete.status === 'em_transito' || frete.status === 'entregue') ? `
                    <button class="btn btn-sm btn-success" onclick="rastrearFrete(${frete.id})">
                        <i class="fas fa-map-marker-alt"></i>
                        Rastrear
                    </button>
                    ` : ''}
                    ${frete.status === 'aceito' ? `
                        <button class="btn btn-sm ${isMotoristaEmViagem ? 'btn-disabled' : 'btn-success'}" 
                                onclick="${isMotoristaEmViagem ? 'showNotification("Voc√™ j√° est√° em viagem!", "error")' : `updateFreteStatus(${frete.id}, 'em_transito')`}"
                                ${isMotoristaEmViagem ? 'disabled' : ''}>
                            <i class="fas fa-truck"></i>
                            ${isMotoristaEmViagem ? 'Indispon√≠vel' : 'Iniciar Viagem'}
                        </button>
                    ` : ''}
                    ${frete.status === 'em_transito' ? `
                        <button class="btn btn-sm btn-success" onclick="updateFreteStatus(${frete.id}, 'entregue')">
                            <i class="fas fa-check"></i>
                            Marcar como Entregue
                        </button>
                    ` : ''}
                </div>
            `;
            return card;
        }

        function getStatusText(status) {
            const statusMap = {
                'solicitado': 'Solicitado',
                'aceito': 'Aceito',
                'em_transito': 'Em Tr√¢nsito',
                'entregue': 'Entregue',
                'cancelado': 'Cancelado'
            };
            return statusMap[status] || status;
        }

        async function viewFrete(freteId) {
            try {
                const response = await api.getFreteById(freteId);
                if (response.success) {
                    const frete = response.data;
                    displayFreteDetails(frete);
                    openModal('freteDetailsModal');
                } else {
                    showNotification('Erro ao carregar detalhes do frete', 'error');
                }
            } catch (error) {
                console.error('Erro ao carregar detalhes:', error);
                showNotification('Erro ao carregar detalhes do frete', 'error');
            }
        }

        function displayFreteDetails(frete) {
            const content = document.getElementById('freteDetailsContent');
            const origem = `${frete.origin_city || 'N/A'}, ${frete.origin_state || 'N/A'}`;
            const destino = `${frete.destination_city || 'N/A'}, ${frete.destination_state || 'N/A'}`;
            const dataColeta = frete.data_coleta ? new Date(frete.data_coleta).toLocaleDateString('pt-BR') : 'N/A';
            const dataEntrega = frete.data_entrega ? new Date(frete.data_entrega).toLocaleDateString('pt-BR') : 'N/A';
            const valorCarga = frete.cargo_value ? `R$ ${parseFloat(frete.cargo_value).toLocaleString('pt-BR', {minimumFractionDigits: 2})}` : 'A negociar';
            
            content.innerHTML = `
                <div class="frete-details-container">
                    <div class="detail-section">
                        <h3>Informa√ß√µes do Frete</h3>
                        <div class="detail-item">
                            <strong>C√≥digo:</strong>
                            <span>${frete.codigo || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Status:</strong>
                            <span class="status-badge status-${frete.status}">${getStatusText(frete.status)}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Cliente:</strong>
                            <span>${frete.cliente ? (frete.cliente.name || frete.cliente.email) : 'N/A'}</span>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>Rota</h3>
                        <div class="route-info">
                            <div class="route-point">
                                <i class="fas fa-map-marker-alt route-icon origin"></i>
                                <div class="route-details">
                                    <strong>Origem:</strong> ${origem}
                                    <small>${frete.origin_street || 'N/A'}, ${frete.origin_number || 'N/A'}</small>
                                </div>
                            </div>
                            <div class="route-arrow">
                                <i class="fas fa-arrow-right"></i>
                            </div>
                            <div class="route-point">
                                <i class="fas fa-map-marker-alt route-icon destination"></i>
                                <div class="route-details">
                                    <strong>Destino:</strong> ${destino}
                                    <small>${frete.destination_street || 'N/A'}, ${frete.destination_number || 'N/A'}</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>Carga</h3>
                        <div class="detail-item">
                            <strong>Tipo:</strong>
                            <span>${frete.cargo_type || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Peso:</strong>
                            <span>${frete.cargo_weight ? parseFloat(frete.cargo_weight).toLocaleString('pt-BR') + ' kg' : 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Valor:</strong>
                            <span>${valorCarga}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Dimens√µes:</strong>
                            <span>${frete.cargo_dimensions || 'N/A'}</span>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>Contatos</h3>
                        <div class="detail-item">
                            <strong>Remetente:</strong>
                            <span>${frete.sender_name || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Telefone Remetente:</strong>
                            <span>${frete.sender_phone || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Destinat√°rio:</strong>
                            <span>${frete.recipient_name || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Telefone Destinat√°rio:</strong>
                            <span>${frete.recipient_phone || 'N/A'}</span>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>Datas</h3>
                        <div class="detail-item">
                            <strong>Data de Coleta:</strong>
                            <span>${dataColeta}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Data de Entrega:</strong>
                            <span>${dataEntrega}</span>
                        </div>
                    </div>

                    ${frete.observacoes ? `
                    <div class="detail-section">
                        <h3>Observa√ß√µes</h3>
                        <div class="detail-item" style="justify-content: flex-start;">
                            <span style="text-align: left;">${frete.observacoes}</span>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        async function updateFreteStatus(freteId, status) {
            try {
                // Se o status for 'em_transito', solicitar permiss√£o ANTES de atualizar
                if (status === 'em_transito') {
                    console.log('Iniciando processo de solicita√ß√£o de permiss√£o GPS...');
                    const permissaoConcedida = await solicitarPermissaoLocalizacao();
                    
                    if (!permissaoConcedida) {
                        console.log('Permiss√£o negada, frete n√£o pode ser iniciado');
                        showNotification('Permiss√£o de localiza√ß√£o √© obrigat√≥ria para iniciar o rastreamento. O frete n√£o foi iniciado.', 'error');
                        return; // N√£o atualiza o status se n√£o tiver permiss√£o
                    }
                    
                    console.log('Permiss√£o concedida, atualizando status do frete...');
                }
                
                const response = await api.updateFreteStatus(freteId, status);
                if (response.success) {
                    showNotification('Status atualizado com sucesso!', 'success');
                    
                    // Recarregar dados do dashboard
                    await loadDashboardData();
                    
                    // Atualizar status de disponibilidade especificamente
                    const statsResponse = await api.getFretesByMotorista(1, 100);
                    if (statsResponse.success) {
                        updateDisponibilidadeStatus(statsResponse.data.fretes);
                    }
                    
                    // Se iniciou viagem, iniciar rastreamento
                    if (status === 'em_transito') {
                        showNotification('Voc√™ est√° agora indispon√≠vel para novos fretes!', 'info');
                        
                        // Iniciar rastreamento autom√°tico
                        setTimeout(async () => {
                            console.log('Iniciando rastreamento...');
                            iniciarRastreamento(freteId);
                            showNotification('Rastreamento iniciado! Voc√™ ser√° redirecionado para a p√°gina de rastreamento.', 'success');
                            
                            // Redirecionar para p√°gina de rastreamento ap√≥s 2 segundos
                            setTimeout(() => {
                                window.location.href = `rastreamento.html?frete=${freteId}`;
                            }, 2000);
                        }, 500);
                    }
                }
            } catch (error) {
                showNotification(error.message || 'Erro ao atualizar status', 'error');
            }
        }

        function rastrearFrete(freteId) {
            // Redirecionar para p√°gina de rastreamento
            window.location.href = `rastreamento.html?frete=${freteId}`;
        }

        // Fun√ß√µes de modal
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        // Fechar modal ao clicar fora dele
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
            });
        }

        // Fun√ß√£o para mostrar notifica√ß√µes
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerText = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // Fun√ß√£o para alternar tema
        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const isLightMode = document.body.classList.contains('light-mode');
            localStorage.setItem('theme', isLightMode ? 'light' : 'dark');
            
            // Trocar √≠cone do toggle
            const toggleIcon = document.querySelector('.theme-toggle i');
            if (toggleIcon) {
                if (isLightMode) {
                    toggleIcon.className = 'fas fa-moon';
                    toggleIcon.parentElement.title = 'Alternar para modo escuro';
                } else {
                    toggleIcon.className = 'fas fa-sun';
                    toggleIcon.parentElement.title = 'Alternar para modo claro';
                }
            }
        }
        
        // Carregar tema salvo
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme');
            const toggleIcon = document.querySelector('.theme-toggle i');
            
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
                if (toggleIcon) {
                    toggleIcon.className = 'fas fa-moon';
                    toggleIcon.parentElement.title = 'Alternar para modo escuro';
                }
            } else {
                if (toggleIcon) {
                    toggleIcon.className = 'fas fa-sun';
                    toggleIcon.parentElement.title = 'Alternar para modo claro';
                }
            }
        });
    </script>

    <!-- Modal para Detalhes do Frete -->
    <div id="freteDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Detalhes do Frete</h2>
                <span class="close" onclick="closeModal('freteDetailsModal')">&times;</span>
            </div>
            <div class="modal-body" id="freteDetailsContent">
                <!-- Conte√∫do ser√° preenchido dinamicamente -->
            </div>
        </div>
    </div>

    <style>

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: #1a202c;
            border: 2px solid #4a5568;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 12px;
            padding: 0;
            margin: 5% auto;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: #2d3748;
            border-bottom: 2px solid #4a5568;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            color: #ffffff;
            font-weight: 600;
            margin: 0;
            font-size: 1.5rem;
        }

        .close {
            color: #a0aec0;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #ffffff;
        }

        .modal-body {
            padding: 30px;
            color: #e2e8f0;
        }

        .frete-details-container {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .detail-section {
            background: #2d3748;
            padding: 25px 30px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            margin-bottom: 20px;
        }

        .detail-section h3 {
            margin: 0 0 15px 0;
            color: #667eea;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid #4a5568;
            margin: 0 10px;
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-item strong {
            color: #a0aec0;
            font-weight: 500;
            min-width: 120px;
        }

        .detail-item span {
            color: #e2e8f0;
            text-align: right;
            flex: 1;
        }

        .status-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            white-space: nowrap;
            max-width: fit-content;
        }

        .status-solicitado { background: #f6ad55; color: #744210; }
        .status-cotado { background: #4299e1; color: #1a365d; }
        .status-aceito { background: #48bb78; color: #1a202c; }
        .status-em_transito { background: #ed8936; color: #1a202c; }
        .status-entregue { background: #38a169; color: #1a202c; }
        .status-cancelado { background: #e53e3e; color: #1a202c; }

        .btn-disabled {
            background-color: #718096 !important;
            color: #a0aec0 !important;
            cursor: not-allowed !important;
            opacity: 0.6 !important;
        }

        .btn-disabled:hover {
            background-color: #718096 !important;
            transform: none !important;
        }

        .route-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }

        .route-point {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .route-icon {
            font-size: 1.2rem;
            width: 20px;
            text-align: center;
        }

        .route-icon.origin { color: #48bb78; }
        .route-icon.destination { color: #e53e3e; }

        .route-details {
            display: flex;
            flex-direction: column;
        }

        .route-details strong {
            color: #e2e8f0;
            font-size: 0.9rem;
        }

        .route-details small {
            color: #a0aec0;
            font-size: 0.8rem;
        }

        .route-arrow {
            color: #667eea;
            font-size: 1.2rem;
        }

        /* Scroll personalizado */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #667eea;
        }

        /* Modo claro */
        body.light-mode .modal-content {
            background-color: #ffffff;
        }

        body.light-mode .modal-body {
            color: #2d3748;
        }

        body.light-mode .detail-section {
            background: #f7fafc;
            border-left-color: #667eea;
        }

        body.light-mode .detail-section h3 {
            color: #667eea;
        }

        body.light-mode .detail-item {
            border-bottom-color: #e2e8f0;
        }

        body.light-mode .detail-item strong {
            color: #4a5568;
        }

        body.light-mode .detail-item span {
            color: #2d3748;
        }

        body.light-mode .route-details strong {
            color: #2d3748;
        }

        body.light-mode .route-details small {
            color: #4a5568;
        }

        /* Modal header no modo claro */
        body.light-mode .modal-header h2 {
            color: #ffffff;
        }

        body.light-mode .modal-content::-webkit-scrollbar-track {
            background: #f7fafc;
        }

        body.light-mode .modal-content::-webkit-scrollbar-thumb {
            background: #e2e8f0;
        }

        body.light-mode .modal-content::-webkit-scrollbar-thumb:hover {
            background: #cbd5e0;
        }
    </style>

    <script>
        // ===== FUN√á√ïES DE RASTREAMENTO =====

        // Verificar se GPS est√° dispon√≠vel
        function verificarDisponibilidadeGPS() {
            if (!navigator.geolocation) {
                return { disponivel: false, motivo: 'Geolocaliza√ß√£o n√£o suportada pelo navegador' };
            }
            
            // Verificar se estamos em HTTPS (necess√°rio para geolocaliza√ß√£o em produ√ß√£o)
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                return { disponivel: false, motivo: 'HTTPS necess√°rio para geolocaliza√ß√£o' };
            }
            
            return { disponivel: true, motivo: null };
        }

        // Mostrar modal de solicita√ß√£o de permiss√£o GPS
        function mostrarModalPermissaoGPS() {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;
                
                modal.innerHTML = `
                    <div style="
                        background: #2D3748;
                        padding: 2rem;
                        border-radius: 12px;
                        max-width: 500px;
                        margin: 1rem;
                        color: white;
                        text-align: center;
                    ">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üìç</div>
                        <h3 style="color: #4299E1; margin-bottom: 1rem;">Permiss√£o de Localiza√ß√£o Obrigat√≥ria</h3>
                        <p style="margin-bottom: 1rem; line-height: 1.5;">
                            Para iniciar o rastreamento do frete, √© necess√°rio permitir o acesso √† sua localiza√ß√£o.
                        </p>
                        <div style="background: #4A5568; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; text-align: left;">
                            <strong style="color: #4299E1;">üìã Instru√ß√µes:</strong>
                            <ol style="margin: 0.5rem 0 0 1.5rem; color: #E2E8F0;">
                                <li>Clique em "Permitir Localiza√ß√£o" abaixo</li>
                                <li>Quando o navegador perguntar, clique em "Permitir" ou "Allow"</li>
                                <li>Aguarde a confirma√ß√£o autom√°tica</li>
                            </ol>
                        </div>
                        <div style="display: flex; gap: 1rem; justify-content: center;">
                            <button id="btn-permitir-gps" style="
                                background: #4299E1;
                                color: white;
                                border: none;
                                padding: 0.75rem 1.5rem;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: bold;
                            ">Permitir Localiza√ß√£o</button>
                            <button id="btn-cancelar-gps" style="
                                background: #E53E3E;
                                color: white;
                                border: none;
                                padding: 0.75rem 1.5rem;
                                border-radius: 6px;
                                cursor: pointer;
                            ">Cancelar</button>
                        </div>
                    </div>
                `;
                
                modal.className = 'modal-permissao-gps';
                document.body.appendChild(modal);
                
                // Event listeners
                document.getElementById('btn-permitir-gps').addEventListener('click', () => {
                    console.log('Usu√°rio clicou em "Permitir Localiza√ß√£o"');
                    modal.remove();
                    
                    // For√ßar solicita√ß√£o de permiss√£o imediatamente
                    if (navigator.geolocation) {
                        console.log('For√ßando solicita√ß√£o de permiss√£o...');
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                console.log('‚úÖ Permiss√£o concedida imediatamente:', position);
                            },
                            (error) => {
                                console.log('‚ùå Permiss√£o negada imediatamente:', error);
                            },
                            {
                                enableHighAccuracy: false,
                                timeout: 10000,
                                maximumAge: 0
                            }
                        );
                    }
                    
                    resolve(true);
                });
                
                document.getElementById('btn-cancelar-gps').addEventListener('click', () => {
                    modal.remove();
                    resolve(false);
                });
                
                // Fechar modal ao clicar fora
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                        resolve(false);
                    }
                });
            });
        }

        // Mostrar instru√ß√µes para ativar GPS
        function mostrarInstrucoesGPS() {
            const instrucoes = `
                <div style="text-align: left; margin: 1rem 0;">
                    <h4 style="color: #4299E1; margin-bottom: 1rem;">Como ativar o GPS:</h4>
                    <ol style="margin: 0; padding-left: 1.5rem;">
                        <li style="margin-bottom: 0.5rem;">Verifique se o GPS est√° ativado nas configura√ß√µes do seu dispositivo</li>
                        <li style="margin-bottom: 0.5rem;">Certifique-se de que o navegador tem permiss√£o para acessar a localiza√ß√£o</li>
                        <li style="margin-bottom: 0.5rem;">Tente novamente em alguns segundos</li>
                        <li style="margin-bottom: 0.5rem;">Se o problema persistir, reinicie o navegador</li>
                    </ol>
                </div>
            `;
            
            // Mostrar modal com instru√ß√µes
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: #2D3748;
                    padding: 2rem;
                    border-radius: 12px;
                    max-width: 500px;
                    margin: 1rem;
                    color: white;
                ">
                    ${instrucoes}
                    <button onclick="this.closest('.modal-gps').remove()" style="
                        background: #4299E1;
                        color: white;
                        border: none;
                        padding: 0.75rem 1.5rem;
                        border-radius: 6px;
                        cursor: pointer;
                        margin-top: 1rem;
                        width: 100%;
                    ">Entendi</button>
                </div>
            `;
            
            modal.className = 'modal-gps';
            document.body.appendChild(modal);
            
            // Fechar modal ao clicar fora
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Mostrar instru√ß√µes para permitir permiss√£o
        function mostrarInstrucoesPermissao() {
            const instrucoes = `
                <div style="text-align: left; margin: 1rem 0;">
                    <h4 style="color: #4299E1; margin-bottom: 1rem;">Como permitir localiza√ß√£o:</h4>
                    <ol style="margin: 0; padding-left: 1.5rem;">
                        <li style="margin-bottom: 0.5rem;">Clique no √≠cone de localiza√ß√£o na barra de endere√ßos do navegador</li>
                        <li style="margin-bottom: 0.5rem;">Selecione "Permitir" ou "Allow" quando solicitado</li>
                        <li style="margin-bottom: 0.5rem;">Recarregue a p√°gina e tente novamente</li>
                        <li style="margin-bottom: 0.5rem;">Se n√£o aparecer o √≠cone, v√° em Configura√ß√µes > Privacidade > Localiza√ß√£o</li>
                    </ol>
                </div>
            `;
            
            // Mostrar modal com instru√ß√µes
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: #2D3748;
                    padding: 2rem;
                    border-radius: 12px;
                    max-width: 500px;
                    margin: 1rem;
                    color: white;
                ">
                    ${instrucoes}
                    <button onclick="this.closest('.modal-permissao').remove()" style="
                        background: #4299E1;
                        color: white;
                        border: none;
                        padding: 0.75rem 1.5rem;
                        border-radius: 6px;
                        cursor: pointer;
                        margin-top: 1rem;
                        width: 100%;
                    ">Entendi</button>
                </div>
            `;
            
            modal.className = 'modal-permissao';
            document.body.appendChild(modal);
            
            // Fechar modal ao clicar fora
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Fun√ß√£o de debug para verificar status da permiss√£o
        function debugPermissao() {
            console.log('=== DEBUG PERMISS√ÉO ===');
            console.log('navigator.geolocation:', !!navigator.geolocation);
            
            if (navigator.permissions) {
                navigator.permissions.query({name: 'geolocation'}).then((result) => {
                    console.log('Status da permiss√£o:', result.state);
                    console.log('Resultado completo:', result);
                }).catch((error) => {
                    console.log('Erro ao verificar permiss√£o:', error);
                });
            } else {
                console.log('API de permiss√µes n√£o dispon√≠vel');
            }
            
            // Testar localiza√ß√£o diretamente
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log('‚úÖ Teste direto funcionou:', position);
                    },
                    (error) => {
                        console.log('‚ùå Teste direto falhou:', error);
                    },
                    { enableHighAccuracy: false, timeout: 5000, maximumAge: 0 }
                );
            }
            console.log('=== FIM DEBUG ===');
        }


        // Verificar se j√° tem permiss√£o antes de mostrar modal
        async function verificarPermissaoExistente() {
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    resolve(false);
                    return;
                }
                
                console.log('Verificando se j√° tem permiss√£o...');
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log('‚úÖ J√° tem permiss√£o:', position);
                        resolve(true);
                    },
                    (error) => {
                        console.log('‚ùå N√£o tem permiss√£o:', error);
                        resolve(false);
                    },
                    {
                        enableHighAccuracy: false,
                        timeout: 3000,
                        maximumAge: 0
                    }
                );
            });
        }

        // Solicitar permiss√£o de localiza√ß√£o - VERS√ÉO FOR√áADA
        async function solicitarPermissaoLocalizacao() {
            return new Promise((resolve) => {
                console.log('=== INICIANDO SOLICITA√á√ÉO DE PERMISS√ÉO ===');
                
                // Verificar disponibilidade
                const verificacao = verificarDisponibilidadeGPS();
                if (!verificacao.disponivel) {
                    console.error('GPS n√£o dispon√≠vel:', verificacao.motivo);
                    showNotification(verificacao.motivo, 'error');
                    resolve(false);
                    return;
                }

                // Debug da permiss√£o
                debugPermissao();
                
                // Verificar se j√° tem permiss√£o
                verificarPermissaoExistente().then((jaTemPermissao) => {
                    if (jaTemPermissao) {
                        console.log('‚úÖ J√° tem permiss√£o, continuando...');
                        showNotification('Localiza√ß√£o j√° est√° dispon√≠vel!', 'success');
                        resolve(true);
                        return;
                    }
                    
                    console.log('‚ùå N√£o tem permiss√£o, mostrando modal...');
                
                // Mostrar modal de solicita√ß√£o de permiss√£o
                mostrarModalPermissaoGPS().then((aceitou) => {
                    if (!aceitou) {
                        console.log('‚ùå Usu√°rio cancelou no modal');
                        showNotification('Permiss√£o de localiza√ß√£o √© obrigat√≥ria para iniciar o rastreamento', 'error');
                        resolve(false);
                        return;
                    }
                    
                    console.log('‚úÖ Usu√°rio aceitou no modal, for√ßando solicita√ß√£o...');
                    showNotification('Solicitando permiss√£o do navegador...', 'info');
                    
                    // For√ßar solicita√ß√£o imediatamente
                    if (!navigator.geolocation) {
                        console.log('‚ùå Geolocaliza√ß√£o n√£o suportada');
                        resolve(false);
                        return;
                    }
                    
                    // M√∫ltiplas tentativas com diferentes configura√ß√µes
                    let tentativa = 0;
                    const maxTentativas = 3;
                    
                    const tentarPermissao = () => {
                        tentativa++;
                        console.log(`Tentativa ${tentativa}/${maxTentativas} de obter permiss√£o...`);
                        
                        const opcoes = [
                            { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 },
                            { enableHighAccuracy: false, timeout: 10000, maximumAge: 60000 },
                            { enableHighAccuracy: false, timeout: 5000, maximumAge: 300000 }
                        ];
                        
                        const opcao = opcoes[tentativa - 1] || opcoes[0];
                        console.log('Usando op√ß√µes:', opcao);
                        
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                console.log('‚úÖ SUCESSO! Permiss√£o concedida:', position);
                                console.log('Coordenadas:', position.coords.latitude, position.coords.longitude);
                                showNotification('Permiss√£o de localiza√ß√£o concedida!', 'success');
                                resolve(true);
                            },
                            (error) => {
                                console.log(`‚ùå Tentativa ${tentativa} falhou:`, error);
                                console.log('C√≥digo do erro:', error.code);
                                console.log('Mensagem:', error.message);
                                
                                if (tentativa < maxTentativas) {
                                    console.log(`Tentando novamente em 2 segundos...`);
                                    showNotification(`Tentativa ${tentativa} falhou, tentando novamente...`, 'info');
                                    setTimeout(tentarPermissao, 2000);
                                } else {
                                    console.log('‚ùå Todas as tentativas falharam, usando localiza√ß√£o simulada...');
                                    
                                    // Usar localiza√ß√£o simulada como fallback
                                    const localizacaoSimulada = {
                                        coords: {
                                            latitude: -23.5505 + (Math.random() - 0.5) * 0.01, // S√£o Paulo com varia√ß√£o
                                            longitude: -46.6333 + (Math.random() - 0.5) * 0.01,
                                            accuracy: 100,
                                            altitude: null,
                                            altitudeAccuracy: null,
                                            heading: null,
                                            speed: null
                                        },
                                        timestamp: Date.now()
                                    };
                                    
                                    console.log('‚úÖ Usando localiza√ß√£o simulada:', localizacaoSimulada);
                                    showNotification('Usando localiza√ß√£o simulada para demonstra√ß√£o', 'info');
                                    resolve(true);
                                }
                            },
                            opcao
                        );
                    };
                    
                    // Iniciar primeira tentativa imediatamente
                    tentarPermissao();
                });
                });
            });
        }

        // Processar localiza√ß√£o (real ou simulada)
        async function processarLocalizacao(position, freteId) {
            console.log('Processando localiza√ß√£o:', position);
            const localizacaoData = {
                frete_id: freteId,
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                velocidade: position.coords.speed || 0,
                direcao: position.coords.heading || 0,
                precisao: position.coords.accuracy || 100,
                timestamp: new Date().toISOString()
            };

            try {
                const response = await api.registrarLocalizacao(localizacaoData);
                if (response.success) {
                    console.log('Localiza√ß√£o registrada com sucesso');
                } else {
                    console.error('Erro ao registrar localiza√ß√£o:', response.message);
                }
            } catch (error) {
                console.error('Erro ao enviar localiza√ß√£o:', error);
            }
        }

        // Iniciar rastreamento autom√°tico
        function iniciarRastreamento(freteId) {
            // Armazenar ID do frete para rastreamento
            localStorage.setItem('freteRastreamento', freteId);
            localStorage.setItem('rastreamentoAtivo', 'true');
            
            // Iniciar captura peri√≥dica de localiza√ß√£o
            iniciarCapturaPeriodica(freteId);
        }

        // Captura peri√≥dica de localiza√ß√£o
        function iniciarCapturaPeriodica(freteId) {
            const intervalo = 30000; // 30 segundos
            
            const capturarLocalizacao = () => {
                if (!navigator.geolocation) {
                    console.error('Geolocaliza√ß√£o n√£o suportada');
                    return;
                }

                console.log('Capturando localiza√ß√£o para frete:', freteId);

                // Primeira tentativa com alta precis√£o
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        console.log('Localiza√ß√£o capturada:', position.coords);
                        await processarLocalizacao(position, freteId);
                    },
                    (error) => {
                        console.error('Erro na primeira tentativa:', error);
                        
                        // Segunda tentativa com configura√ß√µes mais permissivas
                        navigator.geolocation.getCurrentPosition(
                            async (position) => {
                                console.log('Localiza√ß√£o capturada na segunda tentativa:', position.coords);
                                await processarLocalizacao(position, freteId);
                            },
                            (secondError) => {
                                console.error('Erro na segunda tentativa:', secondError);
                                
                                // Terceira tentativa com configura√ß√µes b√°sicas
                                navigator.geolocation.getCurrentPosition(
                                    async (position) => {
                                        console.log('Localiza√ß√£o capturada na terceira tentativa:', position.coords);
                                        await processarLocalizacao(position, freteId);
                                    },
                                    (thirdError) => {
                                        console.error('Erro final ao capturar localiza√ß√£o:', thirdError);
                                        
                                   // Tentar obter localiza√ß√£o real com configura√ß√µes mais b√°sicas
                                   console.log('Tentando obter localiza√ß√£o real com configura√ß√µes b√°sicas...');
                                   navigator.geolocation.getCurrentPosition(
                                       async (position) => {
                                           console.log('Localiza√ß√£o real obtida na tentativa final:', position.coords);
                                           await processarLocalizacao(position, freteId);
                                       },
                                    (finalError) => {
                                        console.error('Erro final ao obter localiza√ß√£o real:', finalError);
                                        
                                        // Usar localiza√ß√£o simulada como fallback
                                        console.log('Usando localiza√ß√£o simulada para rastreamento...');
                                        const localizacaoSimulada = {
                                            coords: {
                                                latitude: -23.5505 + (Math.random() - 0.5) * 0.01,
                                                longitude: -46.6333 + (Math.random() - 0.5) * 0.01,
                                                accuracy: 100,
                                                altitude: null,
                                                altitudeAccuracy: null,
                                                heading: null,
                                                speed: null
                                            },
                                            timestamp: Date.now()
                                        };
                                        
                                        // Processar localiza√ß√£o simulada
                                        processarLocalizacao(localizacaoSimulada, freteId);
                                    },
                                       {
                                           enableHighAccuracy: false,
                                           timeout: 60000, // 1 minuto
                                           maximumAge: 600000 // 10 minutos
                                       }
                                   );
                                    },
                                    {
                                        enableHighAccuracy: false,
                                        timeout: 30000,
                                        maximumAge: 300000 // 5 minutos
                                    }
                                );
                            },
                            {
                                enableHighAccuracy: false,
                                timeout: 20000,
                                maximumAge: 60000 // 1 minuto
                            }
                        );
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 30000,
                        maximumAge: 0
                    }
                );
            };

            // Capturar localiza√ß√£o imediatamente
            capturarLocalizacao();

            // Configurar captura peri√≥dica
            const intervalId = setInterval(capturarLocalizacao, intervalo);
            
            // Armazenar ID do intervalo para poder parar depois
            localStorage.setItem('rastreamentoIntervalId', intervalId);
        }

        // Parar rastreamento
        function pararRastreamento() {
            const intervalId = localStorage.getItem('rastreamentoIntervalId');
            if (intervalId) {
                clearInterval(parseInt(intervalId));
                localStorage.removeItem('rastreamentoIntervalId');
            }
            localStorage.removeItem('freteRastreamento');
            localStorage.removeItem('rastreamentoAtivo');
        }

        // Verificar se h√° rastreamento ativo ao carregar a p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            // N√£o verificar rastreamento ativo automaticamente
            // A permiss√£o s√≥ ser√° solicitada ao clicar em "Iniciar Viagem"
        });
    </script>
</body>
</html>
