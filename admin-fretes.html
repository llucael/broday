<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento de Fretes - Admin - Broday Transportes</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
                    <div class="logo">
            <span>Broday Transportes</span>
        </div>
            <nav class="nav">
                <a href="admin-dashboard.html" class="nav-link">Dashboard</a>
                <a href="admin-fretes.html" class="nav-link active">Fretes</a>
                <a href="admin-usuarios.html" class="nav-link">Usuários</a>
                <a href="admin-motoristas.html" class="nav-link">Motoristas</a>
                <a href="admin-configuracoes.html" class="nav-link">Configurações</a>
            </nav>
            <div class="header-buttons">
                <button class="theme-toggle" onclick="toggleTheme()" title="Alternar tema">
                    <i class="fas fa-sun"></i>
                </button>
                <span class="user-info" id="user-info">Bem-vindo, <span id="user-name">Admin</span></span>
                <button class="btn btn-secondary" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Sair
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Fretes Section -->
            <section id="fretes" class="fretes-section active">
                <div class="section-header">
                    <h1>Gerenciamento de Fretes</h1>
                    <div class="filters">
                        <select id="status-filter">
                            <option value="">Todos os Status</option>
                            <option value="solicitado">Solicitado</option>
                            <option value="aceito">Aceito</option>
                            <option value="em_transito">Em Trânsito</option>
                            <option value="entregue">Entregue</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                        <select id="cliente-filter">
                            <option value="">Todos os Clientes</option>
                        </select>
                        <select id="motorista-filter">
                            <option value="">Todos os Motoristas</option>
                        </select>
                        <input type="date" id="data-filter" placeholder="Filtrar por data">
                        <button class="btn btn-primary" onclick="loadFretes()">
                            <i class="fas fa-sync"></i>
                            Atualizar
                        </button>
                        <button class="btn btn-primary" onclick="clearFilters()">
                            <i class="fas fa-times"></i>
                            Limpar Filtros
                        </button>
                    </div>
                </div>

                <div class="fretes-list" id="fretes-list">
                    <!-- Fretes serão carregados aqui -->
                </div>
            </section>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Broday Transportes</h3>
                    <p>Conectando embarcadores e transportadores de forma inteligente e eficiente.</p>
                </div>
                
                <div class="footer-section">
                    <h4>Navegação</h4>
                    <div class="footer-nav">
                        <a href="admin-dashboard.html">Dashboard</a>
                        <a href="admin-fretes.html">Fretes</a>
                        <a href="admin-usuarios.html">Usuários</a>
                        <a href="admin-motoristas.html">Motoristas</a>
                        <a href="admin-configuracoes.html">Configurações</a>
                    </div>
                </div>
                
                <div class="footer-section">
                    <h4>Contato</h4>
                    <div class="contact-info">
                        <p><i class="fas fa-map-marker-alt"></i> Rua Cambara, 268 - Nova Russia</p>
                        <p>Ponta Grossa - PR, 84.053-060</p>
                        <p><i class="fas fa-phone"></i> (42) 99985-2606</p>
                        <p><i class="fas fa-envelope"></i> brodaytransportes@gmail.com</p>
                    </div>
                </div>
                
            </div>
            
            <div class="footer-legal">
                <div class="legal-info">
                    <p><strong>CNPJ:</strong> 58.893.054/0001-03</p>
                    <p><strong>Endereço:</strong> Rua Cambara, 268 - Nova Russia, Ponta Grossa - PR, 84.053-060</p>
                </div>
                <div class="copyright">
                    <p>© 2025 Broday Transportes. Todos os direitos reservados.</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="js/api.js"></script>
    <script>
        // Verificar se o usuário está logado
        if (!isLoggedIn()) {
            window.location.href = 'login.html';
        }

        // Verificar tipo de usuário
        if (getUserType() !== 'admin') {
            window.location.href = 'login.html';
        }

        // Carregar dados do usuário
        document.addEventListener('DOMContentLoaded', function() {
            loadUserData();
            loadFilters();
            loadFretes();
        });

        function loadUserData() {
            const user = getCurrentUser();
            if (user) {
                document.getElementById('user-name').textContent = user.name || user.email;
            }
        }

        async function loadFilters() {
            try {
                // Dados simulados para filtros
                const clientesSimulados = [
                    { id: 1, email: 'cliente1@email.com' },
                    { id: 2, email: 'cliente2@email.com' },
                    { id: 3, email: 'cliente3@email.com' }
                ];
                
                const motoristasSimulados = [
                    { id: 1, email: 'motorista1@email.com' },
                    { id: 2, email: 'motorista2@email.com' }
                ];
                
                // Carregar clientes
                const clienteSelect = document.getElementById('cliente-filter');
                clientesSimulados.forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.id;
                    option.textContent = cliente.email;
                    clienteSelect.appendChild(option);
                });

                // Carregar motoristas
                const motoristaSelect = document.getElementById('motorista-filter');
                motoristasSimulados.forEach(motorista => {
                    const option = document.createElement('option');
                    option.value = motorista.id;
                    option.textContent = motorista.email;
                    motoristaSelect.appendChild(option);
                });
                
                // Tentar carregar dados reais em background
                try {
                    const clientesResponse = await api.getClientes(1, 1000);
                    if (clientesResponse.success) {
                        clienteSelect.innerHTML = '<option value="">Todos os Clientes</option>';
                        clientesResponse.data.clientes.forEach(cliente => {
                            const option = document.createElement('option');
                            option.value = cliente.id;
                            option.textContent = cliente.name || cliente.email;
                            clienteSelect.appendChild(option);
                        });
                    }

                    const motoristasResponse = await api.getMotoristas(1, 1000);
                    if (motoristasResponse.success) {
                        motoristaSelect.innerHTML = '<option value="">Todos os Motoristas</option>';
                        motoristasResponse.data.motoristas.forEach(motorista => {
                            const option = document.createElement('option');
                            option.value = motorista.id;
                            option.textContent = motorista.name || motorista.email;
                            motoristaSelect.appendChild(option);
                        });
                    }
                } catch (apiError) {
                    console.log('API não disponível, usando dados simulados para filtros');
                }
            } catch (error) {
                console.error('Erro ao carregar filtros:', error);
            }
        }

        async function loadFretes() {
            try {
                const container = document.getElementById('fretes-list');
                container.innerHTML = '<p class="no-data">Carregando fretes...</p>';
                
                // Dados simulados para teste
                const fretesSimulados = [
                    {
                        id: 1,
                        codigo: 'FR123456789',
                        status: 'aceito',
                        cargoType: 'Eletrônicos',
                        cargoWeight: '15.5',
                        cargoValue: '2500.00',
                        originCity: 'Ponta Grossa',
                        originState: 'PR',
                        originStreet: 'Rua Cambara',
                        originNumber: '268',
                        destinationCity: 'Rio de Janeiro',
                        destinationState: 'RJ',
                        destinationStreet: 'Rua da Carioca',
                        destinationNumber: '200',
                        dataColeta: new Date(),
                        cliente: { email: 'cliente1@email.com' },
                        motorista: { email: 'motorista1@email.com' }
                    },
                    {
                        id: 2,
                        codigo: 'FR987654321',
                        status: 'em_transito',
                        cargoType: 'Roupas',
                        cargoWeight: '8.2',
                        cargoValue: '800.00',
                        originCity: 'Ponta Grossa',
                        originState: 'PR',
                        originStreet: 'Rua Cambara',
                        originNumber: '268',
                        destinationCity: 'Belo Horizonte',
                        destinationState: 'MG',
                        destinationStreet: 'Rua da Bahia',
                        destinationNumber: '1500',
                        dataColeta: new Date(),
                        cliente: { email: 'cliente2@email.com' },
                        motorista: { email: 'motorista2@email.com' }
                    },
                    {
                        id: 3,
                        codigo: 'FR456789123',
                        status: 'solicitado',
                        cargoType: 'Documentos',
                        cargoWeight: '0.5',
                        cargoValue: '50.00',
                        originCity: 'Ponta Grossa',
                        originState: 'PR',
                        originStreet: 'Rua Cambara',
                        originNumber: '268',
                        destinationCity: 'Florianópolis',
                        destinationState: 'SC',
                        destinationStreet: 'Rua Felipe Schmidt',
                        destinationNumber: '456',
                        dataColeta: new Date(),
                        cliente: { email: 'cliente3@email.com' },
                        motorista: null
                    },
                    {
                        id: 4,
                        codigo: 'FR111222333',
                        status: 'entregue',
                        cargoType: 'Livros',
                        cargoWeight: '12.0',
                        cargoValue: '300.00',
                        originCity: 'Ponta Grossa',
                        originState: 'PR',
                        originStreet: 'Rua Cambara',
                        originNumber: '268',
                        destinationCity: 'Fortaleza',
                        destinationState: 'CE',
                        destinationStreet: 'Rua Barão do Rio Branco',
                        destinationNumber: '100',
                        dataColeta: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000),
                        dataEntrega: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000),
                        cliente: { email: 'cliente4@email.com' },
                        motorista: { email: 'motorista1@email.com' }
                    },
                    {
                        id: 5,
                        codigo: 'FR444555666',
                        status: 'entregue',
                        cargoType: 'Equipamentos',
                        cargoWeight: '25.0',
                        cargoValue: '5000.00',
                        originCity: 'Ponta Grossa',
                        originState: 'PR',
                        originStreet: 'Rua Cambara',
                        originNumber: '268',
                        destinationCity: 'Porto Alegre',
                        destinationState: 'RS',
                        destinationStreet: 'Rua dos Andradas',
                        destinationNumber: '500',
                        dataColeta: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000),
                        dataEntrega: new Date(Date.now() - 8 * 24 * 60 * 60 * 1000),
                        cliente: { email: 'cliente5@email.com' },
                        motorista: { email: 'motorista2@email.com' }
                    },
                    {
                        id: 6,
                        codigo: 'FR777888999',
                        status: 'entregue',
                        cargoType: 'Móveis',
                        cargoWeight: '35.0',
                        cargoValue: '1200.00',
                        originCity: 'Ponta Grossa',
                        originState: 'PR',
                        originStreet: 'Rua Cambara',
                        originNumber: '268',
                        destinationCity: 'Goiânia',
                        destinationState: 'GO',
                        destinationStreet: 'Rua 3',
                        destinationNumber: '800',
                        dataColeta: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000),
                        dataEntrega: new Date(Date.now() - 12 * 24 * 60 * 60 * 1000),
                        cliente: { email: 'cliente6@email.com' },
                        motorista: { email: 'motorista1@email.com' }
                    }
                ];
                
                // Aplicar filtros nos dados simulados
                let fretesFiltrados = [...fretesSimulados];
                
                const statusFilter = document.getElementById('status-filter').value;
                if (statusFilter) {
                    fretesFiltrados = fretesFiltrados.filter(f => f.status === statusFilter);
                }
                
                container.innerHTML = '';
                
                if (fretesFiltrados.length === 0) {
                    container.innerHTML = '<p class="no-data">Nenhum frete encontrado</p>';
                    return;
                }
                
                fretesFiltrados.forEach(frete => {
                    const freteCard = createFreteCard(frete);
                    container.appendChild(freteCard);
                });
                
                // Tentar carregar dados reais em background
                try {
                    const statusFilter = document.getElementById('status-filter').value;
                    const clienteFilter = document.getElementById('cliente-filter').value;
                    const motoristaFilter = document.getElementById('motorista-filter').value;
                    const dataFilter = document.getElementById('data-filter').value;
                    
                    const filters = {};
                    if (statusFilter) filters.status = statusFilter;
                    if (clienteFilter) filters.clienteId = clienteFilter;
                    if (motoristaFilter) filters.motoristaId = motoristaFilter;
                    if (dataFilter) filters.data = dataFilter;
                    
                    const response = await api.getAllFretes(1, 10, filters);
                    
                    if (response.success && response.data.fretes.length > 0) {
                        container.innerHTML = '';
                        response.data.fretes.forEach(frete => {
                            const freteCard = createFreteCard(frete);
                            container.appendChild(freteCard);
                        });
                    }
                } catch (apiError) {
                    console.log('API não disponível, usando dados simulados');
                }
                
            } catch (error) {
                console.error('Erro ao carregar fretes:', error);
                const container = document.getElementById('fretes-list');
                container.innerHTML = '<p class="no-data">Erro ao carregar fretes</p>';
            }
        }

        function createFreteCard(frete) {
            const card = document.createElement('div');
            card.className = 'frete-card';
            
            // Formatar origem e destino
            const origem = `${frete.originCity}/${frete.originState}`;
            const destino = `${frete.destinationCity}/${frete.destinationState}`;
            
            // Formatar data de coleta
            const dataColeta = frete.dataColeta ? new Date(frete.dataColeta).toLocaleDateString('pt-BR') : 'Não definida';
            
            // Obter nomes do cliente e motorista
            const clienteNome = frete.cliente ? (frete.cliente.name || frete.cliente.email) : 'N/A';
            const motoristaNome = frete.motorista ? (frete.motorista.name || frete.motorista.email) : 'Não atribuído';
            
            // Formatar valor da carga
            const valorCarga = frete.cargoValue ? `R$ ${parseFloat(frete.cargoValue).toFixed(2).replace('.', ',')}` : 'N/A';
            
            card.innerHTML = `
                <div class="frete-header">
                    <h3>${frete.codigo}</h3>
                    <span class="status status-${frete.status}">${getStatusText(frete.status)}</span>
                </div>
                <div class="frete-info">
                    <div class="frete-route">
                        <div class="route-point">
                            <i class="fas fa-map-marker-alt route-icon origin"></i>
                            <div class="route-details">
                                <strong>Origem:</strong> ${origem}
                                <small>${frete.originStreet}, ${frete.originNumber}</small>
                            </div>
                        </div>
                        <div class="route-arrow">
                            <i class="fas fa-arrow-right"></i>
                        </div>
                        <div class="route-point">
                            <i class="fas fa-map-marker-alt route-icon destination"></i>
                            <div class="route-details">
                                <strong>Destino:</strong> ${destino}
                                <small>${frete.destinationStreet}, ${frete.destinationNumber}</small>
                            </div>
                        </div>
                    </div>
                    <div class="frete-details">
                        <div class="detail-item">
                            <i class="fas fa-box"></i>
                            <span>${frete.cargoType} (${frete.cargoWeight}kg)</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-dollar-sign"></i>
                            <span>${valorCarga}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-calendar"></i>
                            <span>Coleta: ${dataColeta}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-user"></i>
                            <span>Cliente: ${clienteNome}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-truck"></i>
                            <span>Motorista: ${motoristaNome}</span>
                        </div>
                    </div>
                </div>
                <div class="frete-actions">
                    <button class="btn btn-sm btn-primary" onclick="viewFrete(${frete.id})">
                        <i class="fas fa-eye"></i>
                        Ver Detalhes
                    </button>
                    <button class="btn btn-sm btn-success" onclick="rastrearFrete(${frete.id})">
                        <i class="fas fa-map-marker-alt"></i>
                        Rastrear
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="editFrete(${frete.id})">
                        <i class="fas fa-edit"></i>
                        Editar
                    </button>
                </div>
            `;
            return card;
        }

        function getStatusText(status) {
            const statusMap = {
                'solicitado': 'Solicitado',
                'aceito': 'Aceito',
                'em_transito': 'Em Trânsito',
                'entregue': 'Entregue',
                'cancelado': 'Cancelado'
            };
            return statusMap[status] || status;
        }

        function viewFrete(freteId) {
            // Implementar visualização detalhada do frete
            showNotification('Funcionalidade em desenvolvimento', 'info');
        }

        function rastrearFrete(freteId) {
            // Redirecionar para página de rastreamento
            window.location.href = `rastreamento.html?frete=${freteId}`;
        }

        function editFrete(freteId) {
            // Implementar edição do frete
            showNotification('Funcionalidade em desenvolvimento', 'info');
        }

        function clearFilters() {
            document.getElementById('status-filter').value = '';
            document.getElementById('cliente-filter').value = '';
            document.getElementById('motorista-filter').value = '';
            document.getElementById('data-filter').value = '';
            loadFretes();
        }

        // Função para mostrar notificações
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerText = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // Função para alternar tema
        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const isLightMode = document.body.classList.contains('light-mode');
            localStorage.setItem('theme', isLightMode ? 'light' : 'dark');
        }
        
        // Carregar tema salvo
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
            }
        });
    </script>
</body>
</html>
