<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento de Fretes - Admin - Broday Transportes</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Corrigir espaçamento da navegação */
        .header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
        }
        
        .nav {
            display: flex;
            gap: 2rem;
            margin: 0 1rem;
        }
        
        /* Corrigir overflow dos cards de frete */
        .fretes-list {
            display: grid !important;
            gap: 1rem !important;
            grid-template-columns: repeat(3, 1fr) !important;
            width: 100%;
            box-sizing: border-box;
            overflow-x: hidden;
        }
        
        .frete-card {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            word-wrap: break-word;
            overflow-wrap: break-word;
            padding: 1rem !important;
        }
        
        .frete-route {
            display: flex;
            align-items: center;
            gap: 0.5rem !important;
            margin-bottom: 0.75rem !important;
            flex-wrap: wrap;
        }
        
        .route-point {
            display: flex;
            align-items: center;
            gap: 0.375rem !important;
            min-width: 0;
            flex: 1;
        }
        
        .route-details {
            min-width: 0;
            flex: 1;
        }
        
        .route-details strong {
            display: block;
            margin-bottom: 0.15rem !important;
            font-size: 0.8rem !important;
        }
        
        .route-details small {
            display: block;
            color: #A0AEC0;
            font-size: 0.7rem !important;
            word-break: break-word;
        }
        
        .route-arrow {
            flex-shrink: 0;
            color: #4299E1;
            font-size: 0.9rem !important;
        }
        
        .frete-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr) !important;
            gap: 0.5rem !important;
            margin-bottom: 1rem !important;
        }
        
        .detail-item {
            display: flex;
            align-items: center;
            gap: 0.375rem !important;
            padding: 0.35rem !important;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            font-size: 0.75rem !important;
            word-break: break-word;
        }
        
        .detail-item i {
            color: #4299E1;
            flex-shrink: 0;
            font-size: 0.8rem !important;
        }
        
        .detail-item span {
            min-width: 0;
            flex: 1;
        }
        
        /* Ajustar header do frete */
        .frete-header {
            margin-bottom: 0.75rem !important;
            padding-bottom: 0.5rem !important;
        }
        
        .frete-header h3 {
            font-size: 1rem !important;
        }
        
        .frete-header .status {
            font-size: 0.65rem !important;
            padding: 0.25rem 0.5rem !important;
        }
        
        /* Ajustar ações do frete */
        .frete-actions {
            gap: 0.5rem !important;
            padding-top: 0.5rem !important;
        }
        
        .frete-actions .btn {
            padding: 0.4rem 0.75rem !important;
            font-size: 0.75rem !important;
        }
        
        /* Responsive para telas menores */
        @media (max-width: 1200px) {
            .fretes-list {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }
        
        @media (max-width: 768px) {
            .fretes-list {
                grid-template-columns: 1fr !important;
                gap: 1rem;
            }
            
            .frete-route {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .route-arrow {
                align-self: center;
                transform: rotate(90deg);
            }
            
            .frete-details {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="logo">
                <span>Broday Transportes</span>
            </div>
            <nav class="nav">
                <a href="admin-dashboard.html" class="nav-link">Dashboard</a>
                <a href="admin-fretes.html" class="nav-link active">Fretes</a>
                <a href="admin-usuarios.html" class="nav-link">Usuários</a>
                <a href="admin-motoristas.html" class="nav-link">Motoristas</a>
                <a href="admin-caminhoes.html" class="nav-link">Caminhões</a>
                <a href="admin-configuracoes.html" class="nav-link">Configurações</a>
            </nav>
            <div class="header-buttons">
                <button class="theme-toggle" onclick="toggleTheme()" title="Alternar tema">
                    <i class="fas fa-sun"></i>
                </button>
                <span class="user-info" id="user-info">Bem-vindo, <span id="user-name">Admin</span></span>
                <button class="btn btn-secondary" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Sair
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Fretes Section -->
            <section id="fretes" class="fretes-section active">
                <div class="section-header">
                    <h1>Gerenciamento de Fretes</h1>
                    <div class="filters">
                        <label for="status-filter" class="sr-only">Filtrar por status</label>
                        <select id="status-filter" title="Filtrar fretes por status" aria-label="Filtrar fretes por status">
                            <option value="">Todos os Status</option>
                            <option value="solicitado">Solicitado</option>
                            <option value="aceito">Aceito</option>
                            <option value="em_transito">Em Trânsito</option>
                            <option value="entregue">Entregue</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                        <label for="cliente-filter" class="sr-only">Filtrar por cliente</label>
                        <select id="cliente-filter" title="Filtrar fretes por cliente" aria-label="Filtrar fretes por cliente">
                            <option value="">Todos os Clientes</option>
                        </select>
                        <label for="motorista-filter" class="sr-only">Filtrar por motorista</label>
                        <select id="motorista-filter" title="Filtrar fretes por motorista" aria-label="Filtrar fretes por motorista">
                            <option value="">Todos os Motoristas</option>
                        </select>
                        <button class="btn btn-primary" onclick="clearFilters()">
                            <i class="fas fa-times"></i>
                            Limpar Filtros
                        </button>
                    </div>
                </div>

                <div class="fretes-list" id="fretes-list">
                    <!-- Fretes serão carregados aqui -->
                </div>
            </section>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Broday Transportes</h3>
                    <p>Conectando embarcadores e transportadores de forma inteligente e eficiente.</p>
                </div>
                
                <div class="footer-section">
                    <h4>Navegação</h4>
                    <div class="footer-nav">
                        <a href="admin-dashboard.html">Dashboard</a>
                        <a href="admin-fretes.html">Fretes</a>
                        <a href="admin-usuarios.html">Usuários</a>
                        <a href="admin-motoristas.html">Motoristas</a>
                        <a href="admin-configuracoes.html">Configurações</a>
                    </div>
                </div>
                
                <div class="footer-section">
                    <h4>Contato</h4>
                    <div class="contact-info">
                        <p><i class="fas fa-map-marker-alt"></i> Rua Cambara, 268 - Nova Russia</p>
                        <p>Ponta Grossa - PR, 84.053-060</p>
                        <p><i class="fas fa-phone"></i> (42) 99985-2606</p>
                        <p><i class="fas fa-envelope"></i> brodaytransportes@gmail.com</p>
                    </div>
                </div>
                
            </div>
            
            <div class="footer-legal">
                <div class="legal-info">
                    <p><strong>CNPJ:</strong> 58.893.054/0001-03</p>
                    <p><strong>Endereço:</strong> Rua Cambara, 268 - Nova Russia, Ponta Grossa - PR, 84.053-060</p>
                </div>
                <div class="copyright">
                    <p>© 2025 Broday Transportes. Todos os direitos reservados.</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="js/api.js"></script>
    <script>
        // Verificar se o usuário está logado
        if (!isLoggedIn()) {
            window.location.href = 'login.html';
        }

        // Verificar tipo de usuário
        if (getUserType() !== 'admin') {
            window.location.href = 'login.html';
        }

        // Carregar dados do usuário
        document.addEventListener('DOMContentLoaded', function() {
            loadUserData();
            loadFilters();
            loadFretes();
            
            // Adicionar event listeners para os filtros
            document.getElementById('status-filter').addEventListener('change', loadFretes);
            document.getElementById('cliente-filter').addEventListener('change', loadFretes);
            document.getElementById('motorista-filter').addEventListener('change', loadFretes);
        });

        function loadUserData() {
            const user = getCurrentUser();
            if (user) {
                document.getElementById('user-name').textContent = user.nome || user.email;
            }
        }

        async function loadFilters() {
            try {
                // Carregar dados reais da API
                const clienteSelect = document.getElementById('cliente-filter');
                const motoristaSelect = document.getElementById('motorista-filter');
                
                // Limpar selects
                clienteSelect.innerHTML = '<option value="">Todos os Clientes</option>';
                motoristaSelect.innerHTML = '<option value="">Todos os Motoristas</option>';
                
                try {
                    // Carregar clientes reais
                    console.log('Carregando clientes...');
                    const clientesResponse = await api.getClientes(1, 1000);
                    console.log('Resposta clientes:', clientesResponse);
                    
                    if (clientesResponse && clientesResponse.success && clientesResponse.data && clientesResponse.data.usuarios) {
                        clientesResponse.data.usuarios.forEach(cliente => {
                            const option = document.createElement('option');
                            option.value = cliente.id;
                            option.textContent = cliente.nome || cliente.email;
                            clienteSelect.appendChild(option);
                        });
                        console.log('Clientes carregados:', clientesResponse.data.usuarios.length);
                    } else {
                        console.error('Resposta inválida de clientes:', clientesResponse);
                        clienteSelect.innerHTML = '<option value="">Erro ao carregar clientes</option>';
                    }

                    // Carregar motoristas reais
                    console.log('Carregando motoristas...');
                    const motoristasResponse = await api.getAllMotoristas(1, 1000);
                    console.log('Resposta motoristas:', motoristasResponse);
                    
                    if (motoristasResponse && motoristasResponse.success && motoristasResponse.data && motoristasResponse.data.motoristas) {
                        motoristasResponse.data.motoristas.forEach(motorista => {
                            const option = document.createElement('option');
                            option.value = motorista.id;
                            option.textContent = motorista.nome || motorista.email;
                            motoristaSelect.appendChild(option);
                        });
                        console.log('Motoristas carregados:', motoristasResponse.data.motoristas.length);
                    } else {
                        console.error('Resposta inválida de motoristas:', motoristasResponse);
                        motoristaSelect.innerHTML = '<option value="">Erro ao carregar motoristas</option>';
                    }
                } catch (apiError) {
                    console.error('Erro ao carregar filtros:', apiError);
                    // Adicionar opção de erro
                    clienteSelect.innerHTML = '<option value="">Erro ao carregar clientes</option>';
                    motoristaSelect.innerHTML = '<option value="">Erro ao carregar motoristas</option>';
                }
            } catch (error) {
                console.error('Erro ao carregar filtros:', error);
            }
        }

        async function loadFretes() {
            try {
                const container = document.getElementById('fretes-list');
                container.innerHTML = '<p class="no-data">Carregando fretes...</p>';
                
                // Obter filtros
                const statusFilter = document.getElementById('status-filter').value;
                const clienteFilter = document.getElementById('cliente-filter').value;
                const motoristaFilter = document.getElementById('motorista-filter').value;
                
                const filters = {};
                if (statusFilter) filters.status = statusFilter;
                if (clienteFilter) filters.clienteId = clienteFilter;
                if (motoristaFilter) filters.motoristaId = motoristaFilter;
                
                console.log('Filtros aplicados:', filters);
                
                // Carregar dados reais da API
                const response = await api.getAllFretes(1, 100, filters);
                
                if (response && response.success && response.data && response.data.fretes) {
                    let fretes = response.data.fretes;
                    
                    // Limpar container
                    container.innerHTML = '';
                    
                    if (fretes.length === 0) {
                        container.innerHTML = '<p class="no-data">Nenhum frete encontrado</p>';
                        return;
                    }
                    
                    fretes.forEach(frete => {
                        const freteCard = createFreteCard(frete);
                        container.appendChild(freteCard);
                    });
                } else {
                    console.error('Resposta inválida da API:', response);
                    container.innerHTML = '<p class="no-data">Erro ao carregar fretes</p>';
                }
                
            } catch (error) {
                console.error('Erro ao carregar fretes:', error);
                const container = document.getElementById('fretes-list');
                container.innerHTML = '<p class="no-data">Erro ao carregar fretes: ' + error.message + '</p>';
            }
        }

        function createFreteCard(frete) {
            const card = document.createElement('div');
            card.className = 'frete-card';
            
            // Formatar origem e destino
            const origem = `${frete.origin_city}/${frete.origin_state}`;
            const destino = `${frete.destination_city}/${frete.destination_state}`;
            
            // Formatar data de coleta limite
            const dataColeta = frete.data_coleta_limite ? new Date(frete.data_coleta_limite).toLocaleDateString('pt-BR') : 'Não definida';
            
            // Obter nomes do cliente e motorista
            const clienteNome = frete.cliente ? (frete.cliente.name || frete.cliente.email) : 'N/A';
            const motoristaNome = frete.motorista ? (frete.motorista.name || frete.motorista.email) : 'Não atribuído';
            
            card.innerHTML = `
                <div class="frete-header">
                    <h3>${frete.codigo}</h3>
                    <span class="status status-${frete.status}">${getStatusText(frete.status)}</span>
                </div>
                <div class="frete-info">
                    <div class="frete-route">
                        <div class="route-point">
                            <i class="fas fa-map-marker-alt route-icon origin"></i>
                            <div class="route-details">
                                <strong>Origem:</strong> ${origem}
                                <small>${frete.origin_street}, ${frete.origin_number}</small>
                            </div>
                        </div>
                        <div class="route-arrow">
                            <i class="fas fa-arrow-right"></i>
                        </div>
                        <div class="route-point">
                            <i class="fas fa-map-marker-alt route-icon destination"></i>
                            <div class="route-details">
                                <strong>Destino:</strong> ${destino}
                                <small>${frete.destination_street}, ${frete.destination_number}</small>
                            </div>
                        </div>
                    </div>
                    <div class="frete-details">
                        <div class="detail-item">
                            <i class="fas fa-box"></i>
                            <span>${frete.cargo_type}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-calendar"></i>
                            <span>Coleta: ${dataColeta}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-user"></i>
                            <span>Cliente: ${clienteNome}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-truck"></i>
                            <span>Motorista: ${motoristaNome}</span>
                        </div>
                    </div>
                </div>
                <div class="frete-actions">
                    <button class="btn btn-sm btn-primary" onclick="verDetalhes(${frete.id})" title="Ver detalhes">
                        <i class="fas fa-eye"></i>
                        Ver Detalhes
                    </button>
                    ${frete.status === 'solicitado' ? `
                    <button class="btn btn-sm btn-success" onclick="aprovarFrete(${frete.id})" title="Aprovar frete">
                        <i class="fas fa-check-circle"></i>
                        Aprovar
                    </button>
                    ` : ''}
                    ${frete.status === 'em_transito' ? `
                    <button class="btn btn-sm btn-success" onclick="rastrearFrete(${frete.id})" title="Rastrear frete">
                        <i class="fas fa-map-marker-alt"></i>
                        Rastrear
                    </button>
                    ` : ''}
                    <button class="btn btn-sm btn-warning" onclick="editarFrete(${frete.id})" title="Editar frete">
                        <i class="fas fa-edit"></i>
                        Editar
                    </button>
                </div>
            `;
            return card;
        }

        // Handler para aprovar frete como admin
        async function aprovarFrete(freteId) {
            if (!confirm('Deseja aprovar este frete e torná-lo disponível para motoristas?')) return;
            try {
                const resp = await api.adminAcceptFrete(freteId);
                if (resp && resp.success) {
                    showNotification('Frete aprovado com sucesso', 'success');
                    loadFretes();
                } else {
                    showNotification('Erro ao aprovar frete: ' + (resp.message || 'Erro desconhecido'), 'error');
                }
            } catch (err) {
                console.error('Erro ao aprovar frete:', err);
                showNotification('Erro ao aprovar frete: ' + (err.message || err), 'error');
            }
        }

        function getStatusText(status) {
            const statusMap = {
                'solicitado': 'Solicitado',
                'aceito': 'Aceito',
                'em_transito': 'Em Trânsito',
                'entregue': 'Entregue',
                'cancelado': 'Cancelado'
            };
            return statusMap[status] || status;
        }

        function viewFrete(freteId) {
            // Implementar visualização detalhada do frete
            showNotification('Funcionalidade em desenvolvimento', 'info');
        }

        function rastrearFrete(freteId) {
            // Redirecionar para página de rastreamento
            window.location.href = `rastreamento.html?frete=${freteId}`;
        }

        function editFrete(freteId) {
            // Implementar edição do frete
            showNotification('Funcionalidade em desenvolvimento', 'info');
        }

        function clearFilters() {
            document.getElementById('status-filter').value = '';
            document.getElementById('cliente-filter').value = '';
            document.getElementById('motorista-filter').value = '';
            loadFretes();
        }

        // Função para mostrar notificações
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerText = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // Função para alternar tema
        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const isLightMode = document.body.classList.contains('light-mode');
            localStorage.setItem('theme', isLightMode ? 'light' : 'dark');
            
            // Trocar ícone
            const icon = document.querySelector('.theme-toggle i');
            if (isLightMode) {
                icon.className = 'fas fa-moon';
            } else {
                icon.className = 'fas fa-sun';
            }
        }
        
        // Carregar tema salvo
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
                const icon = document.querySelector('.theme-toggle i');
                if (icon) icon.className = 'fas fa-moon';
            }
        });

        // Funções dos modais
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Fechar modal ao clicar fora dele
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Função para ver detalhes do frete
        async function verDetalhes(freteId) {
            try {
                const response = await api.getFreteById(freteId);
                if (response.success) {
                    const frete = response.data;
                    displayDetalhesFrete(frete);
                    openModal('detalhesModal');
                } else {
                    showNotification('Erro ao carregar detalhes do frete', 'error');
                }
            } catch (error) {
                console.error('Erro ao carregar detalhes:', error);
                showNotification('Erro ao carregar detalhes do frete', 'error');
            }
        }

        // Função para exibir detalhes do frete
        function displayDetalhesFrete(frete) {
            console.log('Dados do frete para detalhes:', frete); // Debug log
            const content = document.getElementById('detalhesContent');
            
            const origem = `${frete.origin_city || 'N/A'}, ${frete.origin_state || 'N/A'}`;
            const destino = `${frete.destination_city || 'N/A'}, ${frete.destination_state || 'N/A'}`;
            const dataColeta = frete.data_coleta_limite ? new Date(frete.data_coleta_limite).toLocaleDateString('pt-BR') : 'N/A';
            const dataEntrega = frete.data_entrega_limite ? new Date(frete.data_entrega_limite).toLocaleDateString('pt-BR') : 'N/A';
            const valorCarga = frete.cargo_value ? `R$ ${parseFloat(frete.cargo_value).toLocaleString('pt-BR', {minimumFractionDigits: 2})}` : 'A negociar';
            
            content.innerHTML = `
                <div class="frete-details-container">
                    <div class="detail-section">
                        <h3>Informações do Frete</h3>
                        <div class="detail-item">
                            <strong>Código:</strong>
                            <span>${frete.codigo || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Status:</strong>
                                <span class="status-badge status-${frete.status}">${getStatusText(frete.status)}</span>
                                ${frete.status === 'solicitado' ? `<button class="btn btn-sm btn-success" style="margin-left:12px;" onclick="aprovarFrete(${frete.id})" title="Aprovar frete">` +
                                    `<i class="fas fa-check-circle"></i> Aprovar` +
                                    `</button>` : ''}
                        </div>
                        <div class="detail-item">
                            <strong>Cliente:</strong>
                            <span>${frete.cliente?.email || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Motorista:</strong>
                            <span>${frete.motorista?.email || 'Não atribuído'}</span>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>Rota</h3>
                        <div class="route-info">
                            <div class="route-point">
                                <i class="fas fa-map-marker-alt route-icon origin"></i>
                                <div class="route-details">
                                    <strong>Origem:</strong> ${origem}
                                    <small>${frete.origin_street || 'N/A'}, ${frete.origin_number || 'N/A'}</small>
                                </div>
                            </div>
                            <div class="route-arrow">
                                <i class="fas fa-arrow-down"></i>
                            </div>
                            <div class="route-point">
                                <i class="fas fa-map-marker-alt route-icon destination"></i>
                                <div class="route-details">
                                    <strong>Destino:</strong> ${destino}
                                    <small>${frete.destination_street || 'N/A'}, ${frete.destination_number || 'N/A'}</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>Carga</h3>
                        <div class="detail-item">
                            <strong>Tipo:</strong>
                            <span>${frete.cargo_type || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Peso:</strong>
                            <span>${frete.cargo_weight ? parseFloat(frete.cargo_weight).toLocaleString('pt-BR') + ' kg' : 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Valor:</strong>
                            <span>${valorCarga}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Dimensões:</strong>
                            <span>${frete.cargo_dimensions || 'N/A'}</span>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>Contatos</h3>
                        <div class="detail-item">
                            <strong>Remetente:</strong>
                            <span>${frete.sender_name || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Telefone Remetente:</strong>
                            <span>${frete.sender_phone || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Destinatário:</strong>
                            <span>${frete.recipient_name || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Telefone Destinatário:</strong>
                            <span>${frete.recipient_phone || 'N/A'}</span>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>Datas</h3>
                        <div class="detail-item">
                            <strong>Data de Coleta:</strong>
                            <span>${dataColeta}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Data de Entrega:</strong>
                            <span>${dataEntrega}</span>
                        </div>
                    </div>

                    ${frete.observacoes ? `
                    <div class="detail-section">
                        <h3>Observações</h3>
                        <div class="detail-item" style="justify-content: flex-start;">
                            <span style="text-align: left;">${frete.observacoes}</span>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        // Função para editar frete
        async function editarFrete(freteId) {
            try {
                const response = await api.getFreteById(freteId);
                if (response.success) {
                    const frete = response.data;
                    await loadMotoristasForEdit(); // Carregar motoristas
                    populateEditForm(frete);
                    openModal('editarModal');
                    // Adicionar event listener após abrir o modal
                    setTimeout(() => {
                        addEditFormListener();
                    }, 100);
                } else {
                    showNotification('Erro ao carregar dados do frete', 'error');
                }
            } catch (error) {
                console.error('Erro ao carregar frete:', error);
                showNotification('Erro ao carregar dados do frete', 'error');
            }
        }

        // Função para carregar motoristas no select de edição
        async function loadMotoristasForEdit() {
            try {
                const response = await api.getAllMotoristas(1, 1000);
                const motoristaSelect = document.getElementById('editMotorista');
                motoristaSelect.innerHTML = '<option value="">Selecionar motorista</option>';
                
                if (response.success && response.data.motoristas) {
                    response.data.motoristas.forEach(motorista => {
                        const option = document.createElement('option');
                        option.value = motorista.id;
                        option.textContent = motorista.nome || motorista.email;
                        motoristaSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar motoristas:', error);
            }
        }

        // Função para preencher formulário de edição
        function populateEditForm(frete) {
            document.getElementById('editMotorista').value = frete.motorista_id || '';
            
            if (frete.data_coleta_limite) {
                const dataColeta = new Date(frete.data_coleta_limite);
                // Converter para formato YYYY-MM-DDTHH:MM para input datetime-local
                const year = dataColeta.getFullYear();
                const month = String(dataColeta.getMonth() + 1).padStart(2, '0');
                const day = String(dataColeta.getDate()).padStart(2, '0');
                const hours = String(dataColeta.getHours()).padStart(2, '0');
                const minutes = String(dataColeta.getMinutes()).padStart(2, '0');
                document.getElementById('editDataColeta').value = `${year}-${month}-${day}T${hours}:${minutes}`;
            }
            
            if (frete.data_entrega_limite) {
                const dataEntrega = new Date(frete.data_entrega_limite);
                // Converter para formato YYYY-MM-DDTHH:MM para input datetime-local
                const year = dataEntrega.getFullYear();
                const month = String(dataEntrega.getMonth() + 1).padStart(2, '0');
                const day = String(dataEntrega.getDate()).padStart(2, '0');
                const hours = String(dataEntrega.getHours()).padStart(2, '0');
                const minutes = String(dataEntrega.getMinutes()).padStart(2, '0');
                document.getElementById('editDataEntrega').value = `${year}-${month}-${day}T${hours}:${minutes}`;
            }

            // Armazenar ID do frete para edição
            document.getElementById('editarFreteForm').dataset.freteId = frete.id;
        }

        // Função para adicionar event listener ao formulário de edição
        function addEditFormListener() {
            const editarForm = document.getElementById('editarFreteForm');
            
            if (editarForm) {
                // Event listener para formulário de edição
                    editarForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const freteId = this.dataset.freteId;
                    const formData = new FormData(this);
                    
                    const updateData = {
                        motorista_id: formData.get('motorista_id') || null,
                        data_coleta_limite: formData.get('data_coleta'),
                        data_entrega_limite: formData.get('data_entrega') || null
                    };

                    try {
                        const response = await api.updateFrete(freteId, updateData);
                        
                        if (response.success) {
                            showNotification('Frete atualizado com sucesso!', 'success');
                            closeModal('editarModal');
                            loadFretes(); // Recarregar lista
                        } else {
                            showNotification('Erro ao atualizar frete: ' + (response.message || 'Erro desconhecido'), 'error');
                        }
                    } catch (error) {
                        console.error('Erro ao atualizar frete:', error);
                        showNotification('Erro ao atualizar frete: ' + error.message, 'error');
                    }
                });
            }
        }

        // Função para rastrear frete
        function rastrearFrete(freteId) {
            window.location.href = `rastreamento.html?id=${freteId}`;
        }

    </script>

    <style>
        /* CSS geral para modais */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #1a202c;
            border: 1px solid #4a5568;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #4a5568;
            background: #2d3748;
        }

        .modal-header h2 {
            margin: 0;
            color: #ffffff;
            font-size: 1.5rem;
        }

        .modal-header .close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #a0aec0;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-header .close:hover {
            color: #ffffff;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Modo claro */
        body.light-mode .modal-content {
            background: #ffffff;
            border-color: #e5e7eb;
        }

        body.light-mode .modal-header {
            background: #f9fafb;
        }

        body.light-mode .modal-header h2 {
            color: #1f2937;
        }

        body.light-mode .modal-header .close {
            color: #6b7280;
        }

        body.light-mode .modal-header .close:hover {
            color: #1f2937;
        }

        /* Estilos específicos para o modal de edição de fretes */
        #editarModal .modal-content {
            background: #1a202c;
            border: 2px solid #4a5568;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 12px;
            padding: 0;
        }

        #editarModal .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        #editarModal .modal-content::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 4px;
        }

        #editarModal .modal-content::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }

        #editarModal .modal-content::-webkit-scrollbar-thumb:hover {
            background: #667eea;
        }

        #editarModal .modal-header {
            background: #2d3748;
            border-bottom: 2px solid #4a5568;
            padding: 20px;
        }

        #editarModal .modal-header h2 {
            color: #ffffff;
            font-weight: 600;
            margin: 0;
        }

        #editarModal .modal-body {
            padding: 20px;
        }

        #editarModal .form-group {
            padding: 0 0 20px 0;
        }

        #editarModal .form-group label {
            color: #e2e8f0;
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
        }

        #editarModal .form-group input,
        #editarModal .form-group select {
            background: #2d3748;
            color: #ffffff;
            border: 2px solid #4a5568;
            border-radius: 8px;
            padding: 12px;
            width: 100%;
            font-size: 14px;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        #editarModal .form-group input:focus,
        #editarModal .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        #editarModal .form-actions {
            background: #2d3748;
            border-top: 2px solid #4a5568;
            padding: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin: 0;
            border-radius: 0 0 12px 12px;
        }

        #editarModal .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #editarModal .btn-primary {
            background: #667eea;
            color: white;
        }

        #editarModal .btn-primary:hover {
            background: #5a67d8;
        }

        #editarModal .btn-secondary {
            background: #4a5568;
            color: white;
        }

        #editarModal .btn-secondary:hover {
            background: #2d3748;
        }

        /* Modo claro */
        body.light-mode #editarModal .modal-content {
            background: #ffffff;
            border: 2px solid #e2e8f0;
        }

        body.light-mode #editarModal .modal-header {
            background: #f7fafc;
            border-bottom: 2px solid #e2e8f0;
        }

        body.light-mode #editarModal .modal-header h2 {
            color: #2d3748;
        }

        body.light-mode #editarModal .form-group label {
            color: #4a5568;
        }

        body.light-mode #editarModal .form-group input,
        body.light-mode #editarModal .form-group select {
            background: #ffffff;
            color: #2d3748;
            border: 2px solid #e2e8f0;
        }

        body.light-mode #editarModal .form-actions {
            background: #f7fafc;
            border-top: 2px solid #e2e8f0;
            margin: 0;
            border-radius: 0 0 12px 12px;
        }

        body.light-mode #editarModal .btn-secondary {
            background: #e2e8f0;
            color: #2d3748;
        }

        body.light-mode #editarModal .btn-secondary:hover {
            background: #cbd5e0;
        }

        /* Scroll personalizado para modo claro */
        body.light-mode #editarModal .modal-content::-webkit-scrollbar-track {
            background: #f7fafc;
        }

        body.light-mode #editarModal .modal-content::-webkit-scrollbar-thumb {
            background: #e2e8f0;
        }

        body.light-mode #editarModal .modal-content::-webkit-scrollbar-thumb:hover {
            background: #cbd5e0;
        }

        /* Estilos específicos para o modal de detalhes de fretes */
        #detalhesModal .modal-content {
            background: #1a202c;
            border: 2px solid #4a5568;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 12px;
            padding: 0;
        }

        #detalhesModal .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        #detalhesModal .modal-content::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 4px;
        }

        #detalhesModal .modal-content::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }

        #detalhesModal .modal-content::-webkit-scrollbar-thumb:hover {
            background: #667eea;
        }

        #detalhesModal .modal-header {
            background: #2d3748;
            border-bottom: 2px solid #4a5568;
            padding: 20px;
        }

        #detalhesModal .modal-header h2 {
            color: #ffffff;
            font-weight: 600;
            margin: 0;
        }

        #detalhesModal .modal-body {
            padding: 20px;
        }

        /* Modo claro para modal de detalhes */
        body.light-mode #detalhesModal .modal-content {
            background: #ffffff;
            border: 2px solid #e2e8f0;
        }

        body.light-mode #detalhesModal .modal-header {
            background: #f7fafc;
            border-bottom: 2px solid #e2e8f0;
        }

        body.light-mode #detalhesModal .modal-header h2 {
            color: #2d3748;
        }

        body.light-mode #detalhesModal .modal-content::-webkit-scrollbar-track {
            background: #f7fafc;
        }

        body.light-mode #detalhesModal .modal-content::-webkit-scrollbar-thumb {
            background: #e2e8f0;
        }

        body.light-mode #detalhesModal .modal-content::-webkit-scrollbar-thumb:hover {
            background: #cbd5e0;
        }

        /* CSS para modal de detalhes do frete */
        #detalhesModal .frete-details-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        #detalhesModal .detail-section {
            background: #2d3748;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        #detalhesModal .detail-section h3 {
            margin: 0 0 12px 0;
            color: #667eea;
            font-size: 1rem;
            font-weight: 600;
        }

        #detalhesModal .detail-item {
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            gap: 1rem !important;
            padding: 8px 0 !important;
            background-color: transparent !important;
            border-radius: 0 !important;
            border-bottom: 1px solid #4a5568 !important;
            font-size: 0.9rem !important;
            word-break: normal !important;
        }

        #detalhesModal .detail-item:last-child {
            border-bottom: none !important;
        }

        #detalhesModal .detail-item strong {
            color: #a0aec0 !important;
            font-weight: 500 !important;
            min-width: 140px !important;
        }

        #detalhesModal .detail-item span {
            color: #e2e8f0 !important;
            text-align: right !important;
            flex: 1 !important;
        }

        #detalhesModal .detail-item i {
            display: none !important;
        }

        /* Modo claro para seções de detalhes do modal */
        body.light-mode #detalhesModal .detail-section {
            background: #f7fafc;
            border-left-color: #667eea;
        }

        body.light-mode #detalhesModal .detail-section h3 {
            color: #667eea;
        }

        body.light-mode #detalhesModal .detail-item {
            border-bottom-color: #e2e8f0 !important;
        }

        body.light-mode #detalhesModal .detail-item strong {
            color: #4a5568 !important;
        }

        body.light-mode #detalhesModal .detail-item span {
            color: #2d3748 !important;
        }

        .status-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            white-space: nowrap;
            max-width: fit-content;
        }

        /* Estilos específicos para status badges no modo escuro */
        .status-solicitado {
            background-color: #FED7D7;
            color: #C53030;
        }

        .status-aceito {
            background-color: #BEE3F8;
            color: #2B6CB0;
        }

        .status-em_transito {
            background-color: #FEF5E7;
            color: #DD6B20;
        }

        .status-entregue {
            background-color: #C6F6D5;
            color: #2F855A;
        }

        .status-cancelado {
            background-color: #FED7D7;
            color: #E53E3E;
        }

        /* Modo escuro - manter cores de fundo mas forçar texto preto */
        body:not(.light-mode) .status-solicitado {
            background-color: #FED7D7;
            color: #000000 !important;
        }

        body:not(.light-mode) .status-aceito {
            background-color: #BEE3F8;
            color: #000000 !important;
        }

        body:not(.light-mode) .status-em_transito {
            background-color: #FEF5E7;
            color: #000000 !important;
        }

        body:not(.light-mode) .status-entregue {
            background-color: #C6F6D5;
            color: #000000 !important;
        }

        body:not(.light-mode) .status-cancelado {
            background-color: #FED7D7;
            color: #000000 !important;
        }

        /* Estilos para rotas no modal de detalhes */
        #detalhesModal .route-info {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        #detalhesModal .route-point {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        #detalhesModal .route-icon {
            font-size: 1.2rem !important;
            margin-top: 2px;
        }
        
        #detalhesModal .route-icon.origin {
            color: #48bb78;
        }
        
        #detalhesModal .route-icon.destination {
            color: #e53e3e;
        }

        #detalhesModal .route-details {
            flex: 1;
        }

        #detalhesModal .route-details strong {
            color: #e2e8f0;
            display: block;
            margin-bottom: 4px;
        }

        #detalhesModal .route-details small {
            color: #a0aec0;
            font-size: 0.85rem;
        }

        #detalhesModal .route-arrow {
            display: flex;
            justify-content: center;
            color: #667eea;
            font-size: 1.2rem;
            margin: 5px 0;
        }

        body.light-mode #detalhesModal .route-details strong {
            color: #2d3748;
        }

        body.light-mode #detalhesModal .route-details small {
            color: #4a5568;
        }
    </style>

    <!-- Modal para Ver Detalhes -->
    <div id="detalhesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Detalhes do Frete</h2>
                <span class="close" onclick="closeModal('detalhesModal')">&times;</span>
            </div>
            <div class="modal-body" id="detalhesContent">
                <!-- Conteúdo será preenchido dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Modal para Editar Frete -->
    <div id="editarModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Editar Frete</h2>
                <span class="close" onclick="closeModal('editarModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editarFreteForm">
                    <!-- Status editing removed: status must be changed via role-specific endpoints -->
                    <div class="form-group">
                        <label for="editMotorista">Motorista:</label>
                        <select id="editMotorista" name="motorista_id">
                            <option value="">Selecionar motorista</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editDataColeta">Data de Coleta:</label>
                        <input type="datetime-local" id="editDataColeta" name="data_coleta" required>
                    </div>
                    <div class="form-group">
                        <label for="editDataEntrega">Data de Entrega:</label>
                        <input type="datetime-local" id="editDataEntrega" name="data_entrega">
                    </div>
                </form>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal('editarModal')">Cancelar</button>
                <button type="submit" class="btn btn-primary" form="editarFreteForm">Salvar Alterações</button>
            </div>
        </div>
    </div>
</body>
</html>
