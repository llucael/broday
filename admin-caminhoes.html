<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento de Caminhões - Admin - Broday Transportes</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="logo">
                <span>Broday Transportes</span>
            </div>
            <nav class="nav">
                <a href="admin-dashboard.html" class="nav-link">Dashboard</a>
                <a href="admin-fretes.html" class="nav-link">Fretes</a>
                <a href="admin-usuarios.html" class="nav-link">Usuários</a>
                <a href="admin-motoristas.html" class="nav-link">Motoristas</a>
                <a href="admin-caminhoes.html" class="nav-link active">Caminhões</a>
                <a href="admin-configuracoes.html" class="nav-link">Configurações</a>
            </nav>
            <div class="header-buttons">
                <button class="theme-toggle" onclick="toggleTheme()" title="Alternar tema">
                    <i class="fas fa-sun"></i>
                </button>
                <span class="user-info" id="user-info">Bem-vindo, <span id="user-name">Admin</span></span>
                <button class="btn btn-secondary" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Sair
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Caminhões Section -->
            <section id="caminhoes" class="caminhoes-section active">
                <div class="section-header">
                    <h1>Gerenciamento de Caminhões</h1>
                    <div class="filters">
                        <button class="btn btn-success" onclick="showAddCaminhaoModal()">
                            <i class="fas fa-plus"></i>
                            Cadastrar Caminhão
                        </button>
                    </div>
                </div>

                <div class="caminhoes-list" id="caminhoes-list">
                    <!-- Caminhões serão carregados aqui -->
                </div>
            </section>
        </div>
    </main>

    <!-- Modal para Cadastrar/Editar Caminhão -->
    <div class="modal" id="caminhao-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Cadastrar Novo Caminhão</h3>
                <button class="close-btn" onclick="closeCaminhaoModal()">&times;</button>
            </div>
            <form class="caminhao-form" id="caminhao-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="caminhao-modelo">Modelo *</label>
                        <input type="text" id="caminhao-modelo" name="modelo" required>
                    </div>
                    <div class="form-group">
                        <label for="caminhao-ano">Ano *</label>
                        <input type="number" id="caminhao-ano" name="ano" min="1900" max="2030" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="caminhao-placa">Placa *</label>
                        <input type="text" id="caminhao-placa" name="placa" required placeholder="ABC-1234">
                    </div>
                    <div class="form-group">
                        <label for="caminhao-motorista">Motorista</label>
                        <select id="caminhao-motorista" name="motorista_id">
                            <option value="">Selecionar motorista</option>
                        </select>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-primary" onclick="closeCaminhaoModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="submit-btn">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirmação de Exclusão -->
    <div class="modal" id="delete-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirmar Exclusão</h3>
                <button class="close-btn" onclick="closeDeleteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir este caminhão?</p>
                <p class="warning-text">Esta ação não pode ser desfeita.</p>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">Excluir</button>
            </div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        let caminhoes = [];
        let motoristas = [];
        let editingCaminhaoId = null;
        let deleteCaminhaoId = null;

        // Carregar dados iniciais
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM carregado, inicializando admin-caminhoes');
            try {
                loadUserData();
                loadCaminhoes();
                loadMotoristas();
                setupPlacaFormatting();
                console.log('Inicialização concluída com sucesso');
            } catch (error) {
                console.error('Erro na inicialização:', error);
            }
        });

        // Carregar dados do usuário
        function loadUserData() {
            const user = getCurrentUser();
            if (user) {
                document.getElementById('user-name').textContent = user.nome || user.email;
            }
        }

        // Carregar caminhões
        async function loadCaminhoes() {
            try {
                const response = await api.getAllCaminhoes();
                if (response.success) {
                    caminhoes = response.data.caminhoes;
                    renderCaminhoes();
                } else {
                    showNotification('Erro ao carregar caminhões: ' + response.message, 'error');
                }
            } catch (error) {
                console.error('Erro ao carregar caminhões:', error);
                showNotification('Erro ao carregar caminhões', 'error');
            }
        }

        // Carregar motoristas para seleção
        async function loadMotoristas() {
            try {
                console.log('Carregando motoristas...');
                console.log('API object:', api);
                console.log('getMotoristas function:', api.getMotoristas);
                
                // Teste direto da API
                const testResponse = await fetch('http://localhost:3000/api/caminhoes/motoristas');
                console.log('Teste direto da API - Status:', testResponse.status);
                const testData = await testResponse.json();
                console.log('Teste direto da API - Dados completos:', testData);
                console.log('Teste direto da API - success:', testData.success);
                console.log('Teste direto da API - data:', testData.data);
                console.log('Teste direto da API - data length:', testData.data ? testData.data.length : 'undefined');
                
                const response = await api.getMotoristas();
                console.log('Resposta da API via api.getMotoristas():', response);
                console.log('Resposta - success:', response ? response.success : 'undefined');
                console.log('Resposta - data:', response ? response.data : 'undefined');
                
                if (response && response.success && response.data) {
                    motoristas = response.data;
                    console.log('Motoristas carregados:', motoristas);
                    console.log('Tipo de motoristas:', typeof motoristas);
                    console.log('É array?', Array.isArray(motoristas));
                    updateMotoristaSelect();
                } else {
                    console.error('Erro na resposta da API:', response ? response.message : 'Resposta inválida');
                    console.error('Response object:', response);
                }
            } catch (error) {
                console.error('Erro ao carregar motoristas:', error);
                console.error('Stack trace:', error.stack);
            }
        }

        // Atualizar select de motoristas
        function updateMotoristaSelect() {
            const select = document.getElementById('caminhao-motorista');
            if (!select) {
                console.error('Select de motorista não encontrado');
                return;
            }
            
            select.innerHTML = '<option value="">Selecionar motorista</option>';
            console.log('Atualizando select com', motoristas ? motoristas.length : 0, 'motoristas');
            
            if (motoristas && motoristas.length > 0) {
                motoristas.forEach(motorista => {
                    const option = document.createElement('option');
                    option.value = motorista.id;
                    option.textContent = `${motorista.nome || motorista.email}`;
                    select.appendChild(option);
                });
                console.log('Select atualizado com sucesso');
            } else {
                console.log('Nenhum motorista carregado ainda');
            }
        }

        // Renderizar caminhões
        function renderCaminhoes() {
            const container = document.getElementById('caminhoes-list');
            
            if (caminhoes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-truck"></i>
                        <h3>Nenhum caminhão cadastrado</h3>
                        <p>Clique em "Cadastrar Caminhão" para adicionar o primeiro caminhão.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = caminhoes.map(caminhao => `
                <div class="caminhao-card">
                    <div class="caminhao-info">
                        <h3 class="placa-destaque">${formatPlaca(caminhao.placa)}</h3>
                        <p><i class="fas fa-truck"></i> ${caminhao.modelo}</p>
                        <p><i class="fas fa-calendar"></i> Ano: ${caminhao.ano}</p>
                        <p><i class="fas fa-user"></i> Motorista: ${caminhao.motorista ? (caminhao.motorista.nome || caminhao.motorista.email) : 'Não atribuído'}</p>
                        <p><i class="fas fa-calendar"></i> Cadastrado em: ${new Date(caminhao.created_at).toLocaleDateString('pt-BR')}</p>
                    </div>
                    <div class="caminhao-actions">
                        <button class="btn btn-sm btn-primary" onclick="editCaminhao(${caminhao.id})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCaminhao(${caminhao.id})" title="Deletar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Formatar placa
        function formatPlaca(placa) {
            if (!placa) return '';
            // Formatar placa no padrão ABC-1234 ou ABC1D23
            const cleanPlaca = placa.replace(/[^A-Za-z0-9]/g, '');
            if (cleanPlaca.length === 7) {
                // Formato antigo ABC-1234
                return cleanPlaca.substring(0, 3) + '-' + cleanPlaca.substring(3);
            }
            return placa.toUpperCase();
        }

        // Configurar formatação automática da placa
        function setupPlacaFormatting() {
            console.log('Configurando formatação da placa');
            const placaInput = document.getElementById('caminhao-placa');
            if (placaInput) {
                placaInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
                    if (value.length > 3) {
                        value = value.substring(0, 3) + '-' + value.substring(3, 7);
                    }
                    e.target.value = value;
                });
                console.log('Formatação da placa configurada com sucesso');
            } else {
                console.error('Campo de placa não encontrado');
            }
        }

        // Mostrar modal de adicionar caminhão
        function showAddCaminhaoModal() {
            console.log('Tentando abrir modal de adicionar caminhão');
            try {
                editingCaminhaoId = null;
                document.getElementById('modal-title').textContent = 'Cadastrar Novo Caminhão';
                document.getElementById('submit-btn').textContent = 'Salvar';
                document.getElementById('caminhao-form').reset();
                
                // Atualizar dropdown de motoristas
                updateMotoristaSelect();
                
                document.getElementById('caminhao-modal').style.display = 'flex';
                console.log('Modal de adicionar caminhão aberto com sucesso');
            } catch (error) {
                console.error('Erro ao abrir modal de adicionar caminhão:', error);
            }
        }

        // Editar caminhão
        function editCaminhao(id) {
            console.log('Tentando abrir modal de editar caminhão, ID:', id);
            try {
                const caminhao = caminhoes.find(c => c.id === id);
                if (!caminhao) {
                    console.error('Caminhão não encontrado com ID:', id);
                    return;
                }

                editingCaminhaoId = id;
                document.getElementById('modal-title').textContent = 'Editar Caminhão';
                document.getElementById('submit-btn').textContent = 'Atualizar';
                
                // Atualizar dropdown de motoristas primeiro
                updateMotoristaSelect();
                
                // Preencher formulário
                document.getElementById('caminhao-modelo').value = caminhao.modelo || '';
                document.getElementById('caminhao-ano').value = caminhao.ano || '';
                document.getElementById('caminhao-placa').value = caminhao.placa || '';
                
                // Aguardar um pouco para garantir que o select foi atualizado
                setTimeout(() => {
                    document.getElementById('caminhao-motorista').value = caminhao.motorista_id || '';
                }, 100);
                
                document.getElementById('caminhao-modal').style.display = 'flex';
                console.log('Modal de editar caminhão aberto com sucesso');
            } catch (error) {
                console.error('Erro ao abrir modal de editar caminhão:', error);
            }
        }

        // Fechar modal de caminhão
        function closeCaminhaoModal() {
            document.getElementById('caminhao-modal').style.display = 'none';
            editingCaminhaoId = null;
        }

        // Deletar caminhão
        function deleteCaminhao(id) {
            deleteCaminhaoId = id;
            document.getElementById('delete-modal').style.display = 'flex';
        }

        // Fechar modal de exclusão
        function closeDeleteModal() {
            document.getElementById('delete-modal').style.display = 'none';
            deleteCaminhaoId = null;
        }

        // Confirmar exclusão
        async function confirmDelete() {
            if (!deleteCaminhaoId) return;

            try {
                const response = await api.deleteCaminhao(deleteCaminhaoId);
                if (response.success) {
                    showNotification('Caminhão excluído com sucesso!', 'success');
                    loadCaminhoes();
                } else {
                    showNotification('Erro ao excluir caminhão: ' + response.message, 'error');
                }
            } catch (error) {
                console.error('Erro ao excluir caminhão:', error);
                showNotification('Erro ao excluir caminhão', 'error');
            }

            closeDeleteModal();
        }

        // Submeter formulário
        document.getElementById('caminhao-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = {
                modelo: document.getElementById('caminhao-modelo').value,
                ano: parseInt(document.getElementById('caminhao-ano').value),
                placa: document.getElementById('caminhao-placa').value.toUpperCase(),
                motorista_id: document.getElementById('caminhao-motorista').value || null
            };

            try {
                let response;
                if (editingCaminhaoId) {
                    response = await api.updateCaminhao(editingCaminhaoId, formData);
                } else {
                    response = await api.createCaminhao(formData);
                }

                if (response.success) {
                    showNotification(
                        editingCaminhaoId ? 'Caminhão atualizado com sucesso!' : 'Caminhão cadastrado com sucesso!', 
                        'success'
                    );
                    closeCaminhaoModal();
                    loadCaminhoes();
                } else {
                    showNotification('Erro: ' + response.message, 'error');
                }
            } catch (error) {
                console.error('Erro ao salvar caminhão:', error);
                showNotification('Erro ao salvar caminhão', 'error');
            }
        });

        // Função para alternar tema
        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const isLightMode = document.body.classList.contains('light-mode');
            localStorage.setItem('theme', isLightMode ? 'light' : 'dark');
            
            // Trocar ícone do toggle
            const toggleIcon = document.querySelector('.theme-toggle i');
            if (toggleIcon) {
                if (isLightMode) {
                    toggleIcon.className = 'fas fa-moon';
                    toggleIcon.parentElement.title = 'Alternar para modo escuro';
                } else {
                    toggleIcon.className = 'fas fa-sun';
                    toggleIcon.parentElement.title = 'Alternar para modo claro';
                }
            }
        }
        
        // Carregar tema salvo
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme');
            const toggleIcon = document.querySelector('.theme-toggle i');
            
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
                if (toggleIcon) {
                    toggleIcon.className = 'fas fa-moon';
                    toggleIcon.parentElement.title = 'Alternar para modo escuro';
                }
            } else {
                if (toggleIcon) {
                    toggleIcon.className = 'fas fa-sun';
                    toggleIcon.parentElement.title = 'Alternar para modo claro';
                }
            }
        });

        // Função de logout
        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        }


        // Função para mostrar notificações
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }, 3000);
        }
    </script>

    <style>
        /* Corrigir espaçamento da navegação */
        .header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
        }
        
        .nav {
            display: flex;
            gap: 2rem;
            margin: 0 1rem;
        }

        /* Estilos específicos para caminhões */
        .caminhoes-section {
            padding: 2rem 0;
        }

        .caminhoes-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 2rem;
        }

        .caminhao-card {
            background: #2D3748;
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid #4A5568;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .caminhao-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border-color: #63B3ED;
        }

        .caminhao-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #4A5568;
        }

        .placa-destaque {
            font-size: 1.2rem;
            font-weight: bold;
            color: #63B3ED;
            margin: 0;
            letter-spacing: 1px;
        }

        .caminhao-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            justify-content: flex-end;
            margin-top: 1rem;
        }

        .caminhao-info {
            flex: 1;
        }

        .caminhao-info h3 {
            color: #63B3ED;
            margin-bottom: 0.5rem;
            font-size: 1.2rem;
        }

        .caminhao-info p {
            margin-bottom: 0.3rem;
            color: #E2E8F0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .caminhao-info i {
            color: #63B3ED;
            width: 16px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #E2E8F0;
            margin-bottom: 0.3rem;
        }

        .info-item i {
            color: #63B3ED;
            width: 16px;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            color: var(--primary-color);
        }

        .empty-state h3 {
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }

        /* CSS para modais de caminhões - igual aos modais de motoristas */
        #caminhao-modal .modal-content,
        #delete-modal .modal-content {
            background: #1a202c;
            border: 2px solid #4a5568;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
        }

        #caminhao-modal .modal-header,
        #delete-modal .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 2px solid #4a5568;
            background: #2d3748;
        }

        #caminhao-modal .modal-header h3,
        #delete-modal .modal-header h3 {
            margin: 0;
            color: #ffffff;
            font-size: 1.5rem;
            font-weight: 600;
        }

        #caminhao-modal .close-btn,
        #delete-modal .close-btn {
            background: none;
            border: none;
            color: #a0aec0;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        #caminhao-modal .close-btn:hover,
        #delete-modal .close-btn:hover {
            color: #ffffff;
            background: #4a5568;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #e2e8f0;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #4a5568;
            border-radius: 6px;
            background: #2d3748;
            color: #e2e8f0;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: #374151;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding: 20px;
            border-top: 2px solid #4a5568;
            background: #2d3748;
            margin-top: auto;
            margin-left: -20px;
            margin-right: -20px;
            margin-bottom: -20px;
        }

        .modal-body {
            padding: 20px;
        }

        .caminhao-form {
            padding: 20px;
            flex: 1;
        }

        .modal-body p {
            margin: 0 0 1rem 0;
            color: #e2e8f0;
        }

        .warning-text {
            color: #fc8181;
            font-weight: 500;
        }

        /* Modo claro para modais de caminhões */
        body.light-mode #caminhao-modal .modal-content,
        body.light-mode #delete-modal .modal-content {
            background: #ffffff;
            border: 2px solid #e2e8f0;
        }

        body.light-mode #caminhao-modal .modal-header,
        body.light-mode #delete-modal .modal-header {
            background: #f7fafc;
            border-bottom: 2px solid #e2e8f0;
        }

        body.light-mode #caminhao-modal .modal-header h3,
        body.light-mode #delete-modal .modal-header h3 {
            color: #2d3748;
        }

        body.light-mode #caminhao-modal .close-btn,
        body.light-mode #delete-modal .close-btn {
            color: #718096;
        }

        body.light-mode #caminhao-modal .close-btn:hover,
        body.light-mode #delete-modal .close-btn:hover {
            color: #2d3748;
            background: #e2e8f0;
        }

        body.light-mode .form-group label {
            color: #4a5568;
        }

        body.light-mode .form-group input,
        body.light-mode .form-group select {
            background: #ffffff;
            border: 2px solid #e2e8f0;
            color: #2d3748;
        }

        body.light-mode .form-group input:focus,
        body.light-mode .form-group select:focus {
            border-color: #667eea;
            background: #f7fafc;
        }

        body.light-mode .form-actions {
            border-top: 2px solid #e2e8f0;
            background: #f7fafc;
        }

        body.light-mode .modal-body p {
            color: #4a5568;
        }

        body.light-mode .warning-text {
            color: #e53e3e;
        }

        /* Modo claro para cards de caminhão */
        body.light-mode .caminhao-card {
            background: #F7FAFC;
            border-color: #E2E8F0;
        }

        body.light-mode .caminhao-card:hover {
            border-color: #468ADC;
            box-shadow: 0 4px 12px rgba(70, 138, 220, 0.2);
        }

        body.light-mode .placa-destaque {
            color: #468ADC;
        }

        body.light-mode .caminhao-info p {
            color: #2D3748;
        }

        body.light-mode .caminhao-info i {
            color: #468ADC;
        }

        body.light-mode .info-item {
            color: #2D3748;
        }

        body.light-mode .info-item i {
            color: #468ADC;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .caminhoes-list {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .caminhao-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .caminhao-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }
    </style>
</body>
</html>
