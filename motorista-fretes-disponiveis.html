<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fretes Disponíveis - Motorista - Broday Transportes</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
                    <div class="logo">
            <span>Broday Transportes</span>
        </div>
            <nav class="nav">
                <a href="motorista-dashboard.html" class="nav-link">Dashboard</a>
                <a href="motorista-fretes-disponiveis.html" class="nav-link active">Fretes Disponíveis</a>
                <a href="motorista-meus-fretes.html" class="nav-link">Meus Fretes</a>
                <a href="motorista-perfil.html" class="nav-link">Perfil</a>
            </nav>
            <div class="header-buttons">
                <button class="theme-toggle" onclick="toggleTheme()" title="Alternar tema">
                    <i class="fas fa-sun"></i>
                </button>
                <span class="user-info" id="user-info">Bem-vindo, <span id="user-name">Motorista</span></span>
                <button class="btn btn-secondary" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Sair
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Fretes Disponíveis Section -->
            <section id="fretes-disponiveis" class="fretes-disponiveis-section active">
                <div class="section-header">
                    <h1>Fretes Disponíveis</h1>
                </div>

                <div class="fretes-list" id="fretes-disponiveis-list">
                    <!-- Fretes disponíveis serão carregados aqui -->
                </div>
            </section>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Broday Transportes</h3>
                    <p>Conectando embarcadores e transportadores de forma inteligente e eficiente.</p>
                </div>
                
                <div class="footer-section">
                    <h4>Navegação</h4>
                    <div class="footer-nav">
                        <a href="#dashboard">Dashboard</a>
                        <a href="#fretes-disponiveis">Fretes Disponíveis</a>
                        <a href="#meus-fretes">Meus Fretes</a>
                        <a href="#perfil">Perfil</a>
                    </div>
                </div>
                
                <div class="footer-section">
                    <h4>Contato</h4>
                    <div class="contact-info">
                        <p><i class="fas fa-map-marker-alt"></i> Rua Cambara, 268 - Nova Russia</p>
                        <p>Ponta Grossa - PR, 84.053-060</p>
                        <p><i class="fas fa-phone"></i> (42) 99985-2606</p>
                        <p><i class="fas fa-envelope"></i> brodaytransportes@gmail.com</p>
                    </div>
                </div>
                
            </div>
            
            <div class="footer-legal">
                <div class="legal-info">
                    <p><strong>CNPJ:</strong> 58.893.054/0001-03</p>
                    <p><strong>Endereço:</strong> Rua Cambara, 268 - Nova Russia, Ponta Grossa - PR, 84.053-060</p>
                </div>
                <div class="copyright">
                    <p>© 2025 Broday Transportes. Todos os direitos reservados.</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="js/api.js"></script>
    <script>
        // Verificar se o usuário está logado
        if (!isLoggedIn()) {
            window.location.href = 'login.html';
        }

        // Verificar tipo de usuário
        if (getUserType() !== 'motorista') {
            window.location.href = 'login.html';
        }

        // Carregar dados do usuário
        document.addEventListener('DOMContentLoaded', function() {
            loadUserData();
            loadFretesDisponiveis();
        });

        function loadUserData() {
            const user = getCurrentUser();
            if (user) {
                document.getElementById('user-name').textContent = user.name || user.email;
            }
        }

        async function loadFretesDisponiveis() {
            try {
                const response = await api.getFretesDisponiveis(1, 50);
                
                if (response.success) {
                    let fretes = response.data.fretes;
                    const container = document.getElementById('fretes-disponiveis-list');
                    container.innerHTML = '';
                    
                    if (fretes.length === 0) {
                        container.innerHTML = '<p class="no-data">Nenhum frete disponível</p>';
                        return;
                    }
                    
                    // Os fretes já vêm ordenados do backend
                    
                    for (const frete of fretes) {
                        const freteCard = await createFreteDisponivelCard(frete);
                        container.appendChild(freteCard);
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar fretes disponíveis:', error);
                showNotification('Erro ao carregar fretes disponíveis', 'error');
            }
        }

        async function createFreteDisponivelCard(frete) {
            const card = document.createElement('div');
            card.className = 'frete-card';
            
            // Verificar se motorista já está em viagem
            const isMotoristaEmViagem = await checkMotoristaEmViagem();
            
            // Formatar origem e destino
            const origem = `${frete.origin_city}/${frete.origin_state}`;
            const destino = `${frete.destination_city}/${frete.destination_state}`;
            
            // Formatar data de coleta
            const dataColeta = frete.data_coleta ? new Date(frete.data_coleta).toLocaleDateString('pt-BR') : 'Não definida';
            
            // Formatar valor da carga
            const valorCarga = frete.cargo_value ? `R$ ${parseFloat(frete.cargo_value).toFixed(2).replace('.', ',')}` : 'A negociar';
            
            card.innerHTML = `
                <div class="frete-header">
                    <h3>${frete.codigo}</h3>
                    <span class="status status-${frete.status}">${getStatusText(frete.status)}</span>
                </div>
                <div class="frete-info">
                    <div class="frete-route">
                        <div class="route-point">
                            <i class="fas fa-map-marker-alt route-icon origin"></i>
                            <div class="route-details">
                                <strong>Origem:</strong> ${origem}
                                <small>${frete.origin_street}, ${frete.origin_number}</small>
                            </div>
                        </div>
                        <div class="route-arrow">
                            <i class="fas fa-arrow-right"></i>
                        </div>
                        <div class="route-point">
                            <i class="fas fa-map-marker-alt route-icon destination"></i>
                            <div class="route-details">
                                <strong>Destino:</strong> ${destino}
                                <small>${frete.destination_street}, ${frete.destination_number}</small>
                            </div>
                        </div>
                    </div>
                    <div class="frete-details">
                        <div class="detail-item">
                            <i class="fas fa-box"></i>
                            <span>${frete.cargo_type} (${frete.cargo_weight}kg)</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-dollar-sign"></i>
                            <span>${valorCarga}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-calendar"></i>
                            <span>Coleta: ${dataColeta}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-user"></i>
                            <span>Cliente: ${frete.cliente ? (frete.cliente.name || frete.cliente.email) : 'N/A'}</span>
                        </div>
                    </div>
                </div>
                <div class="frete-actions">
                    <button class="btn btn-sm btn-primary" onclick="viewFrete(${frete.id})">
                        <i class="fas fa-eye"></i>
                        Ver Detalhes
                    </button>
                    <button class="btn btn-sm ${isMotoristaEmViagem ? 'btn-disabled' : 'btn-success'}" 
                            onclick="${isMotoristaEmViagem ? 'showNotification("Você já está em viagem!", "error")' : `acceptFrete(${frete.id})`}"
                            ${isMotoristaEmViagem ? 'disabled' : ''}>
                        <i class="fas fa-check"></i>
                        ${isMotoristaEmViagem ? 'Indisponível' : 'Aceitar Frete'}
                    </button>
                </div>
            `;
            return card;
        }

        async function viewFrete(freteId) {
            try {
                const response = await api.getFreteById(freteId);
                if (response.success) {
                    const frete = response.data;
                    displayFreteDetails(frete);
                    openModal('freteDetailsModal');
                } else {
                    showNotification('Erro ao carregar detalhes do frete', 'error');
                }
            } catch (error) {
                console.error('Erro ao carregar detalhes:', error);
                showNotification('Erro ao carregar detalhes do frete', 'error');
            }
        }

        function displayFreteDetails(frete) {
            const content = document.getElementById('freteDetailsContent');
            const origem = `${frete.origin_city || 'N/A'}, ${frete.origin_state || 'N/A'}`;
            const destino = `${frete.destination_city || 'N/A'}, ${frete.destination_state || 'N/A'}`;
            const dataColeta = frete.data_coleta ? new Date(frete.data_coleta).toLocaleDateString('pt-BR') : 'N/A';
            const dataEntrega = frete.data_entrega ? new Date(frete.data_entrega).toLocaleDateString('pt-BR') : 'N/A';
            const valorCarga = frete.cargo_value ? `R$ ${parseFloat(frete.cargo_value).toLocaleString('pt-BR', {minimumFractionDigits: 2})}` : 'A negociar';
            
            content.innerHTML = `
                <div class="frete-details-container">
                    <div class="detail-section">
                        <h3>Informações do Frete</h3>
                        <div class="detail-item">
                            <strong>Código:</strong>
                            <span>${frete.codigo || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Status:</strong>
                            <span class="status-badge status-${frete.status}">${getStatusText(frete.status)}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Cliente:</strong>
                            <span>${frete.cliente ? (frete.cliente.name || frete.cliente.email) : 'N/A'}</span>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>Rota</h3>
                        <div class="route-info">
                            <div class="route-point">
                                <i class="fas fa-map-marker-alt route-icon origin"></i>
                                <div class="route-details">
                                    <strong>Origem:</strong> ${origem}
                                    <small>${frete.origin_street || 'N/A'}, ${frete.origin_number || 'N/A'}</small>
                                </div>
                            </div>
                            <div class="route-arrow">
                                <i class="fas fa-arrow-right"></i>
                            </div>
                            <div class="route-point">
                                <i class="fas fa-map-marker-alt route-icon destination"></i>
                                <div class="route-details">
                                    <strong>Destino:</strong> ${destino}
                                    <small>${frete.destination_street || 'N/A'}, ${frete.destination_number || 'N/A'}</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>Carga</h3>
                        <div class="detail-item">
                            <strong>Tipo:</strong>
                            <span>${frete.cargo_type || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Peso:</strong>
                            <span>${frete.cargo_weight ? parseFloat(frete.cargo_weight).toLocaleString('pt-BR') + ' kg' : 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Valor:</strong>
                            <span>${valorCarga}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Dimensões:</strong>
                            <span>${frete.cargo_dimensions || 'N/A'}</span>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>Contatos</h3>
                        <div class="detail-item">
                            <strong>Remetente:</strong>
                            <span>${frete.sender_name || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Telefone Remetente:</strong>
                            <span>${frete.sender_phone || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Destinatário:</strong>
                            <span>${frete.recipient_name || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Telefone Destinatário:</strong>
                            <span>${frete.recipient_phone || 'N/A'}</span>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>Datas</h3>
                        <div class="detail-item">
                            <strong>Data de Coleta:</strong>
                            <span>${dataColeta}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Data de Entrega:</strong>
                            <span>${dataEntrega}</span>
                        </div>
                    </div>

                    ${frete.observacoes ? `
                    <div class="detail-section">
                        <h3>Observações</h3>
                        <div class="detail-item" style="justify-content: flex-start;">
                            <span style="text-align: left;">${frete.observacoes}</span>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        function getStatusText(status) {
            const statusMap = {
                'solicitado': 'Solicitado',
                'cotado': 'Cotado',
                'aceito': 'Aceito',
                'em_transito': 'Em Trânsito',
                'entregue': 'Entregue',
                'cancelado': 'Cancelado'
            };
            return statusMap[status] || status;
        }

        async function checkMotoristaEmViagem() {
            try {
                // Buscar todos os fretes do motorista para verificar se há algum em trânsito
                const response = await api.getFretesByMotorista(1, 100);
                if (response.success) {
                    const fretes = response.data.fretes;
                    return fretes.some(f => f.status === 'em_transito');
                }
                return false;
            } catch (error) {
                console.error('Erro ao verificar status do motorista:', error);
                return false;
            }
        }

        async function acceptFrete(freteId) {
            try {
                const response = await api.acceptFrete(freteId);
                if (response.success) {
                    showNotification('Frete aceito com sucesso!', 'success');
                    loadFretesDisponiveis();
                }
            } catch (error) {
                showNotification(error.message || 'Erro ao aceitar frete', 'error');
            }
        }


        // Funções de modal
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        // Fechar modal ao clicar fora dele
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
            });
        }

        // Função para mostrar notificações
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerText = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // Função para alternar tema
        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const isLightMode = document.body.classList.contains('light-mode');
            localStorage.setItem('theme', isLightMode ? 'light' : 'dark');
            
            // Trocar ícone do toggle
            const toggleIcon = document.querySelector('.theme-toggle i');
            if (toggleIcon) {
                if (isLightMode) {
                    toggleIcon.className = 'fas fa-moon';
                    toggleIcon.parentElement.title = 'Alternar para modo escuro';
                } else {
                    toggleIcon.className = 'fas fa-sun';
                    toggleIcon.parentElement.title = 'Alternar para modo claro';
                }
            }
        }
        
        // Carregar tema salvo
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme');
            const toggleIcon = document.querySelector('.theme-toggle i');
            
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
                if (toggleIcon) {
                    toggleIcon.className = 'fas fa-moon';
                    toggleIcon.parentElement.title = 'Alternar para modo escuro';
                }
            } else {
                if (toggleIcon) {
                    toggleIcon.className = 'fas fa-sun';
                    toggleIcon.parentElement.title = 'Alternar para modo claro';
                }
            }
        });
    </script>

    <!-- Modal para Detalhes do Frete -->
    <div id="freteDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Detalhes do Frete</h2>
                <span class="close" onclick="closeModal('freteDetailsModal')">&times;</span>
            </div>
            <div class="modal-body" id="freteDetailsContent">
                <!-- Conteúdo será preenchido dinamicamente -->
            </div>
        </div>
    </div>

    <style>
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: #1a202c;
            border: 2px solid #4a5568;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 12px;
            padding: 0;
            margin: 5% auto;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: #2d3748;
            border-bottom: 2px solid #4a5568;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            color: #ffffff;
            font-weight: 600;
            margin: 0;
            font-size: 1.5rem;
        }

        .close {
            color: #a0aec0;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #ffffff;
        }

        .modal-body {
            padding: 30px;
            color: #e2e8f0;
        }

        .frete-details-container {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .detail-section {
            background: #2d3748;
            padding: 25px 30px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            margin-bottom: 20px;
        }

        .detail-section h3 {
            margin: 0 0 15px 0;
            color: #667eea;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid #4a5568;
            margin: 0 10px;
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-item strong {
            color: #a0aec0;
            font-weight: 500;
            min-width: 120px;
        }

        .detail-item span {
            color: #e2e8f0;
            text-align: right;
            flex: 1;
        }

        .status-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            white-space: nowrap;
            max-width: fit-content;
        }

        .status-solicitado { background: #f6ad55; color: #744210; }
        .status-cotado { background: #4299e1; color: #1a365d; }
        .status-aceito { background: #48bb78; color: #1a202c; }
        .status-em_transito { background: #ed8936; color: #1a202c; }
        .status-entregue { background: #38a169; color: #1a202c; }
        .status-cancelado { background: #e53e3e; color: #1a202c; }

        .btn-disabled {
            background-color: #718096 !important;
            color: #a0aec0 !important;
            cursor: not-allowed !important;
            opacity: 0.6 !important;
        }

        .btn-disabled:hover {
            background-color: #718096 !important;
            transform: none !important;
        }

        .route-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }

        .route-point {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .route-icon {
            font-size: 1.2rem;
            width: 20px;
            text-align: center;
        }

        .route-icon.origin { color: #48bb78; }
        .route-icon.destination { color: #e53e3e; }

        .route-details {
            display: flex;
            flex-direction: column;
        }

        .route-details strong {
            color: #e2e8f0;
            font-size: 0.9rem;
        }

        .route-details small {
            color: #a0aec0;
            font-size: 0.8rem;
        }

        .route-arrow {
            color: #667eea;
            font-size: 1.2rem;
        }

        /* Scroll personalizado */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #667eea;
        }

        /* Modo claro */
        body.light-mode .modal-content {
            background-color: #ffffff;
        }

        body.light-mode .modal-body {
            color: #2d3748;
        }

        body.light-mode .detail-section {
            background: #f7fafc;
            border-left-color: #667eea;
        }

        body.light-mode .detail-section h3 {
            color: #667eea;
        }

        body.light-mode .detail-item {
            border-bottom-color: #e2e8f0;
        }

        body.light-mode .detail-item strong {
            color: #4a5568;
        }

        body.light-mode .detail-item span {
            color: #2d3748;
        }

        body.light-mode .route-details strong {
            color: #2d3748;
        }

        body.light-mode .route-details small {
            color: #4a5568;
        }

        /* Modal header no modo claro */
        body.light-mode .modal-header h2 {
            color: #ffffff;
        }

        body.light-mode .modal-content::-webkit-scrollbar-track {
            background: #f7fafc;
        }

        body.light-mode .modal-content::-webkit-scrollbar-thumb {
            background: #e2e8f0;
        }

        body.light-mode .modal-content::-webkit-scrollbar-thumb:hover {
            background: #cbd5e0;
        }
    </style>
</body>
</html>
