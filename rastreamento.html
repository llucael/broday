<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rastreamento - Broday Transportes</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="config/google-maps.js"></script>
    <script>
        // Carregar Google Maps dinamicamente
        function loadGoogleMapsScript() {
            return new Promise((resolve, reject) => {
                // Verificar se j√° est√° carregado
                if (window.google && window.google.maps) {
                    resolve();
                    return;
                }

                // Verificar se j√° existe um script carregando
                if (document.querySelector('script[src*="maps.googleapis.com"]')) {
                    // Aguardar o script existente carregar
                    const checkLoaded = setInterval(() => {
                        if (window.google && window.google.maps) {
                            clearInterval(checkLoaded);
                            resolve();
                        }
                    }, 100);
                    return;
                }

                // Criar e carregar o script
                const script = document.createElement('script');
                script.src = getGoogleMapsScriptUrl();
                script.async = true;
                script.defer = true;
                
                script.onload = () => {
                    console.log('Google Maps carregado com sucesso');
                    resolve();
                };
                
                script.onerror = () => {
                    console.error('Erro ao carregar Google Maps');
                    reject(new Error('Falha ao carregar Google Maps'));
                };
                
                document.head.appendChild(script);
            });
        }
    </script>
    <style>
        /* Estilos espec√≠ficos para rastreamento */
        .rastreamento-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .map-container {
            position: relative;
            height: 500px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .map {
            width: 100%;
            height: 100%;
        }

        .map-loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 1000;
        }

        .map-loading i {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .map-loading p {
            margin: 0;
            font-size: 1.1rem;
        }

        .frete-entregue-message {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .frete-entregue-message .message-content {
            text-align: center;
            color: white;
            padding: 2rem;
            max-width: 400px;
        }

        .frete-entregue-message i {
            font-size: 4rem;
            color: #48bb78;
            margin-bottom: 1rem;
        }

        .frete-entregue-message h3 {
            margin: 0 0 1rem 0;
            font-size: 1.5rem;
        }

        .frete-entregue-message p {
            margin: 0 0 2rem 0;
            opacity: 0.8;
            line-height: 1.5;
        }

        .frete-entregue-info {
            background: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
        }

        .frete-entregue-info h3 {
            color: #48bb78;
            margin: 0 0 1rem 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .frete-entregue-info p {
            color: #a0aec0;
            margin: 0;
        }

        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .map-controls .btn {
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #667eea;
            border: none;
            color: white;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .map-controls .btn:hover {
            background: #5a67d8;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .map-controls .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .rastreamento-info {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .info-card {
            background: #2d3748;
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid #4a5568;
        }

        .info-card h3 {
            margin: 0 0 1rem 0;
            color: #e2e8f0;
            font-size: 1.1rem;
        }

        .location-info p {
            margin: 0.5rem 0;
            color: #a0aec0;
            font-size: 0.9rem;
        }


        .time-info {
            color: #4299e1 !important;
            font-size: 0.8rem !important;
        }

        .location-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .tracking-status {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #4a5568;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-label {
            color: #a0aec0;
            font-size: 0.9rem;
        }

        .status-value {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .status-value.active {
            color: #48bb78;
        }

        .status-value.inactive {
            color: #e53e3e;
        }

        .status-value.viewing {
            color: #4299e1;
        }

        .movement-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #4a5568;
            font-size: 0.85rem;
        }

        .movement-item:last-child {
            border-bottom: none;
        }

        .movement-time {
            color: #a0aec0;
            flex: 1;
        }

        .movement-coords {
            color: #e2e8f0;
            flex: 1;
            text-align: right;
        }

        .no-data {
            text-align: center;
            color: #a0aec0;
            font-style: italic;
            padding: 2rem;
        }

        /* Modo claro */
        body.light-mode .info-card {
            background: #f7fafc;
            border-color: #e2e8f0;
        }

        body.light-mode .info-card h3 {
            color: #2d3748;
        }

        body.light-mode .location-info p {
            color: #4a5568;
        }

        body.light-mode .status-item {
            border-bottom-color: #e2e8f0;
        }

        body.light-mode .status-label {
            color: #4a5568;
        }

        body.light-mode .movement-item {
            border-bottom-color: #e2e8f0;
        }

        body.light-mode .movement-time {
            color: #4a5568;
        }

        body.light-mode .movement-coords {
            color: #2d3748;
        }

        body.light-mode .no-data {
            color: #4a5568;
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .rastreamento-content {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .map-container {
                height: 300px;
            }

            .location-buttons {
                flex-direction: row;
                flex-wrap: wrap;
            }

            .movement-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.25rem;
            }

            .movement-coords {
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="logo">
                <span>Broday Transportes</span>
            </div>
            <nav class="nav">
                <a href="#" id="back-link" class="nav-link">
                    <i class="fas fa-arrow-left"></i>
                    Voltar
                </a>
            </nav>
            <div class="header-buttons">
                <button class="theme-toggle" onclick="toggleTheme()" title="Alternar tema">
                    <i class="fas fa-sun"></i>
                </button>
                <span class="user-info" id="user-info">Bem-vindo, <span id="user-name">Usu√°rio</span></span>
                <button class="btn btn-secondary" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Sair
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Rastreamento Section -->
            <section id="rastreamento" class="rastreamento-section active">
                <div class="section-header">
                    <h1>Rastreamento em Tempo Real</h1>
                    <p>Acompanhe a localiza√ß√£o e hist√≥rico de movimenta√ß√µes do frete</p>
                </div>

                <!-- Frete Info -->
                <div class="frete-info-header" id="frete-info-header">
                    <div class="frete-card">
                        <div class="frete-header">
                            <h3 id="frete-titulo">Frete #</h3>
                            <span class="status" id="frete-status">Carregando...</span>
                        </div>
                        <div class="frete-info">
                            <p><strong>Origem:</strong> <span id="frete-origem">-</span></p>
                            <p><strong>Destino:</strong> <span id="frete-destino">-</span></p>
                            <p><strong>Motorista:</strong> <span id="frete-motorista">-</span></p>
                            <p><strong>Data:</strong> <span id="frete-data">-</span></p>
                        </div>
                    </div>
                </div>

                <div class="rastreamento-content">
                    <div class="map-container">
                        <div id="map" class="map"></div>
                        <div id="map-loading" class="map-loading">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Carregando mapa...</p>
                        </div>
                        <div class="map-controls">
                            <button class="btn btn-sm btn-primary" onclick="centralizarMapa()" title="Centralizar no motorista">
                                <i class="fas fa-crosshairs"></i>
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="alternarTipoMapa()" title="Alternar tipo de mapa">
                                <i class="fas fa-layer-group"></i>
                            </button>
                        </div>
                    </div>

                    <div class="rastreamento-info">
                        <div class="info-card">
                            <h3>Localiza√ß√£o Atual</h3>
                            <div class="location-info">
                            <p id="localizacao-atual">Carregando...</p>
                                <p id="ultima-atualizacao" class="time-info">√öltima atualiza√ß√£o: --</p>
                            </div>
                            <div class="location-buttons">
                                <button class="btn btn-primary" onclick="atualizarLocalizacao()" id="btn-atualizar">
                                <i class="fas fa-location-arrow"></i>
                                Atualizar Localiza√ß√£o
                            </button>
                            <button class="btn btn-success" onclick="testarRastreamento()" id="btn-testar" style="margin-top: 10px;">
                                <i class="fas fa-play"></i>
                                Testar Rastreamento
                            </button>
                            </div>
                        </div>

                        <div class="info-card">
                            <h3>Status do Rastreamento</h3>
                            <div class="tracking-status">
                                <div class="status-item">
                                    <span class="status-label">Status:</span>
                                    <span class="status-value" id="status-rastreamento">Inativo</span>
                                </div>
                                <div class="status-item">
                                    <span class="status-label">Intervalo:</span>
                                    <span class="status-value" id="intervalo-rastreamento">--</span>
                                </div>
                                <div class="status-item">
                                    <span class="status-label">Pr√≥xima atualiza√ß√£o:</span>
                                    <span class="status-value" id="proxima-atualizacao">--</span>
                                </div>
                            </div>
                        </div>

                        <div class="info-card">
                            <h3>Hist√≥rico de Movimenta√ß√µes</h3>
                            <div class="movimentacoes-list" id="movimentacoes-list">
                                <!-- Hist√≥rico ser√° carregado aqui -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Broday Transportes</h3>
                    <p>Conectando embarcadores e transportadores de forma inteligente e eficiente.</p>
                </div>
                
                <div class="footer-section">
                    <h4>Navega√ß√£o</h4>
                    <div class="footer-nav">
                        <a href="#" id="footer-back-link">Voltar</a>
                    </div>
                </div>
                
                <div class="footer-section">
                    <h4>Contato</h4>
                    <div class="contact-info">
                        <p><i class="fas fa-map-marker-alt"></i> Rua Cambara, 268 - Nova Russia</p>
                        <p>Ponta Grossa - PR, 84.053-060</p>
                        <p><i class="fas fa-phone"></i> (42) 99985-2606</p>
                        <p><i class="fas fa-envelope"></i> brodaytransportes@gmail.com</p>
                    </div>
                </div>
                
            </div>
            
            <div class="footer-legal">
                <div class="legal-info">
                    <p><strong>CNPJ:</strong> 58.893.054/0001-03</p>
                    <p><strong>Endere√ßo:</strong> Rua Cambara, 268 - Nova Russia, Ponta Grossa - PR, 84.053-060</p>
                </div>
                <div class="copyright">
                    <p>¬© 2025 Broday Transportes. Todos os direitos reservados.</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="js/api.js"></script>
    <script>
        // Vari√°veis globais
        let map;
        let marker;
        let polyline;
        let trackingInterval = null;
        let isTracking = false;
        let freteId;
        let currentLocation = null;
        let trackingPath = [];
        let proximaUpdateInterval = null;
        let clienteUpdateInterval = null;

        // Verificar se o usu√°rio est√° logado
        if (!isLoggedIn()) {
            window.location.href = 'login.html';
        }

        // Obter ID do frete da URL
        const urlParams = new URLSearchParams(window.location.search);
        freteId = urlParams.get('id') || urlParams.get('frete');

        // Carregar dados do usu√°rio
        document.addEventListener('DOMContentLoaded', function() {
            loadUserData();
            loadFreteData();
            setupNavigation();
            loadGoogleMaps();
            checkTrackingStatus();
            
            // Verifica√ß√£o adicional ap√≥s 5 segundos para garantir que o rastreamento seja iniciado
            setTimeout(() => {
                console.log('=== VERIFICA√á√ÉO ADICIONAL AP√ìS 5s ===');
                console.log('isTracking:', isTracking);
                console.log('trackingInterval:', trackingInterval);
                
                const userType = getUserType();
                if (userType === 'motorista' && !isTracking) {
                    console.log('‚ö†Ô∏è Motorista detectado mas rastreamento n√£o ativo, for√ßando in√≠cio...');
                    isTracking = true;
                    iniciarRastreamentoAutomatico();
                }
            }, 5000);
        });

        // Carregar Google Maps dinamicamente
        async function loadGoogleMaps() {
            try {
                console.log('Carregando Google Maps...');
                await loadGoogleMapsScript();
                
                // Aguardar um pouco para garantir que tudo esteja carregado
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                console.log('Google Maps carregado, inicializando mapa...');
                initializeMap();
            } catch (error) {
                console.error('Erro ao carregar Google Maps:', error);
                showNotification('Erro ao carregar Google Maps: ' + error.message, 'error');
                
                // Esconder indicador de carregamento em caso de erro
                const loadingElement = document.getElementById('map-loading');
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }
            }
        }

        function loadUserData() {
            const user = getCurrentUser();
            if (user) {
                document.getElementById('user-name').textContent = user.name || user.email;
            }
        }

        function setupNavigation() {
            const userType = getUserType();
            let backUrl = '#';
            
            if (userType === 'cliente') {
                backUrl = 'cliente-dashboard.html';
            } else if (userType === 'admin') {
                backUrl = 'admin-dashboard.html';
            } else if (userType === 'motorista') {
                backUrl = 'motorista-dashboard.html';
            }
            
            document.getElementById('back-link').href = backUrl;
            document.getElementById('footer-back-link').href = backUrl;
        }

        async function loadFreteData() {
            if (!freteId) {
                showNotification('ID do frete n√£o fornecido', 'error');
                return;
            }

            try {
                const response = await api.getFreteById(freteId);
                if (response.success) {
                    const frete = response.data;
                    displayFreteInfo(frete);
                    loadTrackingData();
                } else {
                    showNotification('Erro ao carregar dados do frete', 'error');
                }
            } catch (error) {
                console.error('Erro ao carregar frete:', error);
                showNotification('Erro ao carregar dados do frete', 'error');
            }
        }

        function displayFreteInfo(frete) {
            console.log('Dados do frete recebidos:', frete);
            document.getElementById('frete-titulo').textContent = `Frete #${frete.codigo || frete.id}`;
            document.getElementById('frete-status').textContent = getStatusText(frete.status);
            document.getElementById('frete-origem').textContent = `${frete.sender_name || 'N/A'} - ${frete.origin_cep || 'N/A'}`;
            document.getElementById('frete-destino').textContent = `${frete.recipient_name || 'N/A'}`;
            document.getElementById('frete-motorista').textContent = frete.motorista?.email || 'N√£o atribu√≠do';
            document.getElementById('frete-data').textContent = frete.data_coleta ? new Date(frete.data_coleta).toLocaleDateString('pt-BR') : 'N/A';
        }

        function getStatusText(status) {
            const statusMap = {
                'pendente': 'Pendente',
                'aceito': 'Aceito',
                'em_transito': 'Em Tr√¢nsito',
                'entregue': 'Entregue',
                'cancelado': 'Cancelado'
            };
            return statusMap[status] || status;
        }

        // Configura√ß√£o do mapa
        function getMapConfig() {
            // Coordenadas padr√£o (S√£o Paulo)
            const defaultCenter = {
                lat: -23.5505,
                lng: -46.6333
            };

            // Se temos uma localiza√ß√£o atual, usar ela
            if (currentLocation) {
                return {
                    center: currentLocation,
                    zoom: 15,
                    mapTypeId: google.maps.MapTypeId.ROADMAP,
                    styles: [
                        {
                            featureType: 'poi',
                            elementType: 'labels',
                            stylers: [{ visibility: 'off' }]
                        }
                    ]
                };
            }

            // Configura√ß√£o padr√£o
            return {
                center: defaultCenter,
                zoom: 10,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                styles: [
                    {
                        featureType: 'poi',
                        elementType: 'labels',
                        stylers: [{ visibility: 'off' }]
                    }
                ]
            };
        }

        // Inicializar Google Maps
        function initializeMap() {
            try {
                console.log('Inicializando mapa...');
                
                // Verificar se o Google Maps est√° carregado
                if (typeof google === 'undefined' || !google.maps) {
                    console.error('Google Maps n√£o est√° carregado');
                    showNotification('Erro ao carregar Google Maps', 'error');
                    return;
                }

                // Verificar se o elemento do mapa existe
                const mapElement = document.getElementById('map');
                if (!mapElement) {
                    console.error('Elemento do mapa n√£o encontrado');
                    showNotification('Elemento do mapa n√£o encontrado', 'error');
                    return;
                }

                const mapConfig = getMapConfig();
                console.log('Configura√ß√£o do mapa:', mapConfig);
                
                map = new google.maps.Map(mapElement, mapConfig);
                console.log('Mapa criado com sucesso');

                // Esconder indicador de carregamento
                const loadingElement = document.getElementById('map-loading');
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }

                // Criar marcador inicial usando Marker tradicional
                marker = new google.maps.Marker({
                    position: mapConfig.center,
                    map: map,
                    title: 'Localiza√ß√£o do Motorista',
                    icon: {
                        url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
                        scaledSize: new google.maps.Size(32, 32)
                    }
                });
                console.log('Marcador criado');

                // Criar polyline para rastreamento
                polyline = new google.maps.Polyline({
                    path: [],
                    geodesic: true,
                    strokeColor: '#FF0000',
                    strokeOpacity: 1.0,
                    strokeWeight: 3
                });
                polyline.setMap(map);
                console.log('Polyline criada');

                // Carregar dados de rastreamento ap√≥s inicializar o mapa
                console.log('Mapa inicializado, carregando dados de rastreamento...');
                loadTrackingData();
                
                // Aguardar um pouco antes de iniciar o rastreamento autom√°tico
                setTimeout(() => {
                    const userType = getUserType();
                    console.log('Verificando tipo de usu√°rio para rastreamento:', userType);
                    
                    if (userType === 'motorista') {
                        console.log('Iniciando rastreamento autom√°tico para motorista...');
                        iniciarRastreamentoAutomatico();
                    } else {
                        console.log('Usu√°rio n√£o √© motorista, rastreamento autom√°tico n√£o ser√° iniciado');
                    }
                }, 2000);
            } catch (error) {
                console.error('Erro ao inicializar mapa:', error);
                showNotification('Erro ao inicializar mapa: ' + error.message, 'error');
            }
        }

        // Carregar dados de rastreamento
        async function loadTrackingData() {
            try {
                // Primeiro verificar o status do frete
                const freteResponse = await api.getFreteById(freteId);
                if (!freteResponse.success) {
                    throw new Error('Frete n√£o encontrado');
                }
                
                const frete = freteResponse.data;
                const userType = getUserType();
                
                // Se o frete foi entregue e o usu√°rio n√£o √© admin, mostrar mensagem
                if (frete.status === 'entregue' && userType !== 'admin') {
                    showFreteEntregueMessage();
                    return;
                }
                
                const response = await api.getLocalizacoesTempoReal(freteId);
                if (response.success && response.data.length > 0) {
                    const localizacoes = response.data;
                    updateMapWithLocations(localizacoes);
                    updateLocationInfo(localizacoes[localizacoes.length - 1]);
                    loadMovementHistory(localizacoes);
                } else {
                    showNotification('Nenhuma localiza√ß√£o encontrada para este frete', 'info');
                }
            } catch (error) {
                console.error('Erro ao carregar dados de rastreamento:', error);
                
                // Verificar se √© erro de acesso negado para frete entregue
                if (error.message && error.message.includes('fretes entregues')) {
                    showFreteEntregueMessage();
                } else {
                    showNotification('Erro ao carregar dados de rastreamento', 'error');
                }
            }
        }

        // Atualizar mapa com localiza√ß√µes
        function updateMapWithLocations(localizacoes) {
            if (localizacoes.length === 0) {
                console.log('Nenhuma localiza√ß√£o para atualizar');
                return;
            }

            console.log('Atualizando mapa com', localizacoes.length, 'localiza√ß√µes');

            // Verificar se o mapa est√° inicializado
            if (!map) {
                console.error('Mapa n√£o est√° inicializado - pulando atualiza√ß√£o');
                return;
            }

            // Atualizar posi√ß√£o do marcador
            const ultimaLocalizacao = localizacoes[localizacoes.length - 1];
            const position = {
                lat: parseFloat(ultimaLocalizacao.latitude),
                lng: parseFloat(ultimaLocalizacao.longitude)
            };

            console.log('Nova posi√ß√£o:', position);

            // Atualizar currentLocation
            currentLocation = position;
            console.log('currentLocation atualizada:', currentLocation);

            // Atualizar posi√ß√£o do marcador
            if (marker) {
                marker.setPosition(position);
                console.log('Marcador atualizado para posi√ß√£o:', position);
            } else {
                console.error('Marcador n√£o est√° inicializado');
                // Recriar marcador se necess√°rio
                marker = new google.maps.Marker({
                    position: position,
                    map: map,
                    title: 'Localiza√ß√£o do Motorista',
                    icon: {
                        url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
                        scaledSize: new google.maps.Size(32, 32)
                    }
                });
                console.log('Marcador recriado');
            }

            // Centralizar mapa na nova posi√ß√£o
            map.setCenter(position);
            map.setZoom(15); // Zoom fixo para melhor visualiza√ß√£o
            console.log('Mapa centralizado em:', position);

            // Atualizar rota
            const path = localizacoes.map(loc => ({
                lat: parseFloat(loc.latitude),
                lng: parseFloat(loc.longitude)
            }));

            if (polyline) {
                polyline.setPath(path);
                console.log('Rota atualizada com', path.length, 'pontos');
            } else {
                console.error('Polyline n√£o est√° inicializada');
            }

            trackingPath = path;
        }

        // Atualizar informa√ß√µes de localiza√ß√£o
        function updateLocationInfo(localizacao) {
            console.log('=== ATUALIZANDO UI DE LOCALIZA√á√ÉO ===');
            console.log('Dados da localiza√ß√£o:', localizacao);
            
            if (!localizacao || !localizacao.latitude || !localizacao.longitude) {
                console.error('Dados de localiza√ß√£o inv√°lidos');
                return;
            }
            
            const lat = parseFloat(localizacao.latitude).toFixed(6);
            const lng = parseFloat(localizacao.longitude).toFixed(6);
            
            // Sempre usar timestamp atual para mostrar quando foi a √∫ltima atualiza√ß√£o
            const timestamp = new Date().toLocaleString('pt-BR');

            // Atualizar localiza√ß√£o atual
            const localizacaoElement = document.getElementById('localizacao-atual');
            if (localizacaoElement) {
                localizacaoElement.textContent = `Lat: ${lat}, Lng: ${lng}`;
                console.log('Localiza√ß√£o atual atualizada:', `Lat: ${lat}, Lng: ${lng}`);
            } else {
                console.error('Elemento localizacao-atual n√£o encontrado');
            }

            // Atualizar √∫ltima atualiza√ß√£o
            const ultimaAtualizacaoElement = document.getElementById('ultima-atualizacao');
            if (ultimaAtualizacaoElement) {
                ultimaAtualizacaoElement.textContent = `√öltima atualiza√ß√£o: ${timestamp}`;
                console.log('√öltima atualiza√ß√£o atualizada:', timestamp);
            } else {
                console.error('Elemento ultima-atualizacao n√£o encontrado');
            }

            currentLocation = {
                lat: parseFloat(localizacao.latitude),
                lng: parseFloat(localizacao.longitude)
            };

            // Atualizar pr√≥xima atualiza√ß√£o
            updateTrackingUI();
        }

        // Carregar hist√≥rico de movimenta√ß√µes
        function loadMovementHistory(localizacoes) {
            const container = document.getElementById('movimentacoes-list');
            container.innerHTML = '';

            if (localizacoes.length === 0) {
                container.innerHTML = '<p class="no-data">Nenhuma movimenta√ß√£o registrada</p>';
                return;
            }

            localizacoes.slice(0, 10).forEach((loc, index) => {
                const item = document.createElement('div');
                item.className = 'movement-item';
                
                const timestamp = new Date(loc.timestamp).toLocaleString('pt-BR');
                
                item.innerHTML = `
                    <div class="movement-time">${timestamp}</div>
                    <div class="movement-coords">${parseFloat(loc.latitude).toFixed(4)}, ${parseFloat(loc.longitude).toFixed(4)}</div>
                `;
                
                container.appendChild(item);
            });
        }

        // Atualizar localiza√ß√£o manualmente (buscar do motorista)
        async function atualizarLocalizacao() {
            const btn = document.getElementById('btn-atualizar');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Atualizando...';

            try {
                console.log('=== ATUALIZANDO LOCALIZA√á√ÉO ===');
                console.log('Frete ID:', freteId);
                console.log('Tempo:', new Date().toLocaleTimeString());
                
                // Primeiro, tentar obter localiza√ß√£o real do navegador
                const userType = getUserType();
                if (userType === 'motorista') {
                    console.log('Motorista detectado, tentando obter localiza√ß√£o real...');
                    
                    try {
                        const position = await obterLocalizacaoReal();
                        if (position) {
                            console.log('Localiza√ß√£o real obtida:', position);
                            
                            // Registrar localiza√ß√£o real no servidor
                            const localizacaoData = {
                                frete_id: freteId,
                                latitude: position.coords.latitude,
                                longitude: position.coords.longitude,
                                velocidade: position.coords.speed || 0,
                                direcao: position.coords.heading || 0,
                                precisao: position.coords.accuracy || 100,
                                timestamp: new Date().toISOString()
                            };
                            
                            await api.registrarLocalizacao(localizacaoData);
                            updateLocationInfo(localizacaoData);
                            
                            // Atualizar mapa
                            if (map) {
                                updateMapWithLocations([localizacaoData]);
                            }
                            
                            // Definir pr√≥xima atualiza√ß√£o
                            if (isTracking) {
                                const proximaAtualizacao = new Date();
                                proximaAtualizacao.setSeconds(proximaAtualizacao.getSeconds() + 30);
                                window.nextUpdateTime = proximaAtualizacao;
                                updateTrackingUI();
                            }
                            
                            showNotification('Localiza√ß√£o real atualizada!', 'success');
                            return;
                        }
                    } catch (error) {
                        console.log('Erro ao obter localiza√ß√£o real:', error);
                        console.log('Usando localiza√ß√£o do servidor...');
                    }
                }
                
                // Buscar localiza√ß√£o atual do motorista via API
                const response = await api.getLocalizacaoAtual(freteId);
                console.log('Resposta da API:', response);
                
                if (response.success && response.data) {
                    console.log('Localiza√ß√£o encontrada:', response.data);
                    updateLocationInfo(response.data);
                    
                    // Atualizar mapa apenas se estiver inicializado
                    if (map) {
                        updateMapWithLocations([response.data]);
                        console.log('Mapa atualizado com localiza√ß√£o');
                    } else {
                        console.log('Mapa n√£o inicializado, pulando atualiza√ß√£o do mapa');
                    }
                    
                    console.log('Localiza√ß√£o atualizada com sucesso');
                    
                    // Definir pr√≥xima atualiza√ß√£o
                    if (isTracking) {
                        const proximaAtualizacao = new Date();
                        proximaAtualizacao.setSeconds(proximaAtualizacao.getSeconds() + 30);
                        window.nextUpdateTime = proximaAtualizacao;
                        updateTrackingUI();
                    }
                    
                    showNotification('Localiza√ß√£o atualizada!', 'success');
                } else {
                    console.log('Nenhuma localiza√ß√£o encontrada');
                    showNotification('Nenhuma localiza√ß√£o encontrada para este frete', 'info');
                }
            } catch (error) {
                console.error('Erro ao buscar localiza√ß√£o:', error);
                showNotification('Erro ao buscar localiza√ß√£o do motorista', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-location-arrow"></i> Atualizar Localiza√ß√£o';
            }
        }

        // Obter localiza√ß√£o real do navegador
        function obterLocalizacaoReal() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocaliza√ß√£o n√£o suportada'));
                    return;
                }
                
                console.log('Solicitando localiza√ß√£o real...');
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log('‚úÖ Localiza√ß√£o real obtida:', position);
                        resolve(position);
                    },
                    (error) => {
                        console.log('‚ùå Erro ao obter localiza√ß√£o real:', error);
                        reject(error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            });
        }

        // Iniciar rastreamento autom√°tico (apenas para motoristas)
        function iniciarRastreamentoAutomatico() {
            console.log('=== INICIANDO RASTREAMENTO AUTOM√ÅTICO ===');
            const userType = getUserType();
            console.log('Tipo de usu√°rio:', userType);
            
            // S√≥ permite rastreamento autom√°tico para motoristas
            if (userType !== 'motorista') {
                console.log('Rastreamento autom√°tico dispon√≠vel apenas para motoristas');
                return;
            }

            // Sempre limpar intervalo anterior se existir
            if (trackingInterval) {
                console.log('Limpando intervalo anterior...');
                clearInterval(trackingInterval);
                trackingInterval = null;
            }

            console.log('Iniciando rastreamento autom√°tico...');
            isTracking = true;
            
            // Atualizar localiza√ß√£o imediatamente
            console.log('Atualizando localiza√ß√£o imediatamente...');
            atualizarLocalizacao();
            
            // Configurar intervalo de atualiza√ß√£o
            console.log('Configurando intervalo de atualiza√ß√£o de 30 segundos...');
            trackingInterval = setInterval(async () => {
                console.log('=== ATUALIZA√á√ÉO AUTOM√ÅTICA ===');
                console.log('Tempo atual:', new Date().toLocaleTimeString());
                console.log('isTracking:', isTracking);
                
                if (isTracking) {
                    await atualizarLocalizacao();
                } else {
                    console.log('Rastreamento parado, limpando intervalo');
                    clearInterval(trackingInterval);
                    trackingInterval = null;
                }
            }, 30000); // 30 segundos

            updateTrackingUI();
            showNotification('Rastreamento autom√°tico iniciado!', 'success');
            
            // Log para debug
            console.log('Intervalo de rastreamento configurado:', trackingInterval);
            console.log('=== RASTREAMENTO AUTOM√ÅTICO INICIADO ===');
        }

        // Parar rastreamento autom√°tico
        function pararRastreamentoAutomatico() {
            if (!isTracking) return;

            console.log('Parando rastreamento autom√°tico...');
            isTracking = false;
            
            if (trackingInterval) {
                clearInterval(trackingInterval);
                trackingInterval = null;
                console.log('Intervalo de rastreamento limpo');
            }
            
            updateTrackingUI();
            showNotification('Rastreamento autom√°tico parado!', 'info');
        }

        // Atualizar interface de rastreamento
        function updateTrackingUI() {
            console.log('=== ATUALIZANDO UI DE RASTREAMENTO ===');
            const status = document.getElementById('status-rastreamento');
            const intervalo = document.getElementById('intervalo-rastreamento');
            const proxima = document.getElementById('proxima-atualizacao');
            const userType = getUserType();

            console.log('isTracking:', isTracking, 'userType:', userType);

            if (isTracking) {
                status.textContent = 'Ativo';
                status.className = 'status-value active';
                intervalo.textContent = '30 segundos';

                // Usar tempo da pr√≥xima atualiza√ß√£o se j√° estiver definido, sen√£o calcular novo
                let proximaAtualizacao;
                if (window.nextUpdateTime) {
                    proximaAtualizacao = window.nextUpdateTime;
                } else {
                    const agora = new Date();
                    proximaAtualizacao = new Date(agora.getTime() + 30000); // +30 segundos
                    window.nextUpdateTime = proximaAtualizacao;
                }
                
                proxima.textContent = proximaAtualizacao.toLocaleTimeString('pt-BR');
                console.log('Status: Ativo, Pr√≥xima atualiza√ß√£o:', proximaAtualizacao.toLocaleTimeString('pt-BR'));
            } else {
                if (proximaUpdateInterval) {
                    clearInterval(proximaUpdateInterval);
                }
                
                // Limpar tempo da pr√≥xima atualiza√ß√£o
                window.nextUpdateTime = null;
                
                if (userType === 'motorista') {
                    status.textContent = 'Inativo';
                    status.className = 'status-value inactive';
                    intervalo.textContent = '--';
                    proxima.textContent = '--';
                    console.log('Status: Inativo (motorista)');
                } else {
                    status.textContent = 'Visualiza√ß√£o';
                    status.className = 'status-value viewing';
                    intervalo.textContent = 'Manual';
                    proxima.textContent = 'Clique em "Atualizar"';
                    console.log('Status: Visualiza√ß√£o (cliente/admin)');
                }
            }
        }

        // Iniciar atualiza√ß√µes autom√°ticas para cliente
        function iniciarAtualizacoesCliente() {
            console.log('üîÑ Iniciando atualiza√ß√µes autom√°ticas para cliente...');
            
            // Carregar dados iniciais
            loadTrackingData();
            
            // Configurar atualiza√ß√µes autom√°ticas a cada 30 segundos
            if (clienteUpdateInterval) {
                clearInterval(clienteUpdateInterval);
            }
            
            clienteUpdateInterval = setInterval(async () => {
                console.log('üîÑ Atualizando localiza√ß√£o para cliente...');
                try {
                    // Verificar se o frete ainda est√° ativo antes de atualizar
                    const freteResponse = await api.getFreteById(freteId);
                    if (freteResponse.success && freteResponse.data.status === 'entregue') {
                        console.log('Frete entregue, parando atualiza√ß√µes autom√°ticas');
                        clearInterval(clienteUpdateInterval);
                        showFreteEntregueMessage();
                        return;
                    }
                    await loadTrackingData();
                } catch (error) {
                    console.error('Erro ao atualizar localiza√ß√£o para cliente:', error);
                }
            }, 30000); // 30 segundos
            
            console.log('‚úÖ Atualiza√ß√µes autom√°ticas iniciadas para cliente');
        }

        function iniciarAtualizacoesAdmin() {
            console.log('üîÑ Iniciando atualiza√ß√µes autom√°ticas para admin...');
            
            // Carregar dados iniciais
            loadTrackingData();
            
            // Configurar atualiza√ß√µes autom√°ticas a cada 15 segundos para admin
            if (clienteUpdateInterval) {
                clearInterval(clienteUpdateInterval);
            }
            
            clienteUpdateInterval = setInterval(async () => {
                console.log('üîÑ Atualizando localiza√ß√£o para admin...');
                try {
                    // Admin pode ver fretes entregues, ent√£o n√£o precisa verificar status
                    await loadTrackingData();
                } catch (error) {
                    console.error('Erro ao atualizar localiza√ß√£o para admin:', error);
                }
            }, 15000); // 15 segundos - mais frequente para admin
            
            console.log('‚úÖ Atualiza√ß√µes autom√°ticas iniciadas para admin');
        }

        // Verificar status de rastreamento
        function checkTrackingStatus() {
            const userType = getUserType();
            const rastreamentoAtivo = localStorage.getItem('rastreamentoAtivo');
            const freteRastreamento = localStorage.getItem('freteRastreamento');

            console.log('=== VERIFICANDO STATUS DE RASTREAMENTO ===');
            console.log('userType:', userType);
            console.log('rastreamentoAtivo:', rastreamentoAtivo);
            console.log('freteRastreamento:', freteRastreamento);
            console.log('freteId:', freteId);
            console.log('isTracking atual:', isTracking);

            if (userType === 'motorista' && rastreamentoAtivo === 'true' && freteRastreamento === freteId) {
                console.log('‚úÖ Rastreamento ativo detectado para frete:', freteRastreamento);
                // Marcar como rastreando ativo
                isTracking = true;
                
                // Iniciar rastreamento autom√°tico imediatamente se for motorista
                console.log('üöÄ Iniciando rastreamento autom√°tico para motorista...');
                iniciarRastreamentoAutomatico();
            } else if (userType === 'cliente') {
                console.log('üë§ Cliente acessando rastreamento do frete:', freteId);
                // Cliente pode visualizar rastreamento se o frete estiver em tr√¢nsito
                // Iniciar atualiza√ß√µes autom√°ticas para visualizar localiza√ß√£o do motorista
                iniciarAtualizacoesCliente();
            } else if (userType === 'admin') {
                console.log('üëë Admin acessando rastreamento do frete:', freteId);
                // Admin pode visualizar qualquer frete - mostrar √∫ltima localiza√ß√£o do motorista
                iniciarAtualizacoesAdmin();
            } else {
                console.log('‚ùå Rastreamento n√£o ativo. Motivos:');
                console.log('- userType √© motorista?', userType === 'motorista');
                console.log('- rastreamentoAtivo √© true?', rastreamentoAtivo === 'true');
                console.log('- freteRastreamento === freteId?', freteRastreamento === freteId);
                // Atualizar UI para mostrar status correto
                updateTrackingUI();
            }
        }

        // Centralizar mapa
        // Limpar intervalos ao sair da p√°gina
        window.addEventListener('beforeunload', function() {
            if (trackingInterval) {
                clearInterval(trackingInterval);
            }
            if (clienteUpdateInterval) {
                clearInterval(clienteUpdateInterval);
            }
            if (proximaUpdateInterval) {
                clearInterval(proximaUpdateInterval);
            }
        });

        function centralizarMapa() {
            if (!map) {
                console.error('Mapa n√£o est√° inicializado');
                showNotification('Mapa n√£o est√° carregado', 'error');
                return;
            }
            
            if (currentLocation) {
                map.setCenter(currentLocation);
                map.setZoom(15);
                console.log('Mapa centralizado em:', currentLocation);
            } else {
                showNotification('Nenhuma localiza√ß√£o dispon√≠vel', 'warning');
            }
        }

        // Alternar tipo de mapa
        function alternarTipoMapa() {
            if (!map) {
                console.error('Mapa n√£o est√° inicializado');
                showNotification('Mapa n√£o est√° carregado', 'error');
                return;
            }
            
            const currentType = map.getMapTypeId();
            const newType = currentType === google.maps.MapTypeId.ROADMAP 
                ? google.maps.MapTypeId.SATELLITE 
                : google.maps.MapTypeId.ROADMAP;
            map.setMapTypeId(newType);
            console.log('Tipo de mapa alterado para:', newType);
        }

        // Fun√ß√£o para mostrar notifica√ß√µes
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerText = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Fun√ß√£o para mostrar mensagem de frete entregue
        function showFreteEntregueMessage() {
            const mapContainer = document.querySelector('.map-container');
            const trackingInfo = document.querySelector('.tracking-info');
            
            if (mapContainer) {
                mapContainer.innerHTML = `
                    <div class="frete-entregue-message">
                        <div class="message-content">
                            <i class="fas fa-check-circle"></i>
                            <h3>Frete Entregue</h3>
                            <p>Este frete j√° foi entregue. Apenas administradores podem visualizar a localiza√ß√£o de fretes entregues.</p>
                            <button class="btn btn-primary" onclick="window.history.back()">
                                <i class="fas fa-arrow-left"></i>
                                Voltar
                            </button>
                        </div>
                    </div>
                `;
            }
            
            if (trackingInfo) {
                trackingInfo.innerHTML = `
                    <div class="frete-entregue-info">
                        <h3><i class="fas fa-check-circle"></i> Frete Entregue</h3>
                        <p>A localiza√ß√£o deste frete n√£o est√° mais dispon√≠vel para visualiza√ß√£o.</p>
                    </div>
                `;
            }
        }
        
        // Fun√ß√£o para alternar tema
        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const isLightMode = document.body.classList.contains('light-mode');
            localStorage.setItem('theme', isLightMode ? 'light' : 'dark');
            
            // Trocar √≠cone
            const icon = document.querySelector('.theme-toggle i');
            if (isLightMode) {
                icon.className = 'fas fa-moon';
            } else {
                icon.className = 'fas fa-sun';
            }
        }
        
        // Carregar tema salvo
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
                const icon = document.querySelector('.theme-toggle i');
                if (icon) icon.className = 'fas fa-moon';
            }
        });

        // Fun√ß√£o para testar rastreamento manualmente
        function testarRastreamento() {
            console.log('=== TESTE MANUAL DE RASTREAMENTO ===');
            console.log('isTracking atual:', isTracking);
            console.log('trackingInterval atual:', trackingInterval);
            console.log('userType:', getUserType());
            
            // Sempre parar rastreamento atual primeiro
            if (isTracking) {
                console.log('Parando rastreamento atual...');
                pararRastreamentoAutomatico();
            }
            
            // Aguardar um pouco antes de iniciar novo
            setTimeout(() => {
                console.log('Iniciando novo rastreamento...');
                iniciarRastreamentoAutomatico();
                showNotification('Teste de rastreamento iniciado!', 'success');
            }, 100);
        }

        // Limpar rastreamento ao sair da p√°gina
        window.addEventListener('beforeunload', function() {
            if (isTracking) {
                pararRastreamentoAutomatico();
            }
        });
    </script>
</body>
</html>
