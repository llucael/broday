<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicita√ß√£o de Servi√ßo de Frete - Broday Transportes</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
                    <div class="logo">
            <span>Broday Transportes</span>
        </div>
            <nav class="nav">
                <a href="cliente-dashboard.html" title="P√°gina inicial">Dashboard</a>
                <a href="cliente-fretes.html" title="Hist√≥rico de fretes">Meus Fretes</a>
                <a href="frete.html" class="nav-link active" title="Solicitar frete">Solicitar Frete</a>
                <a href="cliente-perfil.html" title="Gerenciar perfil">Perfil</a>
            </nav>
            <div class="header-buttons">
                <button class="theme-toggle" onclick="toggleTheme()" title="Alternar tema">
                    <i class="fas fa-sun"></i>
                </button>
                <span class="user-info" id="user-info" title="Usu√°rio logado">Bem-vindo, <span id="user-name">Cliente</span></span>
                <button class="btn btn-secondary" onclick="logout()" title="Sair do sistema">
                    <i class="fas fa-sign-out-alt"></i>
                    Sair
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <h1 class="form-title">Solicita√ß√£o de Servi√ßo de Frete</h1>
            
            <form class="frete-form">
                <!-- Sender and Recipient Information -->
                <div class="form-row">
                    <div class="form-section">
                        <h3 class="section-title" title="Dados do remetente">Informa√ß√µes do Remetente</h3>
                        <div class="form-group">
                            <label for="sender-name">Nome Completo/Raz√£o Social</label>
                            <input type="text" id="sender-name" placeholder="Insira o nome completo ou raz√£o social do remetente" title="Nome do remetente" required>
                        </div>
                        <div class="form-group">
                            <label for="sender-document">CPF/CNPJ</label>
                            <input type="text" id="sender-document" placeholder="Insira o CPF ou CNPJ do remetente" title="CPF ou CNPJ apenas n√∫meros" required>
                        </div>
                        <div class="form-group">
                            <label for="sender-phone">Telefone</label>
                            <input type="tel" id="sender-phone" placeholder="Insira o telefone do remetente" title="Telefone com DDD" required>
                        </div>
                        <div class="form-group">
                            <label for="sender-email">E-mail</label>
                            <input type="email" id="sender-email" placeholder="Insira o e-mail do remetente" title="E-mail para notifica√ß√µes" required>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3 class="section-title" title="Dados do destinat√°rio">Informa√ß√µes do Destinat√°rio</h3>
                        <div class="form-group">
                            <label for="recipient-name">Nome Completo/Raz√£o Social</label>
                            <input type="text" id="recipient-name" placeholder="Insira o nome completo ou raz√£o social do destinat√°rio" title="Nome do destinat√°rio" required>
                        </div>
                        <div class="form-group">
                            <label for="recipient-document">CPF/CNPJ</label>
                            <input type="text" id="recipient-document" placeholder="Insira o CPF ou CNPJ do destinat√°rio" title="CPF ou CNPJ apenas n√∫meros" required>
                        </div>
                        <div class="form-group">
                            <label for="recipient-phone">Telefone</label>
                            <input type="tel" id="recipient-phone" placeholder="Insira o telefone do destinat√°rio" title="Telefone para contato na entrega" required>
                        </div>
                        <div class="form-group">
                            <label for="recipient-email">E-mail</label>
                            <input type="email" id="recipient-email" placeholder="Insira o e-mail do destinat√°rio" title="E-mail para notifica√ß√µes de entrega" required>
                        </div>
                    </div>
                </div>

                <!-- Cargo Details -->
                <div class="form-section">
                    <h3 class="section-title" title="Detalhes da mercadoria">Detalhes da Carga</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cargo-type">Tipo de Carga</label>
                            <input type="text" id="cargo-type" placeholder="Ex: Eletr√¥nicos, M√≥veis" title="Tipo de mercadoria" required>
                        </div>
                        <div class="form-group">
                            <label for="cargo-value">Valor Declarado (R$)</label>
                            <input type="text" id="cargo-value" inputmode="decimal" placeholder="Ex: 1.250,75" title="Valor para seguro" required>
                        </div>
                        <div class="form-group">
                            <label for="cargo-weight">Peso (Kg)</label>
                            <input type="number" id="cargo-weight" placeholder="Insira o peso em quilogramas" title="Peso em quilogramas" required>
                        </div>
                        <div class="form-group">
                            <label for="data-coleta-limite">Data Limite de Coleta <span style="color: red;">*</span></label>
                            <input type="date" id="data-coleta-limite" placeholder="Selecione a data limite de coleta" title="Data m√°xima para coleta" required>
                        </div>
                        <div class="form-group">
                            <label for="data-entrega-limite">Data Limite de Entrega <span style="color: red;">*</span></label>
                            <input type="date" id="data-entrega-limite" placeholder="Selecione a data limite de entrega" title="Data m√°xima para entrega" required>
                        </div>
                    </div>
                </div>

                <!-- Addresses -->
                <div class="form-row address-section">
                    <div class="form-section">
                        <h3 class="section-title" title="Local de coleta">Endere√ßo de Origem</h3>
                        <div class="address-hint" title="Usar endere√ßo cadastrado">
                            <i class="fas fa-info-circle"></i>
                            <span>Clique aqui para selecionar um endere√ßo salvo automaticamente</span>
                        </div>
                        <div class="form-group">
                            <label for="origin-cep">CEP</label>
                            <input type="text" id="origin-cep" placeholder="Digite o CEP de origem" title="CEP para preenchimento autom√°tico" required>
                        </div>
                        <div class="form-group">
                            <label for="origin-street">Logradouro</label>
                            <input type="text" id="origin-street" placeholder="Insira o logradouro de origem" title="Rua ou avenida" required>
                        </div>
                        <div class="form-group">
                            <label for="origin-number">N√∫mero</label>
                            <input type="text" id="origin-number" placeholder="Insira o n√∫mero" title="N√∫mero do im√≥vel" required>
                        </div>
                        <div class="form-group">
                            <label for="origin-complement">Complemento</label>
                            <input type="text" id="origin-complement" placeholder="Ex: Apto 101, Sala 205" title="Complemento opcional: apartamento, sala, andar, bloco, etc.">
                        </div>
                        <div class="form-group">
                            <label for="origin-city">Cidade</label>
                            <input type="text" id="origin-city" placeholder="Insira a cidade de origem" title="Cidade de origem" required>
                        </div>
                        <div class="form-group">
                            <label for="origin-state">Estado</label>
                            <select id="origin-state" title="Estado de origem" required>
                                <option value="">Selecione o estado</option>
                                <option value="AC">Acre (AC)</option>
                                <option value="AL">Alagoas (AL)</option>
                                <option value="AP">Amap√° (AP)</option>
                                <option value="AM">Amazonas (AM)</option>
                                <option value="BA">Bahia (BA)</option>
                                <option value="CE">Cear√° (CE)</option>
                                <option value="DF">Distrito Federal (DF)</option>
                                <option value="ES">Esp√≠rito Santo (ES)</option>
                                <option value="GO">Goi√°s (GO)</option>
                                <option value="MA">Maranh√£o (MA)</option>
                                <option value="MT">Mato Grosso (MT)</option>
                                <option value="MS">Mato Grosso do Sul (MS)</option>
                                <option value="MG">Minas Gerais (MG)</option>
                                <option value="PA">Par√° (PA)</option>
                                <option value="PB">Para√≠ba (PB)</option>
                                <option value="PR">Paran√° (PR)</option>
                                <option value="PE">Pernambuco (PE)</option>
                                <option value="PI">Piau√≠ (PI)</option>
                                <option value="RJ">Rio de Janeiro (RJ)</option>
                                <option value="RN">Rio Grande do Norte (RN)</option>
                                <option value="RS">Rio Grande do Sul (RS)</option>
                                <option value="RO">Rond√¥nia (RO)</option>
                                <option value="RR">Roraima (RR)</option>
                                <option value="SC">Santa Catarina (SC)</option>
                                <option value="SP">S√£o Paulo (SP)</option>
                                <option value="SE">Sergipe (SE)</option>
                                <option value="TO">Tocantins (TO)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3 class="section-title" title="Local de entrega">Endere√ßo de Destino</h3>
                        <div class="address-hint" title="Usar endere√ßo cadastrado">
                            <i class="fas fa-info-circle"></i>
                            <span>Clique aqui para selecionar um endere√ßo salvo automaticamente</span>
                        </div>
                        <div class="form-group">
                            <label for="destination-cep">CEP</label>
                            <input type="text" id="destination-cep" placeholder="Digite o CEP de destino" title="CEP para preenchimento autom√°tico" required>
                        </div>
                        <div class="form-group">
                            <label for="destination-street">Logradouro</label>
                            <input type="text" id="destination-street" placeholder="Insira o logradouro de destino" title="Rua ou avenida de entrega" required>
                        </div>
                        <div class="form-group">
                            <label for="destination-number">N√∫mero</label>
                            <input type="text" id="destination-number" placeholder="Insira o n√∫mero" title="N√∫mero do im√≥vel de entrega" required>
                        </div>
                        <div class="form-group">
                            <label for="destination-complement">Complemento</label>
                            <input type="text" id="destination-complement" placeholder="Ex: Sala 200" title="Complemento opcional">
                        </div>
                        <div class="form-group">
                            <label for="destination-city">Cidade</label>
                            <input type="text" id="destination-city" placeholder="Insira a cidade de destino" title="Cidade de entrega" required>
                        </div>
                        <div class="form-group">
                            <label for="destination-state">Estado</label>
                            <select id="destination-state" title="Estado de entrega" required>
                                <option value="">Selecione o estado</option>
                                <option value="AC">Acre (AC)</option>
                                <option value="AL">Alagoas (AL)</option>
                                <option value="AP">Amap√° (AP)</option>
                                <option value="AM">Amazonas (AM)</option>
                                <option value="BA">Bahia (BA)</option>
                                <option value="CE">Cear√° (CE)</option>
                                <option value="DF">Distrito Federal (DF)</option>
                                <option value="ES">Esp√≠rito Santo (ES)</option>
                                <option value="GO">Goi√°s (GO)</option>
                                <option value="MA">Maranh√£o (MA)</option>
                                <option value="MT">Mato Grosso (MT)</option>
                                <option value="MS">Mato Grosso do Sul (MS)</option>
                                <option value="MG">Minas Gerais (MG)</option>
                                <option value="PA">Par√° (PA)</option>
                                <option value="PB">Para√≠ba (PB)</option>
                                <option value="PR">Paran√° (PR)</option>
                                <option value="PE">Pernambuco (PE)</option>
                                <option value="PI">Piau√≠ (PI)</option>
                                <option value="RJ">Rio de Janeiro (RJ)</option>
                                <option value="RN">Rio Grande do Norte (RN)</option>
                                <option value="RS">Rio Grande do Sul (RS)</option>
                                <option value="RO">Rond√¥nia (RO)</option>
                                <option value="RR">Roraima (RR)</option>
                                <option value="SC">Santa Catarina (SC)</option>
                                <option value="SP">S√£o Paulo (SP)</option>
                                <option value="SE">Sergipe (SE)</option>
                                <option value="TO">Tocantins (TO)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="form-submit">
                    <button type="submit" class="btn btn-primary" title="Enviar solicita√ß√£o de frete">Enviar Solicita√ß√£o</button>
                </div>
            </form>
        </div>
    </main>

    <!-- Modal de Sele√ß√£o de Endere√ßo -->
    <div id="endereco-modal" class="modal" title="Modal para sele√ß√£o de endere√ßos cadastrados">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="endereco-modal-title">Selecionar Endere√ßo</h3>
                <button class="close-btn" onclick="closeEnderecoSelectionModal()" title="Fechar modal">&times;</button>
            </div>
            
            <div class="modal-body">
                <!-- Lista √∫nica de endere√ßos -->
                <div id="enderecos-container" class="enderecos-container">
                    <div id="enderecos-list" class="enderecos-grid">
                        <!-- Lista de endere√ßos ser√° carregada aqui -->
                    </div>
                </div>
                
                <!-- Mensagem quando n√£o h√° endere√ßos -->
                <div id="no-enderecos-message" class="no-data" style="display: none;">
                    <i class="fas fa-map-marker-alt"></i>
                    <p>Nenhum endere√ßo encontrado.</p>
                    <p>Cadastre endere√ßos em seu perfil para facilitar o preenchimento.</p>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeEnderecoSelectionModal()" title="Cancelar sele√ß√£o">
                    <i class="fas fa-times"></i>
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Broday Transportes</h3>
                    <p>Conectando embarcadores e transportadores de forma inteligente e eficiente.</p>
                </div>
                
                <div class="footer-section">
                    <h4>Navega√ß√£o</h4>
                    <div class="footer-nav">
                        <a href="cliente-dashboard.html" title="Dashboard principal">Dashboard</a>
                        <a href="cliente-fretes.html" title="Hist√≥rico de fretes">Meus Fretes</a>
                        <a href="frete.html" title="Solicitar novo frete">Solicitar Frete</a>
                        <a href="cliente-perfil.html" title="Editar perfil">Perfil</a>
                        <a href="index.html" title="P√°gina inicial">In√≠cio</a>
                        <a href="#" title="Pol√≠tica de privacidade">Pol√≠tica de Privacidade</a>
                        <a href="#" title="Termos de uso">Termos de Uso</a>
                    </div>
                </div>
                
                <div class="footer-section">
                    <h4>Contato</h4>
                    <div class="contact-info">
                        <p><i class="fas fa-map-marker-alt"></i> Rua Cambara, 268 - Nova Russia</p>
                        <p>Ponta Grossa - PR, 84.053-060</p>
                        <p><i class="fas fa-phone"></i> (42) 99985-2606</p>
                        <p><i class="fas fa-envelope"></i> brodaytransportes@gmail.com</p>
                    </div>
                </div>
                
            </div>
            
            <div class="footer-legal">
                <div class="legal-info">
                    <p><strong>CNPJ:</strong> 58.893.054/0001-03</p>
                    <p><strong>Endere√ßo:</strong> Rua Cambara, 268 - Nova Russia, Ponta Grossa - PR, 84.053-060</p>
                </div>
                <div class="copyright">
                    <p>¬© 2025 Broday Transportes. Todos os direitos reservados.</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="js/api.js"></script>
    <script src="js/validation.js"></script>
    <script src="script.js"></script>
    <script>
        // Vari√°veis globais para controle do modal
        let currentEnderecoTarget = '';
        let enderecosDisponiveis = [];

        // Verificar se o usu√°rio est√° logado
        if (!isLoggedIn()) {
            window.location.href = 'login.html';
        }

        // Verificar tipo de usu√°rio
        if (getUserType() !== 'cliente') {
            window.location.href = 'login.html';
        }

        // Carregar dados do usu√°rio
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOM carregado, iniciando configura√ß√£o...');
            // Aguardar um pouco para garantir que todos os elementos est√£o carregados
            setTimeout(() => {
                loadUserData();
                setupEnderecoClickHandlers();
                setupCEPListeners();
            }, 200);
        });

        // Fun√ß√£o para consultar CEP via ViaCEP
        async function consultarCEP(cep, tipo) {
            try {
                // Limpar CEP (remover caracteres n√£o num√©ricos)
                const cepLimpo = cep.replace(/\D/g, '');
                
                // Validar CEP (deve ter 8 d√≠gitos)
                if (cepLimpo.length !== 8) {
                    return;
                }

                console.log(`üîç Consultando CEP ${cepLimpo} para ${tipo}...`);
                
                const prefix = tipo === 'origin' ? 'origin' : 'destination';
                const cepField = document.getElementById(`${prefix}-cep`);
                
                if (cepField) {
                    cepField.classList.remove('cep-success', 'cep-error');
                }
                
                // Fazer consulta √† API ViaCEP
                const response = await fetch(`https://viacep.com.br/ws/${cepLimpo}/json/`);
                const data = await response.json();
                
                console.log('üìç Resposta do ViaCEP:', data);
                
                if (data.erro) {
                    showNotification('CEP n√£o encontrado', 'error');
                    if (cepField) {
                        cepField.classList.add('cep-error');
                    }
                    return;
                }
                
                // Preencher campos automaticamente
                preencherCamposViaCEP(data, prefix);
                showNotification('Endere√ßo preenchido automaticamente!', 'success');
                
                if (cepField) {
                    cepField.classList.add('cep-success');
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao consultar CEP:', error);
                showNotification('Erro ao consultar CEP', 'error');
                const prefix = tipo === 'origin' ? 'origin' : 'destination';
                const cepField = document.getElementById(`${prefix}-cep`);
                
                if (cepField) {
                    cepField.classList.add('cep-error');
                }
            }
        }

        // Fun√ß√£o para preencher campos com dados do ViaCEP
        function preencherCamposViaCEP(data, prefix) {
            const fieldsMapping = [
                { id: `${prefix}-street`, value: data.logradouro },
                { id: `${prefix}-city`, value: data.localidade },
                { id: `${prefix}-state`, value: data.uf }
            ];
            
            fieldsMapping.forEach(field => {
                const element = document.getElementById(field.id);
                if (element && field.value) {
                    element.value = field.value;
                    console.log(`‚úÖ ${field.id}: ${field.value}`);
                }
            });
        }

        // Fun√ß√£o para configurar listeners de CEP
        function setupCEPListeners() {
            // CEP de origem
            const originCEP = document.getElementById('origin-cep');
            if (originCEP) {
                // Adicionar m√°scara de CEP
                originCEP.addEventListener('input', function() {
                    let value = this.value.replace(/\D/g, '');
                    if (value.length > 8) value = value.slice(0, 8);
                    if (value.length > 5) {
                        value = value.replace(/(\d{5})(\d{1,3})/, '$1-$2');
                    }
                    this.value = value;
                });
                
                originCEP.addEventListener('blur', function() {
                    const cep = this.value;
                    if (cep && cep.replace(/\D/g, '').length === 8) {
                        consultarCEP(cep, 'origin');
                    }
                });
                
                // Tamb√©m consultar quando o usu√°rio terminar de digitar
                let timeoutOrigin;
                originCEP.addEventListener('keyup', function() {
                    clearTimeout(timeoutOrigin);
                    const cep = this.value;
                    if (cep && cep.replace(/\D/g, '').length === 8) {
                        timeoutOrigin = setTimeout(() => {
                            consultarCEP(cep, 'origin');
                        }, 1000);
                    }
                });
            }

            // CEP de destino
            const destinationCEP = document.getElementById('destination-cep');
            if (destinationCEP) {
                // Adicionar m√°scara de CEP
                destinationCEP.addEventListener('input', function() {
                    let value = this.value.replace(/\D/g, '');
                    if (value.length > 8) value = value.slice(0, 8);
                    if (value.length > 5) {
                        value = value.replace(/(\d{5})(\d{1,3})/, '$1-$2');
                    }
                    this.value = value;
                });
                
                destinationCEP.addEventListener('blur', function() {
                    const cep = this.value;
                    if (cep && cep.replace(/\D/g, '').length === 8) {
                        consultarCEP(cep, 'destination');
                    }
                });
                
                // Tamb√©m consultar quando o usu√°rio terminar de digitar
                let timeoutDestination;
                destinationCEP.addEventListener('keyup', function() {
                    clearTimeout(timeoutDestination);
                    const cep = this.value;
                    if (cep && cep.replace(/\D/g, '').length === 8) {
                        timeoutDestination = setTimeout(() => {
                            consultarCEP(cep, 'destination');
                        }, 1000);
                    }
                });
            }
        }

        // Tamb√©m tentar preencher quando a p√°gina estiver completamente carregada
        window.addEventListener('load', function() {
            console.log('üåê P√°gina completamente carregada');
            setTimeout(() => {
                loadUserData();
            }, 100);
        });

        async function loadUserData() {
            try {
                console.log('üîÑ Iniciando carregamento dos dados do usu√°rio...');
                
                // Verificar se os campos existem
                const campos = [
                    'sender-name', 'sender-email', 'sender-document', 'sender-phone'
                ];
                
                let camposEncontrados = 0;
                campos.forEach(id => {
                    const elemento = document.getElementById(id);
                    if (elemento) {
                        camposEncontrados++;
                        console.log(`‚úÖ Campo ${id} encontrado`);
                    } else {
                        console.log(`‚ùå Campo ${id} N√ÉO encontrado`);
                    }
                });
                
                console.log(`üìä ${camposEncontrados}/${campos.length} campos encontrados`);
                
                // Primeiro tentar dados do localStorage
                const localUser = getCurrentUser();
                console.log('üì± Dados do usu√°rio local:', localUser);
                
                let user = localUser;
                
                // Tentar buscar dados do servidor
                try {
                    console.log('üåê Fazendo chamada para getProfile()...');
                    const response = await api.getProfile();
                    console.log('üåê Resposta do perfil da API:', response);
                    console.log('üìã Estrutura da resposta:', {
                        success: response?.success,
                        user: response?.user,
                        data: response?.data,
                        keys: Object.keys(response || {})
                    });
                    
                    if (response && response.success) {
                        // Verificar se os dados est√£o em 'user' ou 'data'
                        const userData = response.user || response.data;
                        if (userData) {
                            user = userData;
                            console.log('‚úÖ Usando dados do servidor:', user);
                            console.log('üìã Dados detalhados do servidor:', {
                                nome: user.nome,
                                email: user.email,
                                cpf: user.cpf,
                                cnpj: user.cnpj,
                                telefone: user.telefone,
                                documento: user.documento,
                                allKeys: Object.keys(user)
                            });
                        } else {
                            console.log('‚ö†Ô∏è Resposta da API n√£o cont√©m dados do usu√°rio');
                        }
                    } else {
                        console.log('‚ö†Ô∏è Resposta da API n√£o foi bem-sucedida');
                    }
                } catch (apiError) {
                    console.log('‚ö†Ô∏è Erro na API, usando dados locais:', apiError.message);
                }
                
                if (user) {
                    // Atualizar nome na interface
                    const userNameElement = document.getElementById('user-name');
                    if (userNameElement) {
                        userNameElement.textContent = user.nome || user.email;
                        console.log('üë§ Nome atualizado na interface:', user.nome || user.email);
                    }
                    
                    // Preencher dados do remetente
                    preencherDadosRemetente(user);
                } else {
                    console.log('‚ùå Nenhum usu√°rio logado encontrado');
                }
            } catch (error) {
                console.error('‚ùå Erro geral ao carregar dados do usu√°rio:', error);
            }
        }

        function preencherDadosRemetente(user) {
            console.log('üìù Preenchendo dados do remetente com:', user);
            console.log('üìã Dados dispon√≠veis do usu√°rio:', {
                nome: user.nome,
                email: user.email,
                cpf: user.cpf,
                cnpj: user.cnpj,
                telefone: user.telefone,
                documento: user.documento
            });
            
            // Tentar preencher v√°rias vezes se necess√°rio
            let tentativas = 0;
            const maxTentativas = 5;
            
            const tentarPreencher = () => {
                tentativas++;
                console.log(`üîÑ Tentativa ${tentativas} de preenchimento...`);
                
                let preenchidos = 0;
                
                // Email
                if (user.email) {
                    const campo = document.getElementById('sender-email');
                    if (campo) {
                        campo.value = user.email;
                        preenchidos++;
                        console.log('‚úÖ Email preenchido:', user.email);
                    } else {
                        console.log('‚ùå Campo sender-email n√£o encontrado');
                    }
                }
                
                // Nome
                if (user.nome) {
                    const campo = document.getElementById('sender-name');
                    if (campo) {
                        campo.value = user.nome;
                        preenchidos++;
                        console.log('‚úÖ Nome preenchido:', user.nome);
                    } else {
                        console.log('‚ùå Campo sender-name n√£o encontrado');
                    }
                }
                
                // CPF/CNPJ - tentar diferentes campos
                const documento = user.cpf || user.cnpj || user.documento;
                if (documento) {
                    const campo = document.getElementById('sender-document');
                    if (campo) {
                        campo.value = documento;
                        preenchidos++;
                        console.log('‚úÖ Documento preenchido:', documento);
                    } else {
                        console.log('‚ùå Campo sender-document n√£o encontrado');
                    }
                } else {
                    console.log('‚ö†Ô∏è Nenhum documento encontrado (cpf/cnpj/documento)');
                }
                
                // Telefone
                if (user.telefone) {
                    const campo = document.getElementById('sender-phone');
                    if (campo) {
                        campo.value = user.telefone;
                        preenchidos++;
                        console.log('‚úÖ Telefone preenchido:', user.telefone);
                    } else {
                        console.log('‚ùå Campo sender-phone n√£o encontrado');
                    }
                } else {
                    console.log('‚ö†Ô∏è Telefone n√£o encontrado nos dados do usu√°rio');
                }
                
                console.log(`üìä ${preenchidos} campos preenchidos na tentativa ${tentativas}`);
                
                // Se n√£o conseguiu preencher nada e ainda tem tentativas, tentar novamente
                if (preenchidos === 0 && tentativas < maxTentativas) {
                    console.log(`‚è≥ Tentando novamente em 200ms...`);
                    setTimeout(tentarPreencher, 200);
                } else {
                    console.log(`‚úÖ Preenchimento finalizado! Total: ${preenchidos} campos`);
                }
            };
            
            tentarPreencher();
        }

        // Configurar event listeners para as se√ß√µes de endere√ßo
        function setupEnderecoClickHandlers() {
            // Apenas clique na se√ß√£o inteira, n√£o nos inputs individuais
            const originSection = document.querySelector('.address-section .form-section:first-child');
            if (originSection) {
                originSection.classList.add('form-section-clickable');
                originSection.addEventListener('click', function(e) {
                    // N√£o abrir modal se clicou em um input ou select
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
                        return;
                    }
                    currentEnderecoTarget = 'origin';
                    openEnderecoSelectionModal('Usar Endere√ßo de Origem');
                });
            }

            const destinationSection = document.querySelector('.address-section .form-section:last-child');
            if (destinationSection) {
                destinationSection.classList.add('form-section-clickable');
                destinationSection.addEventListener('click', function(e) {
                    // N√£o abrir modal se clicou em um input ou select
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
                        return;
                    }
                    currentEnderecoTarget = 'destination';
                    openEnderecoSelectionModal('Usar Endere√ßo de Destino');
                });
            }
        }

        // Abrir modal de sele√ß√£o de endere√ßos
        async function openEnderecoSelectionModal(title) {
            try {
                console.log('üîÑ Abrindo modal de endere√ßos...');
                
                // Carregar endere√ßos do usu√°rio
                const response = await api.getEnderecos();
                console.log('üì¶ Resposta da API de endere√ßos:', response);
                
                if (response.success && response.data && response.data.length > 0) {
                    enderecosDisponiveis = response.data;
                    console.log('üè† Endere√ßos dispon√≠veis:', enderecosDisponiveis);
                    
                    // Definir t√≠tulo baseado no tipo
                    let modalTitle = 'Selecionar Endere√ßo';
                    if (currentEnderecoTarget === 'origin') {
                        modalTitle = 'Selecionar Endere√ßo de Origem';
                    } else if (currentEnderecoTarget === 'destination') {
                        modalTitle = 'Selecionar Endere√ßo de Destinat√°rio';
                    }
                    
                    document.getElementById('endereco-modal-title').textContent = modalTitle;
                    
                    // Mostrar lista de endere√ßos
                    populateEnderecosList();
                    
                    // Mostrar modal
                    document.getElementById('endereco-modal').style.display = 'flex';
                    document.getElementById('enderecos-container').style.display = 'block';
                    document.getElementById('no-enderecos-message').style.display = 'none';
                } else {
                    console.log('‚ö†Ô∏è Nenhum endere√ßo encontrado ou resposta inv√°lida');
                    
                    // Mostrar modal com mensagem de sem endere√ßos
                    document.getElementById('endereco-modal-title').textContent = 'Nenhum Endere√ßo Cadastrado';
                    document.getElementById('endereco-modal').style.display = 'flex';
                    document.getElementById('enderecos-container').style.display = 'none';
                    document.getElementById('no-enderecos-message').style.display = 'block';
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar endere√ßos:', error);
                showNotification('Erro ao carregar endere√ßos cadastrados', 'error');
            }
        }

        // Fechar modal de sele√ß√£o de endere√ßos
        function closeEnderecoSelectionModal() {
            document.getElementById('endereco-modal').style.display = 'none';
            currentEnderecoTarget = '';
        }

        // Popular lista de endere√ßos
        function populateEnderecosList() {
            const container = document.getElementById('enderecos-list');
            container.innerHTML = '';

            enderecosDisponiveis.forEach(endereco => {
                const card = createEnderecoCard(endereco);
                container.appendChild(card);
            });
        }

        // Criar card de endere√ßo
        function createEnderecoCard(endereco) {
            console.log('üì¶ Criando card para endere√ßo:', endereco);
            
            const card = document.createElement('div');
            card.className = 'endereco-card';
            card.onclick = () => selectEndereco(endereco);
            
            // Tratar tipo do endere√ßo com fallback seguro
            let tipoLabel = 'Endere√ßo';
            if (endereco.tipo) {
                switch(endereco.tipo.toLowerCase()) {
                    case 'residencial':
                        tipoLabel = 'Casa';
                        break;
                    case 'comercial':
                        tipoLabel = 'Empresa';
                        break;
                    default:
                        tipoLabel = endereco.tipo.charAt(0).toUpperCase() + endereco.tipo.slice(1);
                        break;
                }
            }
            
            // Garantir que todos os campos tenham valores seguros
            const enderecoSeguro = {
                apelido: endereco.apelido || endereco.nome || 'Endere√ßo',
                logradouro: endereco.logradouro || endereco.rua || 'N√£o informado',
                numero: endereco.numero || 'S/N',
                complemento: endereco.complemento || '',
                bairro: endereco.bairro || 'N√£o informado',
                cidade: endereco.cidade || 'N√£o informado',
                estado: endereco.estado || endereco.uf || 'N√£o informado',
                cep: endereco.cep || 'N√£o informado'
            };
            
            // Criar endere√ßo formatado
            let enderecoCompleto = `${enderecoSeguro.logradouro}, ${enderecoSeguro.numero}`;
            if (enderecoSeguro.complemento) {
                enderecoCompleto += `, ${enderecoSeguro.complemento}`;
            }
            
            card.innerHTML = `
                <div class="endereco-card-header">
                    <h4 class="endereco-card-title">${enderecoSeguro.apelido}</h4>
                    <span class="endereco-card-type">${tipoLabel}</span>
                </div>
                <div class="endereco-card-details">
                    <p><strong>${enderecoCompleto}</strong></p>
                    <p>${enderecoSeguro.bairro}</p>
                    <p>${enderecoSeguro.cidade} - ${enderecoSeguro.estado}</p>
                    <p><strong>CEP:</strong> ${enderecoSeguro.cep}</p>
                </div>
            `;
            
            return card;
        }

        // Selecionar endere√ßo
        function selectEndereco(endereco) {
            console.log('üìç Endere√ßo selecionado:', endereco);
            console.log('üéØ Target atual:', currentEnderecoTarget);
            
            // Marcar visualmente o card selecionado
            document.querySelectorAll('.endereco-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Encontrar e marcar o card clicado
            const clickedCard = event.currentTarget;
            clickedCard.classList.add('selected');
            
            // Aguardar um pouco para mostrar o feedback visual
            setTimeout(() => {
                if (currentEnderecoTarget === 'origin') {
                    preencherEndereco(endereco, 'sender'); // Manter 'sender' na fun√ß√£o para mapear para 'origin'
                    showNotification('Endere√ßo de origem preenchido com sucesso!', 'success');
                } else if (currentEnderecoTarget === 'destination') {
                    preencherEndereco(endereco, 'destination');
                    showNotification('Endere√ßo de destinat√°rio preenchido com sucesso!', 'success');
                }
                
                closeEnderecoSelectionModal();
            }, 300);
        }

        // Fun√ß√£o para preencher endere√ßo (nova vers√£o)
        function preencherEndereco(endereco, tipo) {
            console.log(`üìù Preenchendo endere√ßo do ${tipo}:`, endereco);
            
            // Corrigir o mapeamento: sender = origin, destination = destination
            const prefix = tipo === 'sender' ? 'origin' : 'destination';
            
            // Mapeamento de campos com fallbacks
            const fieldsMapping = [
                { 
                    id: `${prefix}-cep`, 
                    value: endereco.cep 
                },
                { 
                    id: `${prefix}-street`, 
                    value: endereco.logradouro || endereco.rua 
                },
                { 
                    id: `${prefix}-number`, 
                    value: endereco.numero 
                },
                { 
                    id: `${prefix}-complement`, 
                    value: endereco.complemento 
                },
                { 
                    id: `${prefix}-city`, 
                    value: endereco.cidade 
                },
                { 
                    id: `${prefix}-state`, 
                    value: endereco.estado || endereco.uf 
                }
            ];
            
            let preenchidos = 0;
            
            fieldsMapping.forEach(field => {
                const element = document.getElementById(field.id);
                if (element) {
                    // Sempre limpar o campo primeiro
                    element.value = '';
                    
                    // Preencher se houver valor
                    if (field.value) {
                        element.value = field.value;
                        preenchidos++;
                        console.log(`‚úÖ ${field.id}: ${field.value}`);
                    } else {
                        console.log(`‚ö†Ô∏è ${field.id}: valor vazio ou undefined`);
                    }
                } else {
                    console.log(`‚ùå Elemento ${field.id} n√£o encontrado`);
                }
            });
            
            console.log(`‚úÖ Total de ${preenchidos} campos preenchidos para ${tipo}`);
        }

        // Fechar modal ao clicar fora dele
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('endereco-modal');
            if (event.target === modal) {
                closeEnderecoSelectionModal();
            }
        });
        
        // Fun√ß√£o para alternar tema
        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const isLightMode = document.body.classList.contains('light-mode');
            localStorage.setItem('theme', isLightMode ? 'light' : 'dark');
            
            // Trocar √≠cone do toggle
            const toggleIcon = document.querySelector('.theme-toggle i');
            if (toggleIcon) {
                if (isLightMode) {
                    toggleIcon.className = 'fas fa-moon';
                    toggleIcon.parentElement.title = 'Alternar para modo escuro';
                } else {
                    toggleIcon.className = 'fas fa-sun';
                    toggleIcon.parentElement.title = 'Alternar para modo claro';
                }
            }
        }
        
        // Carregar tema salvo
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme');
            const toggleIcon = document.querySelector('.theme-toggle i');
            
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
                if (toggleIcon) {
                    toggleIcon.className = 'fas fa-moon';
                    toggleIcon.parentElement.title = 'Alternar para modo escuro';
                }
            } else {
                if (toggleIcon) {
                    toggleIcon.className = 'fas fa-sun';
                    toggleIcon.parentElement.title = 'Alternar para modo claro';
                }
            }
            
            // Configurar cliques nos hints de endere√ßo
            const originHint = document.querySelector('.form-section:first-child .address-hint');
            if (originHint) {
                originHint.addEventListener('click', function() {
                    currentEnderecoTarget = 'origin';
                    openEnderecoSelectionModal('Usar Endere√ßo de Origem');
                });
            }
            
            const destinationHint = document.querySelector('.form-section:last-child .address-hint');
            if (destinationHint) {
                destinationHint.addEventListener('click', function() {
                    currentEnderecoTarget = 'destination';
                    openEnderecoSelectionModal('Usar Endere√ßo de Destino');
                });
            }
        });
    </script>
</body>
</html>
